@echo off
REM VulnGuard Desktop Application
REM VulnGuard Security Platform v2.0

REM Check if Python is installed
python --version >nul 2>&1
if errorlevel 1 (
    echo.
    echo ERROR: Python is required but not installed.
    echo Please install Python 3.8+ from https://python.org
    echo.
    pause
    exit /b 1
)

REM Check and install dependencies
python -c "import requests" >nul 2>&1
if errorlevel 1 (
    echo Installing required dependencies...
    python -m pip install --quiet requests psutil pymongo fastapi uvicorn motor python-dotenv pydantic python-multipart
)

REM Get the directory where this script is located
set SCRIPT_DIR=%~dp0

REM Create temporary Python script
set TEMP_SCRIPT=%TEMP%\vulnguard_desktop.py

REM Write the Python code to temp file (base64 encoded to handle special characters)
echo IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwoiIiIKVnVsbkd1YXJkIERlc2t0b3AgQXBwbGljYXRpb24KQ3Jvc3MtcGxhdGZvcm0gR1VJIGFwcGxpY2F0aW9uIGZvciB2dWxuZXJhYmlsaXR5IG1hbmFnZW1lbnQKQnVpbHQgd2l0aCB0a2ludGVyIGZvciBtYXhpbXVtIGNvbXBhdGliaWxpdHkKIiIiCgppbXBvcnQgdGtpbnRlciBhcyB0awpmcm9tIHRraW50ZXIgaW1wb3J0IHR0aywgbWVzc2FnZWJveCwgZmlsZWRpYWxvZywgc2Nyb2xsZWR0ZXh0CmltcG9ydCByZXF1ZXN0cwppbXBvcnQganNvbgppbXBvcnQgdGhyZWFkaW5nCmltcG9ydCBxdWV1ZQppbXBvcnQgb3MKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKZnJvbSBwYXRobGliIGltcG9ydCBQYXRoCmltcG9ydCBsb2dnaW5nCgojIENvbmZpZ3VyZSBsb2dnaW5nCmxvZ2dpbmcuYmFzaWNDb25maWcobGV2ZWw9bG9nZ2luZy5JTkZPKQpsb2dnZXIgPSBsb2dnaW5nLmdldExvZ2dlcihfX25hbWVfXykKCmNsYXNzIFZ1bG5HdWFyZERlc2t0b3A6CiAgICBkZWYgX19pbml0X18oc2VsZiwgcm9vdCk6CiAgICAgICAgc2VsZi5yb290ID0gcm9vdAogICAgICAgIHNlbGYucm9vdC50aXRsZSgiVnVsbkd1YXJkIC0gVnVsbmVyYWJpbGl0eSBNYW5hZ2VtZW50IikKICAgICAgICBzZWxmLnJvb3QuZ2VvbWV0cnkoIjEyMDB4ODAwIikKICAgICAgICBzZWxmLnJvb3QuY29uZmlndXJlKGJnPScjZjBmMGYwJykKICAgICAgICAKICAgICAgICAjIENvbmZpZ3VyYXRpb24KICAgICAgICBzZWxmLnNlcnZlcl91cmwgPSBvcy5nZXRlbnYoJ1ZVTE5HVUFSRF9TRVJWRVInLCAnaHR0cHM6Ly92dWxuZ3VhcmQtMy5wcmV2aWV3LmVtZXJnZW50YWdlbnQuY29tJykKICAgICAgICBzZWxmLmFwaV9rZXkgPSBvcy5nZXRlbnYoJ1ZVTE5HVUFSRF9BUElfS0VZJywgJycpCiAgICAgICAgCiAgICAgICAgIyBRdWV1ZSBmb3IgdGhyZWFkIGNvbW11bmljYXRpb24KICAgICAgICBzZWxmLnF1ZXVlID0gcXVldWUuUXVldWUoKQogICAgICAgIAogICAgICAgICMgRGF0YSBzdG9yYWdlCiAgICAgICAgc2VsZi5hc3NldHMgPSBbXQogICAgICAgIHNlbGYuZmluZGluZ3MgPSBbXQogICAgICAgIHNlbGYuc2NhbnMgPSBbXQogICAgICAgIAogICAgICAgIHNlbGYuc2V0dXBfdWkoKQogICAgICAgIHNlbGYuc2V0dXBfbWVudSgpCiAgICAgICAgCiAgICAgICAgIyBTdGFydCBwZXJpb2RpYyB1cGRhdGVzCiAgICAgICAgc2VsZi5yb290LmFmdGVyKDEwMDAsIHNlbGYucHJvY2Vzc19xdWV1ZSkKICAgICAgICAKICAgIGRlZiBzZXR1cF91aShzZWxmKToKICAgICAgICAiIiJTZXR1cCB0aGUgbWFpbiBVSSIiIgogICAgICAgICMgQ3JlYXRlIG1haW4gZnJhbWUKICAgICAgICBtYWluX2ZyYW1lID0gdHRrLkZyYW1lKHNlbGYucm9vdCwgcGFkZGluZz0iMTAiKQogICAgICAgIG1haW5fZnJhbWUuZ3JpZChyb3c9MCwgY29sdW1uPTAsIHN0aWNreT0odGsuVywgdGsuRSwgdGsuTiwgdGsuUykpCiAgICAgICAgCiAgICAgICAgIyBDb25maWd1cmUgZ3JpZCB3ZWlnaHRzCiAgICAgICAgc2VsZi5yb290LmNvbHVtbmNvbmZpZ3VyZSgwLCB3ZWlnaHQ9MSkKICAgICAgICBzZWxmLnJvb3Qucm93Y29uZmlndXJlKDAsIHdlaWdodD0xKQogICAgICAgIG1haW5fZnJhbWUuY29sdW1uY29uZmlndXJlKDEsIHdlaWdodD0xKQogICAgICAgIG1haW5fZnJhbWUucm93Y29uZmlndXJlKDAsIHdlaWdodD0xKQogICAgICAgIAogICAgICAgICMgQ3JlYXRlIHNpZGViYXIKICAgICAgICBzZWxmLnNldHVwX3NpZGViYXIobWFpbl9mcmFtZSkKICAgICAgICAKICAgICAgICAjIENyZWF0ZSBtYWluIGNvbnRlbnQgYXJlYQogICAgICAgIHNlbGYuc2V0dXBfY29udGVudF9hcmVhKG1haW5fZnJhbWUpCiAgICAgICAgCiAgICAgICAgIyBDcmVhdGUgc3RhdHVzIGJhcgogICAgICAgIHNlbGYuc2V0dXBfc3RhdHVzX2JhcihtYWluX2ZyYW1lKQogICAgICAgIAogICAgZGVmIHNldHVwX21lbnUoc2VsZik6CiAgICAgICAgIiIiU2V0dXAgdGhlIGFwcGxpY2F0aW9uIG1lbnUiIiIKICAgICAgICBtZW51YmFyID0gdGsuTWVudShzZWxmLnJvb3QpCiAgICAgICAgc2VsZi5yb290LmNvbmZpZyhtZW51PW1lbnViYXIpCiAgICAgICAgCiAgICAgICAgIyBGaWxlIG1lbnUKICAgICAgICBmaWxlX21lbnUgPSB0ay5NZW51KG1lbnViYXIsIHRlYXJvZmY9MCkKICAgICAgICBtZW51YmFyLmFkZF9jYXNjYWRlKGxhYmVsPSJGaWxlIiwgbWVudT1maWxlX21lbnUpCiAgICAgICAgZmlsZV9tZW51LmFkZF9jb21tYW5kKGxhYmVsPSJVcGxvYWQgU2NhbiBGaWxlIiwgY29tbWFuZD1zZWxmLnVwbG9hZF9zY2FuX2ZpbGUpCiAgICAgICAgZmlsZV9tZW51LmFkZF9zZXBhcmF0b3IoKQogICAgICAgIGZpbGVfbWVudS5hZGRfY29tbWFuZChsYWJlbD0iRXhwb3J0IFJlcG9ydCIsIGNvbW1hbmQ9c2VsZi5leHBvcnRfcmVwb3J0KQogICAgICAgIGZpbGVfbWVudS5hZGRfc2VwYXJhdG9yKCkKICAgICAgICBmaWxlX21lbnUuYWRkX2NvbW1hbmQobGFiZWw9IkV4aXQiLCBjb21tYW5kPXNlbGYucm9vdC5xdWl0KQogICAgICAgIAogICAgICAgICMgVG9vbHMgbWVudQogICAgICAgIHRvb2xzX21lbnUgPSB0ay5NZW51KG1lbnViYXIsIHRlYXJvZmY9MCkKICAgICAgICBtZW51YmFyLmFkZF9jYXNjYWRlKGxhYmVsPSJUb29scyIsIG1lbnU9dG9vbHNfbWVudSkKICAgICAgICB0b29sc19tZW51LmFkZF9jb21tYW5kKGxhYmVsPSJTdGFydCBOZXR3b3JrIFNjYW4iLCBjb21tYW5kPXNlbGYuc3RhcnRfbmV0d29ya19zY2FuKQogICAgICAgIHRvb2xzX21lbnUuYWRkX2NvbW1hbmQobGFiZWw9IlJ1biBBZ2VudCBTY2FuIiwgY29tbWFuZD1zZWxmLnJ1bl9hZ2VudF9zY2FuKQogICAgICAgIHRvb2xzX21lbnUuYWRkX3NlcGFyYXRvcigpCiAgICAgICAgdG9vbHNfbWVudS5hZGRfY29tbWFuZChsYWJlbD0iU2V0dGluZ3MiLCBjb21tYW5kPXNlbGYuc2hvd19zZXR0aW5ncykKICAgICAgICAKICAgICAgICAjIEhlbHAgbWVudQogICAgICAgIGhlbHBfbWVudSA9IHRrLk1lbnUobWVudWJhciwgdGVhcm9mZj0wKQogICAgICAgIG1lbnViYXIuYWRkX2Nhc2NhZGUobGFiZWw9IkhlbHAiLCBtZW51PWhlbHBfbWVudSkKICAgICAgICBoZWxwX21lbnUuYWRkX2NvbW1hbmQobGFiZWw9IkFib3V0IiwgY29tbWFuZD1zZWxmLnNob3dfYWJvdXQpCiAgICAgICAgCiAgICBkZWYgc2V0dXBfc2lkZWJhcihzZWxmLCBwYXJlbnQpOgogICAgICAgICIiIlNldHVwIHRoZSBzaWRlYmFyIG5hdmlnYXRpb24iIiIKICAgICAgICBzaWRlYmFyID0gdHRrLkZyYW1lKHBhcmVudCwgd2lkdGg9MjAwKQogICAgICAgIHNpZGViYXIuZ3JpZChyb3c9MCwgY29sdW1uPTAsIHN0aWNreT0odGsuTiwgdGsuUyksIHBhZHg9KDAsIDEwKSkKICAgICAgICBzaWRlYmFyLmdyaWRfcHJvcGFnYXRlKEZhbHNlKQogICAgICAgIAogICAgICAgICMgVnVsbkd1YXJkIGxvZ28vdGl0bGUKICAgICAgICB0aXRsZV9mcmFtZSA9IHR0ay5GcmFtZShzaWRlYmFyKQogICAgICAgIHRpdGxlX2ZyYW1lLnBhY2soZmlsbD10ay5YLCBwYWR5PSgwLCAyMCkpCiAgICAgICAgCiAgICAgICAgdGl0bGVfbGFiZWwgPSB0dGsuTGFiZWwodGl0bGVfZnJhbWUsIHRleHQ9IvCfm6HvuI8gVnVsbkd1YXJkIiwgZm9udD0oJ0FyaWFsJywgMTYsICdib2xkJykpCiAgICAgICAgdGl0bGVfbGFiZWwucGFjaygpCiAgICAgICAgCiAgICAgICAgc3VidGl0bGVfbGFiZWwgPSB0dGsuTGFiZWwodGl0bGVfZnJhbWUsIHRleHQ9IkRlc2t0b3AgdjIuMCIsIGZvbnQ9KCdBcmlhbCcsIDgpKQogICAgICAgIHN1YnRpdGxlX2xhYmVsLnBhY2soKQogICAgICAgIAogICAgICAgICMgTmF2aWdhdGlvbiBidXR0b25zCiAgICAgICAgbmF2X2J1dHRvbnMgPSBbCiAgICAgICAgICAgICgi8J+TiiBEYXNoYm9hcmQiLCBzZWxmLnNob3dfZGFzaGJvYXJkKSwKICAgICAgICAgICAgKCLwn5al77iPIEFzc2V0cyIsIHNlbGYuc2hvd19hc3NldHMpLAogICAgICAgICAgICAoIuKaoO+4jyBGaW5kaW5ncyIsIHNlbGYuc2hvd19maW5kaW5ncyksCiAgICAgICAgICAgICgi8J+UjSBTY2FucyIsIHNlbGYuc2hvd19zY2FucyksCiAgICAgICAgICAgICgi8J+UpyBSZW1lZGlhdGlvbiIsIHNlbGYuc2hvd19yZW1lZGlhdGlvbiksCiAgICAgICAgICAgICgi8J+TiyBBdWRpdCBUcmFpbCIsIHNlbGYuc2hvd19hdWRpdCksCiAgICAgICAgXQogICAgICAgIAogICAgICAgIGZvciB0ZXh0LCBjb21tYW5kIGluIG5hdl9idXR0b25zOgogICAgICAgICAgICBidG4gPSB0dGsuQnV0dG9uKHNpZGViYXIsIHRleHQ9dGV4dCwgY29tbWFuZD1jb21tYW5kLCB3aWR0aD0yNSkKICAgICAgICAgICAgYnRuLnBhY2soZmlsbD10ay5YLCBwYWR5PTIpCiAgICAgICAgCiAgICAgICAgIyBTZXJ2ZXIgc3RhdHVzCiAgICAgICAgc3RhdHVzX2ZyYW1lID0gdHRrLkxhYmVsRnJhbWUoc2lkZWJhciwgdGV4dD0iU2VydmVyIFN0YXR1cyIsIHBhZGRpbmc9MTApCiAgICAgICAgc3RhdHVzX2ZyYW1lLnBhY2soZmlsbD10ay5YLCBwYWR5PSgyMCwgMCkpCiAgICAgICAgCiAgICAgICAgc2VsZi5zZXJ2ZXJfc3RhdHVzX2xhYmVsID0gdHRrLkxhYmVsKHN0YXR1c19mcmFtZSwgdGV4dD0iQ2hlY2tpbmcuLi4iLCBmb3JlZ3JvdW5kPSJvcmFuZ2UiKQogICAgICAgIHNlbGYuc2VydmVyX3N0YXR1c19sYWJlbC5wYWNrKCkKICAgICAgICAKICAgICAgICAjIENoZWNrIHNlcnZlciBzdGF0dXMKICAgICAgICBzZWxmLmNoZWNrX3NlcnZlcl9zdGF0dXMoKQogICAgICAgIAogICAgZGVmIHNldHVwX2NvbnRlbnRfYXJlYShzZWxmLCBwYXJlbnQpOgogICAgICAgICIiIlNldHVwIHRoZSBtYWluIGNvbnRlbnQgYXJlYSIiIgogICAgICAgIHNlbGYuY29udGVudF9mcmFtZSA9IHR0ay5GcmFtZShwYXJlbnQpCiAgICAgICAgc2VsZi5jb250ZW50X2ZyYW1lLmdyaWQocm93PTAsIGNvbHVtbj0xLCBzdGlja3k9KHRrLlcsIHRrLkUsIHRrLk4sIHRrLlMpKQogICAgICAgIHNlbGYuY29udGVudF9mcmFtZS5jb2x1bW5jb25maWd1cmUoMCwgd2VpZ2h0PTEpCiAgICAgICAgc2VsZi5jb250ZW50X2ZyYW1lLnJvd2NvbmZpZ3VyZSgwLCB3ZWlnaHQ9MSkKICAgICAgICAKICAgICAgICAjIFNob3cgZGFzaGJvYXJkIGJ5IGRlZmF1bHQKICAgICAgICBzZWxmLnNob3dfZGFzaGJvYXJkKCkKICAgICAgICAKICAgIGRlZiBzZXR1cF9zdGF0dXNfYmFyKHNlbGYsIHBhcmVudCk6CiAgICAgICAgIiIiU2V0dXAgdGhlIHN0YXR1cyBiYXIiIiIKICAgICAgICBzZWxmLnN0YXR1c19mcmFtZSA9IHR0ay5GcmFtZShwYXJlbnQpCiAgICAgICAgc2VsZi5zdGF0dXNfZnJhbWUuZ3JpZChyb3c9MSwgY29sdW1uPTAsIGNvbHVtbnNwYW49Miwgc3RpY2t5PSh0ay5XLCB0ay5FKSwgcGFkeT0oMTAsIDApKQogICAgICAgIAogICAgICAgIHNlbGYuc3RhdHVzX2xhYmVsID0gdHRrLkxhYmVsKHNlbGYuc3RhdHVzX2ZyYW1lLCB0ZXh0PSJSZWFkeSIpCiAgICAgICAgc2VsZi5zdGF0dXNfbGFiZWwucGFjayhzaWRlPXRrLkxFRlQpCiAgICAgICAgCiAgICAgICAgc2VsZi5wcm9ncmVzc19iYXIgPSB0dGsuUHJvZ3Jlc3NiYXIoc2VsZi5zdGF0dXNfZnJhbWUsIG1vZGU9J2luZGV0ZXJtaW5hdGUnKQogICAgICAgIHNlbGYucHJvZ3Jlc3NfYmFyLnBhY2soc2lkZT10ay5SSUdIVCwgcGFkeD0oMTAsIDApKQogICAgICAgIAogICAgZGVmIGNsZWFyX2NvbnRlbnQoc2VsZik6CiAgICAgICAgIiIiQ2xlYXIgdGhlIGNvbnRlbnQgYXJlYSIiIgogICAgICAgIGZvciB3aWRnZXQgaW4gc2VsZi5jb250ZW50X2ZyYW1lLndpbmZvX2NoaWxkcmVuKCk6CiAgICAgICAgICAgIHdpZGdldC5kZXN0cm95KCkKICAgIAogICAgZGVmIHNldF9zdGF0dXMoc2VsZiwgbWVzc2FnZSwgc2hvd19wcm9ncmVzcz1GYWxzZSk6CiAgICAgICAgIiIiU2V0IHN0YXR1cyBiYXIgbWVzc2FnZSIiIgogICAgICAgIHNlbGYuc3RhdHVzX2xhYmVsLmNvbmZpZyh0ZXh0PW1lc3NhZ2UpCiAgICAgICAgaWYgc2hvd19wcm9ncmVzczoKICAgICAgICAgICAgc2VsZi5wcm9ncmVzc19iYXIuc3RhcnQoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYucHJvZ3Jlc3NfYmFyLnN0b3AoKQogICAgCiAgICBkZWYgc2hvd19kYXNoYm9hcmQoc2VsZik6CiAgICAgICAgIiIiU2hvdyBkYXNoYm9hcmQgdmlldyIiIgogICAgICAgIHNlbGYuY2xlYXJfY29udGVudCgpCiAgICAgICAgc2VsZi5zZXRfc3RhdHVzKCJMb2FkaW5nIGRhc2hib2FyZC4uLiIpCiAgICAgICAgCiAgICAgICAgIyBDcmVhdGUgZGFzaGJvYXJkIGZyYW1lCiAgICAgICAgZGFzaGJvYXJkX2ZyYW1lID0gdHRrLkZyYW1lKHNlbGYuY29udGVudF9mcmFtZSkKICAgICAgICBkYXNoYm9hcmRfZnJhbWUucGFjayhmaWxsPXRrLkJPVEgsIGV4cGFuZD1UcnVlLCBwYWR4PTEwLCBwYWR5PTEwKQogICAgICAgIAogICAgICAgICMgVGl0bGUKICAgICAgICB0aXRsZV9sYWJlbCA9IHR0ay5MYWJlbChkYXNoYm9hcmRfZnJhbWUsIHRleHQ9IlNlY3VyaXR5IERhc2hib2FyZCIsIGZvbnQ9KCdBcmlhbCcsIDE4LCAnYm9sZCcpKQogICAgICAgIHRpdGxlX2xhYmVsLnBhY2socGFkeT0oMCwgMjApKQogICAgICAgIAogICAgICAgICMgU3RhdHMgZnJhbWUKICAgICAgICBzdGF0c19mcmFtZSA9IHR0ay5GcmFtZShkYXNoYm9hcmRfZnJhbWUpCiAgICAgICAgc3RhdHNfZnJhbWUucGFjayhmaWxsPXRrLlgsIHBhZHk9KDAsIDIwKSkKICAgICAgICAKICAgICAgICAjIENyZWF0ZSBzdGF0IGNhcmRzCiAgICAgICAgc2VsZi5jcmVhdGVfc3RhdF9jYXJkKHN0YXRzX2ZyYW1lLCAiVG90YWwgQXNzZXRzIiwgIkxvYWRpbmcuLi4iLCAwLCAwKQogICAgICAgIHNlbGYuY3JlYXRlX3N0YXRfY2FyZChzdGF0c19mcmFtZSwgIkFjdGl2ZSBGaW5kaW5ncyIsICJMb2FkaW5nLi4uIiwgMCwgMSkKICAgICAgICBzZWxmLmNyZWF0ZV9zdGF0X2NhcmQoc3RhdHNfZnJhbWUsICJDcml0aWNhbCBJc3N1ZXMiLCAiTG9hZGluZy4uLiIsIDAsIDIpCiAgICAgICAgc2VsZi5jcmVhdGVfc3RhdF9jYXJkKHN0YXRzX2ZyYW1lLCAiUGVuZGluZyBBcHByb3ZhbHMiLCAiTG9hZGluZy4uLiIsIDAsIDMpCiAgICAgICAgCiAgICAgICAgIyBDaGFydHMgcGxhY2Vob2xkZXIKICAgICAgICBjaGFydHNfZnJhbWUgPSB0dGsuTGFiZWxGcmFtZShkYXNoYm9hcmRfZnJhbWUsIHRleHQ9IlNlY3VyaXR5IE1ldHJpY3MiLCBwYWRkaW5nPTEwKQogICAgICAgIGNoYXJ0c19mcmFtZS5wYWNrKGZpbGw9dGsuQk9USCwgZXhwYW5kPVRydWUpCiAgICAgICAgCiAgICAgICAgY2hhcnRfbGFiZWwgPSB0dGsuTGFiZWwoY2hhcnRzX2ZyYW1lLCB0ZXh0PSLwn5OKIENoYXJ0cyBhbmQgdmlzdWFsaXphdGlvbnMgd291bGQgYmUgZGlzcGxheWVkIGhlcmVcbihSZXF1aXJlcyBhZGRpdGlvbmFsIGxpYnJhcmllcyBsaWtlIG1hdHBsb3RsaWIpIiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb250PSgnQXJpYWwnLCAxMiksIGFuY2hvcj10ay5DRU5URVIpCiAgICAgICAgY2hhcnRfbGFiZWwucGFjayhleHBhbmQ9VHJ1ZSkKICAgICAgICAKICAgICAgICAjIExvYWQgZGFzaGJvYXJkIGRhdGEKICAgICAgICB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1zZWxmLmxvYWRfZGFzaGJvYXJkX2RhdGEsIGRhZW1vbj1UcnVlKS5zdGFydCgpCiAgICAgICAgCiAgICBkZWYgY3JlYXRlX3N0YXRfY2FyZChzZWxmLCBwYXJlbnQsIHRpdGxlLCB2YWx1ZSwgcm93LCBjb2wpOgogICAgICAgICIiIkNyZWF0ZSBhIHN0YXRpc3RpY3MgY2FyZCIiIgogICAgICAgIGNhcmRfZnJhbWUgPSB0dGsuTGFiZWxGcmFtZShwYXJlbnQsIHRleHQ9dGl0bGUsIHBhZGRpbmc9MTApCiAgICAgICAgY2FyZF9mcmFtZS5ncmlkKHJvdz1yb3csIGNvbHVtbj1jb2wsIHBhZHg9NSwgcGFkeT01LCBzdGlja3k9KHRrLlcsIHRrLkUpKQogICAgICAgIHBhcmVudC5jb2x1bW5jb25maWd1cmUoY29sLCB3ZWlnaHQ9MSkKICAgICAgICAKICAgICAgICB2YWx1ZV9sYWJlbCA9IHR0ay5MYWJlbChjYXJkX2ZyYW1lLCB0ZXh0PXN0cih2YWx1ZSksIGZvbnQ9KCdBcmlhbCcsIDE2LCAnYm9sZCcpKQogICAgICAgIHZhbHVlX2xhYmVsLnBhY2soKQogICAgICAgIAogICAgICAgIHJldHVybiB2YWx1ZV9sYWJlbAogICAgCiAgICBkZWYgc2hvd19hc3NldHMoc2VsZik6CiAgICAgICAgIiIiU2hvdyBhc3NldHMgdmlldyIiIgogICAgICAgIHNlbGYuY2xlYXJfY29udGVudCgpCiAgICAgICAgc2VsZi5zZXRfc3RhdHVzKCJMb2FkaW5nIGFzc2V0cy4uLiIpCiAgICAgICAgCiAgICAgICAgIyBDcmVhdGUgYXNzZXRzIGZyYW1lCiAgICAgICAgYXNzZXRzX2ZyYW1lID0gdHRrLkZyYW1lKHNlbGYuY29udGVudF9mcmFtZSkKICAgICAgICBhc3NldHNfZnJhbWUucGFjayhmaWxsPXRrLkJPVEgsIGV4cGFuZD1UcnVlLCBwYWR4PTEwLCBwYWR5PTEwKQogICAgICAgIAogICAgICAgICMgVGl0bGUgYW5kIGNvbnRyb2xzCiAgICAgICAgaGVhZGVyX2ZyYW1lID0gdHRrLkZyYW1lKGFzc2V0c19mcmFtZSkKICAgICAgICBoZWFkZXJfZnJhbWUucGFjayhmaWxsPXRrLlgsIHBhZHk9KDAsIDEwKSkKICAgICAgICAKICAgICAgICB0aXRsZV9sYWJlbCA9IHR0ay5MYWJlbChoZWFkZXJfZnJhbWUsIHRleHQ9IkFzc2V0IEludmVudG9yeSIsIGZvbnQ9KCdBcmlhbCcsIDE4LCAnYm9sZCcpKQogICAgICAgIHRpdGxlX2xhYmVsLnBhY2soc2lkZT10ay5MRUZUKQogICAgICAgIAogICAgICAgIGFkZF9hc3NldF9idG4gPSB0dGsuQnV0dG9uKGhlYWRlcl9mcmFtZSwgdGV4dD0iQWRkIEFzc2V0IiwgY29tbWFuZD1zZWxmLmFkZF9hc3NldF9kaWFsb2cpCiAgICAgICAgYWRkX2Fzc2V0X2J0bi5wYWNrKHNpZGU9dGsuUklHSFQpCiAgICAgICAgCiAgICAgICAgcmVmcmVzaF9idG4gPSB0dGsuQnV0dG9uKGhlYWRlcl9mcmFtZSwgdGV4dD0iUmVmcmVzaCIsIGNvbW1hbmQ9bGFtYmRhOiB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1zZWxmLmxvYWRfYXNzZXRzLCBkYWVtb249VHJ1ZSkuc3RhcnQoKSkKICAgICAgICByZWZyZXNoX2J0bi5wYWNrKHNpZGU9dGsuUklHSFQsIHBhZHg9KDAsIDUpKQogICAgICAgIAogICAgICAgICMgQXNzZXRzIHRyZWV2aWV3CiAgICAgICAgY29sdW1ucyA9ICgnSG9zdG5hbWUnLCAnSVAgQWRkcmVzcycsICdUeXBlJywgJ0Vudmlyb25tZW50JywgJ0NyaXRpY2FsaXR5JywgJ093bmVyJykKICAgICAgICBzZWxmLmFzc2V0c190cmVlID0gdHRrLlRyZWV2aWV3KGFzc2V0c19mcmFtZSwgY29sdW1ucz1jb2x1bW5zLCBzaG93PSdoZWFkaW5ncycsIGhlaWdodD0xNSkKICAgICAgICAKICAgICAgICBmb3IgY29sIGluIGNvbHVtbnM6CiAgICAgICAgICAgIHNlbGYuYXNzZXRzX3RyZWUuaGVhZGluZyhjb2wsIHRleHQ9Y29sKQogICAgICAgICAgICBzZWxmLmFzc2V0c190cmVlLmNvbHVtbihjb2wsIHdpZHRoPTE1MCkKICAgICAgICAKICAgICAgICAjIFNjcm9sbGJhcnMKICAgICAgICB2X3Njcm9sbGJhciA9IHR0ay5TY3JvbGxiYXIoYXNzZXRzX2ZyYW1lLCBvcmllbnQ9dGsuVkVSVElDQUwsIGNvbW1hbmQ9c2VsZi5hc3NldHNfdHJlZS55dmlldykKICAgICAgICBzZWxmLmFzc2V0c190cmVlLmNvbmZpZ3VyZSh5c2Nyb2xsY29tbWFuZD12X3Njcm9sbGJhci5zZXQpCiAgICAgICAgCiAgICAgICAgaF9zY3JvbGxiYXIgPSB0dGsuU2Nyb2xsYmFyKGFzc2V0c19mcmFtZSwgb3JpZW50PXRrLkhPUklaT05UQUwsIGNvbW1hbmQ9c2VsZi5hc3NldHNfdHJlZS54dmlldykKICAgICAgICBzZWxmLmFzc2V0c190cmVlLmNvbmZpZ3VyZSh4c2Nyb2xsY29tbWFuZD1oX3Njcm9sbGJhci5zZXQpCiAgICAgICAgCiAgICAgICAgIyBQYWNrIHRyZWV2aWV3IGFuZCBzY3JvbGxiYXJzCiAgICAgICAgc2VsZi5hc3NldHNfdHJlZS5wYWNrKHNpZGU9dGsuTEVGVCwgZmlsbD10ay5CT1RILCBleHBhbmQ9VHJ1ZSkKICAgICAgICB2X3Njcm9sbGJhci5wYWNrKHNpZGU9dGsuUklHSFQsIGZpbGw9dGsuWSkKICAgICAgICBoX3Njcm9sbGJhci5wYWNrKHNpZGU9dGsuQk9UVE9NLCBmaWxsPXRrLlgpCiAgICAgICAgCiAgICAgICAgIyBMb2FkIGFzc2V0cyBkYXRhCiAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5sb2FkX2Fzc2V0cywgZGFlbW9uPVRydWUpLnN0YXJ0KCkKICAgIAogICAgZGVmIHNob3dfZmluZGluZ3Moc2VsZik6CiAgICAgICAgIiIiU2hvdyBmaW5kaW5ncyB2aWV3IiIiCiAgICAgICAgc2VsZi5jbGVhcl9jb250ZW50KCkKICAgICAgICBzZWxmLnNldF9zdGF0dXMoIkxvYWRpbmcgZmluZGluZ3MuLi4iKQogICAgICAgIAogICAgICAgICMgQ3JlYXRlIGZpbmRpbmdzIGZyYW1lCiAgICAgICAgZmluZGluZ3NfZnJhbWUgPSB0dGsuRnJhbWUoc2VsZi5jb250ZW50X2ZyYW1lKQogICAgICAgIGZpbmRpbmdzX2ZyYW1lLnBhY2soZmlsbD10ay5CT1RILCBleHBhbmQ9VHJ1ZSwgcGFkeD0xMCwgcGFkeT0xMCkKICAgICAgICAKICAgICAgICAjIFRpdGxlIGFuZCBjb250cm9scwogICAgICAgIGhlYWRlcl9mcmFtZSA9IHR0ay5GcmFtZShmaW5kaW5nc19mcmFtZSkKICAgICAgICBoZWFkZXJfZnJhbWUucGFjayhmaWxsPXRrLlgsIHBhZHk9KDAsIDEwKSkKICAgICAgICAKICAgICAgICB0aXRsZV9sYWJlbCA9IHR0ay5MYWJlbChoZWFkZXJfZnJhbWUsIHRleHQ9IlNlY3VyaXR5IEZpbmRpbmdzIiwgZm9udD0oJ0FyaWFsJywgMTgsICdib2xkJykpCiAgICAgICAgdGl0bGVfbGFiZWwucGFjayhzaWRlPXRrLkxFRlQpCiAgICAgICAgCiAgICAgICAgIyBGaWx0ZXJzCiAgICAgICAgZmlsdGVyX2ZyYW1lID0gdHRrLkZyYW1lKGhlYWRlcl9mcmFtZSkKICAgICAgICBmaWx0ZXJfZnJhbWUucGFjayhzaWRlPXRrLlJJR0hUKQogICAgICAgIAogICAgICAgIHR0ay5MYWJlbChmaWx0ZXJfZnJhbWUsIHRleHQ9IlNldmVyaXR5OiIpLnBhY2soc2lkZT10ay5MRUZULCBwYWR4PSgwLCA1KSkKICAgICAgICBzZWxmLnNldmVyaXR5X2ZpbHRlciA9IHR0ay5Db21ib2JveChmaWx0ZXJfZnJhbWUsIHZhbHVlcz1bJ0FsbCcsICdDcml0aWNhbCcsICdIaWdoJywgJ01lZGl1bScsICdMb3cnXSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZT0ncmVhZG9ubHknLCB3aWR0aD0xMCkKICAgICAgICBzZWxmLnNldmVyaXR5X2ZpbHRlci5zZXQoJ0FsbCcpCiAgICAgICAgc2VsZi5zZXZlcml0eV9maWx0ZXIucGFjayhzaWRlPXRrLkxFRlQsIHBhZHg9KDAsIDEwKSkKICAgICAgICAKICAgICAgICBmaWx0ZXJfYnRuID0gdHRrLkJ1dHRvbihmaWx0ZXJfZnJhbWUsIHRleHQ9IkZpbHRlciIsIGNvbW1hbmQ9c2VsZi5maWx0ZXJfZmluZGluZ3MpCiAgICAgICAgZmlsdGVyX2J0bi5wYWNrKHNpZGU9dGsuTEVGVCkKICAgICAgICAKICAgICAgICAjIEZpbmRpbmdzIHRyZWV2aWV3CiAgICAgICAgY29sdW1ucyA9ICgnVGl0bGUnLCAnU2V2ZXJpdHknLCAnVHlwZScsICdBc3NldCcsICdDVkUgSURzJywgJ0ZpcnN0IFNlZW4nKQogICAgICAgIHNlbGYuZmluZGluZ3NfdHJlZSA9IHR0ay5UcmVldmlldyhmaW5kaW5nc19mcmFtZSwgY29sdW1ucz1jb2x1bW5zLCBzaG93PSdoZWFkaW5ncycsIGhlaWdodD0xNSkKICAgICAgICAKICAgICAgICBmb3IgY29sIGluIGNvbHVtbnM6CiAgICAgICAgICAgIHNlbGYuZmluZGluZ3NfdHJlZS5oZWFkaW5nKGNvbCwgdGV4dD1jb2wpCiAgICAgICAgICAgIGlmIGNvbCA9PSAnVGl0bGUnOgogICAgICAgICAgICAgICAgc2VsZi5maW5kaW5nc190cmVlLmNvbHVtbihjb2wsIHdpZHRoPTMwMCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuZmluZGluZ3NfdHJlZS5jb2x1bW4oY29sLCB3aWR0aD0xMjApCiAgICAgICAgCiAgICAgICAgIyBEb3VibGUtY2xpY2sgYmluZGluZwogICAgICAgIHNlbGYuZmluZGluZ3NfdHJlZS5iaW5kKCc8RG91YmxlLTE+Jywgc2VsZi5zaG93X2ZpbmRpbmdfZGV0YWlscykKICAgICAgICAKICAgICAgICAjIFNjcm9sbGJhcnMKICAgICAgICB2X3Njcm9sbGJhciA9IHR0ay5TY3JvbGxiYXIoZmluZGluZ3NfZnJhbWUsIG9yaWVudD10ay5WRVJUSUNBTCwgY29tbWFuZD1zZWxmLmZpbmRpbmdzX3RyZWUueXZpZXcpCiAgICAgICAgc2VsZi5maW5kaW5nc190cmVlLmNvbmZpZ3VyZSh5c2Nyb2xsY29tbWFuZD12X3Njcm9sbGJhci5zZXQpCiAgICAgICAgCiAgICAgICAgIyBQYWNrIHRyZWV2aWV3IGFuZCBzY3JvbGxiYXJzCiAgICAgICAgc2VsZi5maW5kaW5nc190cmVlLnBhY2soc2lkZT10ay5MRUZULCBmaWxsPXRrLkJPVEgsIGV4cGFuZD1UcnVlKQogICAgICAgIHZfc2Nyb2xsYmFyLnBhY2soc2lkZT10ay5SSUdIVCwgZmlsbD10ay5ZKQogICAgICAgIAogICAgICAgICMgTG9hZCBmaW5kaW5ncyBkYXRhCiAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5sb2FkX2ZpbmRpbmdzLCBkYWVtb249VHJ1ZSkuc3RhcnQoKQogICAgCiAgICBkZWYgc2hvd19zY2FucyhzZWxmKToKICAgICAgICAiIiJTaG93IHNjYW5zIHZpZXciIiIKICAgICAgICBzZWxmLmNsZWFyX2NvbnRlbnQoKQogICAgICAgIHNlbGYuc2V0X3N0YXR1cygiTG9hZGluZyBzY2Fucy4uLiIpCiAgICAgICAgCiAgICAgICAgIyBDcmVhdGUgc2NhbnMgZnJhbWUKICAgICAgICBzY2Fuc19mcmFtZSA9IHR0ay5GcmFtZShzZWxmLmNvbnRlbnRfZnJhbWUpCiAgICAgICAgc2NhbnNfZnJhbWUucGFjayhmaWxsPXRrLkJPVEgsIGV4cGFuZD1UcnVlLCBwYWR4PTEwLCBwYWR5PTEwKQogICAgICAgIAogICAgICAgICMgVGl0bGUgYW5kIGNvbnRyb2xzCiAgICAgICAgaGVhZGVyX2ZyYW1lID0gdHRrLkZyYW1lKHNjYW5zX2ZyYW1lKQogICAgICAgIGhlYWRlcl9mcmFtZS5wYWNrKGZpbGw9dGsuWCwgcGFkeT0oMCwgMTApKQogICAgICAgIAogICAgICAgIHRpdGxlX2xhYmVsID0gdHRrLkxhYmVsKGhlYWRlcl9mcmFtZSwgdGV4dD0iVnVsbmVyYWJpbGl0eSBTY2FucyIsIGZvbnQ9KCdBcmlhbCcsIDE4LCAnYm9sZCcpKQogICAgICAgIHRpdGxlX2xhYmVsLnBhY2soc2lkZT10ay5MRUZUKQogICAgICAgIAogICAgICAgIHN0YXJ0X3NjYW5fYnRuID0gdHRrLkJ1dHRvbihoZWFkZXJfZnJhbWUsIHRleHQ9IlN0YXJ0IE5ldHdvcmsgU2NhbiIsIGNvbW1hbmQ9c2VsZi5zdGFydF9uZXR3b3JrX3NjYW4pCiAgICAgICAgc3RhcnRfc2Nhbl9idG4ucGFjayhzaWRlPXRrLlJJR0hUKQogICAgICAgIAogICAgICAgIHVwbG9hZF9idG4gPSB0dGsuQnV0dG9uKGhlYWRlcl9mcmFtZSwgdGV4dD0iVXBsb2FkIFNjYW4gRmlsZSIsIGNvbW1hbmQ9c2VsZi51cGxvYWRfc2Nhbl9maWxlKQogICAgICAgIHVwbG9hZF9idG4ucGFjayhzaWRlPXRrLlJJR0hULCBwYWR4PSgwLCA1KSkKICAgICAgICAKICAgICAgICAjIFNjYW4gaGlzdG9yeSAocGxhY2Vob2xkZXIpCiAgICAgICAgaGlzdG9yeV9mcmFtZSA9IHR0ay5MYWJlbEZyYW1lKHNjYW5zX2ZyYW1lLCB0ZXh0PSJTY2FuIEhpc3RvcnkiLCBwYWRkaW5nPTEwKQogICAgICAgIGhpc3RvcnlfZnJhbWUucGFjayhmaWxsPXRrLkJPVEgsIGV4cGFuZD1UcnVlKQogICAgICAgIAogICAgICAgIGhpc3RvcnlfdGV4dCA9IHNjcm9sbGVkdGV4dC5TY3JvbGxlZFRleHQoaGlzdG9yeV9mcmFtZSwgaGVpZ2h0PTIwLCBzdGF0ZT0nZGlzYWJsZWQnKQogICAgICAgIGhpc3RvcnlfdGV4dC5wYWNrKGZpbGw9dGsuQk9USCwgZXhwYW5kPVRydWUpCiAgICAgICAgCiAgICAgICAgc2VsZi5zY2FuX2hpc3RvcnlfdGV4dCA9IGhpc3RvcnlfdGV4dAogICAgICAgIAogICAgICAgICMgTG9hZCByZWNlbnQgc2NhbnMKICAgICAgICBzZWxmLnVwZGF0ZV9zY2FuX2hpc3RvcnkoIk5vIHJlY2VudCBzY2FucyBhdmFpbGFibGUuIikKICAgIAogICAgZGVmIHNob3dfcmVtZWRpYXRpb24oc2VsZik6CiAgICAgICAgIiIiU2hvdyByZW1lZGlhdGlvbiB2aWV3IiIiCiAgICAgICAgc2VsZi5jbGVhcl9jb250ZW50KCkKICAgICAgICAKICAgICAgICAjIENyZWF0ZSByZW1lZGlhdGlvbiBmcmFtZQogICAgICAgIHJlbWVkaWF0aW9uX2ZyYW1lID0gdHRrLkZyYW1lKHNlbGYuY29udGVudF9mcmFtZSkKICAgICAgICByZW1lZGlhdGlvbl9mcmFtZS5wYWNrKGZpbGw9dGsuQk9USCwgZXhwYW5kPVRydWUsIHBhZHg9MTAsIHBhZHk9MTApCiAgICAgICAgCiAgICAgICAgdGl0bGVfbGFiZWwgPSB0dGsuTGFiZWwocmVtZWRpYXRpb25fZnJhbWUsIHRleHQ9IkFuc2libGUgUmVtZWRpYXRpb24iLCBmb250PSgnQXJpYWwnLCAxOCwgJ2JvbGQnKSkKICAgICAgICB0aXRsZV9sYWJlbC5wYWNrKHBhZHk9KDAsIDIwKSkKICAgICAgICAKICAgICAgICAjIFJlbWVkaWF0aW9uIG9wdGlvbnMKICAgICAgICBvcHRpb25zX2ZyYW1lID0gdHRrLkxhYmVsRnJhbWUocmVtZWRpYXRpb25fZnJhbWUsIHRleHQ9IlJlbWVkaWF0aW9uIE9wdGlvbnMiLCBwYWRkaW5nPTEwKQogICAgICAgIG9wdGlvbnNfZnJhbWUucGFjayhmaWxsPXRrLlgsIHBhZHk9KDAsIDEwKSkKICAgICAgICAKICAgICAgICB0dGsuTGFiZWwob3B0aW9uc19mcmFtZSwgdGV4dD0iU2VsZWN0IGEgZmluZGluZyB0byBnZW5lcmF0ZSBBbnNpYmxlIHJlbWVkaWF0aW9uIHBsYXlib29rcyIsIAogICAgICAgICAgICAgICAgIGZvbnQ9KCdBcmlhbCcsIDEyKSkucGFjaygpCiAgICAgICAgCiAgICAgICAgIyBQbGF5Ym9vayBkaXNwbGF5IGFyZWEKICAgICAgICBwbGF5Ym9va19mcmFtZSA9IHR0ay5MYWJlbEZyYW1lKHJlbWVkaWF0aW9uX2ZyYW1lLCB0ZXh0PSJHZW5lcmF0ZWQgUGxheWJvb2tzIiwgcGFkZGluZz0xMCkKICAgICAgICBwbGF5Ym9va19mcmFtZS5wYWNrKGZpbGw9dGsuQk9USCwgZXhwYW5kPVRydWUpCiAgICAgICAgCiAgICAgICAgc2VsZi5wbGF5Ym9va190ZXh0ID0gc2Nyb2xsZWR0ZXh0LlNjcm9sbGVkVGV4dChwbGF5Ym9va19mcmFtZSwgaGVpZ2h0PTIwLCBmb250PSgnQ291cmllcicsIDEwKSkKICAgICAgICBzZWxmLnBsYXlib29rX3RleHQucGFjayhmaWxsPXRrLkJPVEgsIGV4cGFuZD1UcnVlKQogICAgICAgIAogICAgICAgICMgU2FtcGxlIHBsYXlib29rCiAgICAgICAgc2FtcGxlX3BsYXlib29rID0gIiIiLS0tCi0gbmFtZTogVnVsbkd1YXJkIFNlY3VyaXR5IFJlbWVkaWF0aW9uCiAgaG9zdHM6IGFsbAogIGJlY29tZTogeWVzCiAgCiAgdGFza3M6CiAgICAtIG5hbWU6IFVwZGF0ZSBzeXN0ZW0gcGFja2FnZXMKICAgICAgcGFja2FnZToKICAgICAgICBuYW1lOiAnKicKICAgICAgICBzdGF0ZTogbGF0ZXN0CiAgICAgIAogICAgLSBuYW1lOiBDb25maWd1cmUgU1NIIHNlY3VyaXR5CiAgICAgIGxpbmVpbmZpbGU6CiAgICAgICAgcGF0aDogL2V0Yy9zc2gvc3NoZF9jb25maWcKICAgICAgICByZWdleHA6ICdeUGVybWl0Um9vdExvZ2luJwogICAgICAgIGxpbmU6ICdQZXJtaXRSb290TG9naW4gbm8nCiAgICAgIG5vdGlmeTogcmVzdGFydCBzc2gKICAgICAgCiAgaGFuZGxlcnM6CiAgICAtIG5hbWU6IHJlc3RhcnQgc3NoCiAgICAgIHNlcnZpY2U6CiAgICAgICAgbmFtZTogc3NoZAogICAgICAgIHN0YXRlOiByZXN0YXJ0ZWQKIiIiCiAgICAgICAgc2VsZi5wbGF5Ym9va190ZXh0Lmluc2VydCgnMS4wJywgc2FtcGxlX3BsYXlib29rKQogICAgICAgIHNlbGYucGxheWJvb2tfdGV4dC5jb25maWcoc3RhdGU9J2Rpc2FibGVkJykKICAgIAogICAgZGVmIHNob3dfYXVkaXQoc2VsZik6CiAgICAgICAgIiIiU2hvdyBhdWRpdCB0cmFpbCB2aWV3IiIiCiAgICAgICAgc2VsZi5jbGVhcl9jb250ZW50KCkKICAgICAgICAKICAgICAgICAjIENyZWF0ZSBhdWRpdCBmcmFtZSAgCiAgICAgICAgYXVkaXRfZnJhbWUgPSB0dGsuRnJhbWUoc2VsZi5jb250ZW50X2ZyYW1lKQogICAgICAgIGF1ZGl0X2ZyYW1lLnBhY2soZmlsbD10ay5CT1RILCBleHBhbmQ9VHJ1ZSwgcGFkeD0xMCwgcGFkeT0xMCkKICAgICAgICAKICAgICAgICB0aXRsZV9sYWJlbCA9IHR0ay5MYWJlbChhdWRpdF9mcmFtZSwgdGV4dD0iQXVkaXQgVHJhaWwiLCBmb250PSgnQXJpYWwnLCAxOCwgJ2JvbGQnKSkKICAgICAgICB0aXRsZV9sYWJlbC5wYWNrKHBhZHk9KDAsIDIwKSkKICAgICAgICAKICAgICAgICAjIEF1ZGl0IGxvZyBkaXNwbGF5CiAgICAgICAgbG9nX2ZyYW1lID0gdHRrLkxhYmVsRnJhbWUoYXVkaXRfZnJhbWUsIHRleHQ9IlNlY3VyaXR5IE9wZXJhdGlvbnMgTG9nIiwgcGFkZGluZz0xMCkKICAgICAgICBsb2dfZnJhbWUucGFjayhmaWxsPXRrLkJPVEgsIGV4cGFuZD1UcnVlKQogICAgICAgIAogICAgICAgICMgQ29sdW1ucyBmb3IgYXVkaXQgbG9nCiAgICAgICAgY29sdW1ucyA9ICgnVGltZXN0YW1wJywgJ1VzZXInLCAnQWN0aW9uJywgJ1Jlc291cmNlJywgJ0RldGFpbHMnKQogICAgICAgIHNlbGYuYXVkaXRfdHJlZSA9IHR0ay5UcmVldmlldyhsb2dfZnJhbWUsIGNvbHVtbnM9Y29sdW1ucywgc2hvdz0naGVhZGluZ3MnLCBoZWlnaHQ9MjApCiAgICAgICAgCiAgICAgICAgZm9yIGNvbCBpbiBjb2x1bW5zOgogICAgICAgICAgICBzZWxmLmF1ZGl0X3RyZWUuaGVhZGluZyhjb2wsIHRleHQ9Y29sKQogICAgICAgICAgICBzZWxmLmF1ZGl0X3RyZWUuY29sdW1uKGNvbCwgd2lkdGg9MTUwKQogICAgICAgIAogICAgICAgIHNlbGYuYXVkaXRfdHJlZS5wYWNrKGZpbGw9dGsuQk9USCwgZXhwYW5kPVRydWUpCiAgICAgICAgCiAgICAgICAgIyBMb2FkIGF1ZGl0IGRhdGEKICAgICAgICB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1zZWxmLmxvYWRfYXVkaXRfbG9ncywgZGFlbW9uPVRydWUpLnN0YXJ0KCkKICAgIAogICAgZGVmIGNoZWNrX3NlcnZlcl9zdGF0dXMoc2VsZik6CiAgICAgICAgIiIiQ2hlY2sgVnVsbkd1YXJkIHNlcnZlciBjb25uZWN0aXZpdHkiIiIKICAgICAgICBkZWYgY2hlY2soKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQoZiJ7c2VsZi5zZXJ2ZXJfdXJsfS9hcGkvIiwgdGltZW91dD01KQogICAgICAgICAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICAgICAgICAgIHNlbGYucXVldWUucHV0KCgnc2VydmVyX3N0YXR1cycsICdDb25uZWN0ZWQnLCAnZ3JlZW4nKSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5xdWV1ZS5wdXQoKCdzZXJ2ZXJfc3RhdHVzJywgJ0Vycm9yJywgJ3JlZCcpKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBzZWxmLnF1ZXVlLnB1dCgoJ3NlcnZlcl9zdGF0dXMnLCAnT2ZmbGluZScsICdyZWQnKSkKICAgICAgICAKICAgICAgICB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1jaGVjaywgZGFlbW9uPVRydWUpLnN0YXJ0KCkKICAgIAogICAgZGVmIGxvYWRfZGFzaGJvYXJkX2RhdGEoc2VsZik6CiAgICAgICAgIiIiTG9hZCBkYXNoYm9hcmQgc3RhdGlzdGljcyIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQoZiJ7c2VsZi5zZXJ2ZXJfdXJsfS9hcGkvZGFzaGJvYXJkL3N0YXRzIiwgdGltZW91dD0xMCkKICAgICAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICAgICAgZGF0YSA9IHJlc3BvbnNlLmpzb24oKQogICAgICAgICAgICAgICAgc2VsZi5xdWV1ZS5wdXQoKCdkYXNoYm9hcmRfZGF0YScsIGRhdGEpKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5xdWV1ZS5wdXQoKCdkYXNoYm9hcmRfZXJyb3InLCAnRmFpbGVkIHRvIGxvYWQgZGFzaGJvYXJkIGRhdGEnKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYucXVldWUucHV0KCgnZGFzaGJvYXJkX2Vycm9yJywgc3RyKGUpKSkKICAgIAogICAgZGVmIGxvYWRfYXNzZXRzKHNlbGYpOgogICAgICAgICIiIkxvYWQgYXNzZXRzIGRhdGEiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KGYie3NlbGYuc2VydmVyX3VybH0vYXBpL2Fzc2V0cyIsIHRpbWVvdXQ9MTApCiAgICAgICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgICAgIGFzc2V0cyA9IHJlc3BvbnNlLmpzb24oKQogICAgICAgICAgICAgICAgc2VsZi5xdWV1ZS5wdXQoKCdhc3NldHNfZGF0YScsIGFzc2V0cykpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLnF1ZXVlLnB1dCgoJ2Fzc2V0c19lcnJvcicsICdGYWlsZWQgdG8gbG9hZCBhc3NldHMnKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYucXVldWUucHV0KCgnYXNzZXRzX2Vycm9yJywgc3RyKGUpKSkKICAgIAogICAgZGVmIGxvYWRfZmluZGluZ3Moc2VsZik6CiAgICAgICAgIiIiTG9hZCBmaW5kaW5ncyBkYXRhIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldChmIntzZWxmLnNlcnZlcl91cmx9L2FwaS9maW5kaW5ncyIsIHRpbWVvdXQ9MTApCiAgICAgICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgICAgIGZpbmRpbmdzID0gcmVzcG9uc2UuanNvbigpCiAgICAgICAgICAgICAgICBzZWxmLnF1ZXVlLnB1dCgoJ2ZpbmRpbmdzX2RhdGEnLCBmaW5kaW5ncykpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLnF1ZXVlLnB1dCgoJ2ZpbmRpbmdzX2Vycm9yJywgJ0ZhaWxlZCB0byBsb2FkIGZpbmRpbmdzJykpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLnF1ZXVlLnB1dCgoJ2ZpbmRpbmdzX2Vycm9yJywgc3RyKGUpKSkKICAgIAogICAgZGVmIGxvYWRfYXVkaXRfbG9ncyhzZWxmKToKICAgICAgICAiIiJMb2FkIGF1ZGl0IGxvZ3MiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KGYie3NlbGYuc2VydmVyX3VybH0vYXBpL2F1ZGl0LWxvZ3M/bGltaXQ9MTAwIiwgdGltZW91dD0xMCkKICAgICAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICAgICAgbG9ncyA9IHJlc3BvbnNlLmpzb24oKQogICAgICAgICAgICAgICAgc2VsZi5xdWV1ZS5wdXQoKCdhdWRpdF9kYXRhJywgbG9ncykpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLnF1ZXVlLnB1dCgoJ2F1ZGl0X2Vycm9yJywgJ0ZhaWxlZCB0byBsb2FkIGF1ZGl0IGxvZ3MnKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYucXVldWUucHV0KCgnYXVkaXRfZXJyb3InLCBzdHIoZSkpKQogICAgCiAgICBkZWYgcHJvY2Vzc19xdWV1ZShzZWxmKToKICAgICAgICAiIiJQcm9jZXNzIG1lc3NhZ2VzIGZyb20gYmFja2dyb3VuZCB0aHJlYWRzIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICAgICAgbWVzc2FnZV90eXBlLCBkYXRhLCAqZXh0cmEgPSBzZWxmLnF1ZXVlLmdldF9ub3dhaXQoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBtZXNzYWdlX3R5cGUgPT0gJ3NlcnZlcl9zdGF0dXMnOgogICAgICAgICAgICAgICAgICAgIGNvbG9yID0gZXh0cmFbMF0gaWYgZXh0cmEgZWxzZSAnYmxhY2snCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zZXJ2ZXJfc3RhdHVzX2xhYmVsLmNvbmZpZyh0ZXh0PWRhdGEsIGZvcmVncm91bmQ9Y29sb3IpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGVsaWYgbWVzc2FnZV90eXBlID09ICdkYXNoYm9hcmRfZGF0YSc6CiAgICAgICAgICAgICAgICAgICAgc2VsZi51cGRhdGVfZGFzaGJvYXJkKGRhdGEpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGVsaWYgbWVzc2FnZV90eXBlID09ICdhc3NldHNfZGF0YSc6CiAgICAgICAgICAgICAgICAgICAgc2VsZi51cGRhdGVfYXNzZXRzX3RyZWUoZGF0YSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZWxpZiBtZXNzYWdlX3R5cGUgPT0gJ2ZpbmRpbmdzX2RhdGEnOgogICAgICAgICAgICAgICAgICAgIHNlbGYudXBkYXRlX2ZpbmRpbmdzX3RyZWUoZGF0YSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZWxpZiBtZXNzYWdlX3R5cGUgPT0gJ2F1ZGl0X2RhdGEnOgogICAgICAgICAgICAgICAgICAgIHNlbGYudXBkYXRlX2F1ZGl0X3RyZWUoZGF0YSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZWxpZiBtZXNzYWdlX3R5cGUuZW5kc3dpdGgoJ19lcnJvcicpOgogICAgICAgICAgICAgICAgICAgIHNlbGYuc2V0X3N0YXR1cyhmIkVycm9yOiB7ZGF0YX0iKQogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2Vycm9yKCJFcnJvciIsIGRhdGEpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgcXVldWUuRW1wdHk6CiAgICAgICAgICAgIHBhc3MKICAgICAgICAKICAgICAgICAjIFNjaGVkdWxlIG5leHQgY2hlY2sKICAgICAgICBzZWxmLnJvb3QuYWZ0ZXIoMTAwMCwgc2VsZi5wcm9jZXNzX3F1ZXVlKQogICAgCiAgICBkZWYgdXBkYXRlX2Rhc2hib2FyZChzZWxmLCBkYXRhKToKICAgICAgICAiIiJVcGRhdGUgZGFzaGJvYXJkIHdpdGggbG9hZGVkIGRhdGEiIiIKICAgICAgICAjIFRoaXMgd291bGQgdXBkYXRlIHRoZSBkYXNoYm9hcmQgd2lkZ2V0cyB3aXRoIHJlYWwgZGF0YQogICAgICAgIHNlbGYuc2V0X3N0YXR1cygiRGFzaGJvYXJkIGxvYWRlZCBzdWNjZXNzZnVsbHkiKQogICAgCiAgICBkZWYgdXBkYXRlX2Fzc2V0c190cmVlKHNlbGYsIGFzc2V0cyk6CiAgICAgICAgIiIiVXBkYXRlIGFzc2V0cyB0cmVldmlldyIiIgogICAgICAgICMgQ2xlYXIgZXhpc3RpbmcgaXRlbXMKICAgICAgICBmb3IgaXRlbSBpbiBzZWxmLmFzc2V0c190cmVlLmdldF9jaGlsZHJlbigpOgogICAgICAgICAgICBzZWxmLmFzc2V0c190cmVlLmRlbGV0ZShpdGVtKQogICAgICAgIAogICAgICAgICMgQWRkIG5ldyBpdGVtcwogICAgICAgIGZvciBhc3NldCBpbiBhc3NldHM6CiAgICAgICAgICAgIHNlbGYuYXNzZXRzX3RyZWUuaW5zZXJ0KCcnLCAnZW5kJywgdmFsdWVzPSgKICAgICAgICAgICAgICAgIGFzc2V0LmdldCgnaG9zdG5hbWUnLCAnJyksCiAgICAgICAgICAgICAgICBhc3NldC5nZXQoJ2lwX2FkZHJlc3MnLCAnJyksCiAgICAgICAgICAgICAgICBhc3NldC5nZXQoJ2Fzc2V0X3R5cGUnLCAnJyksCiAgICAgICAgICAgICAgICBhc3NldC5nZXQoJ2Vudmlyb25tZW50JywgJycpLAogICAgICAgICAgICAgICAgYXNzZXQuZ2V0KCdjcml0aWNhbGl0eScsICcnKSwKICAgICAgICAgICAgICAgIGFzc2V0LmdldCgnb3duZXInLCAnJykKICAgICAgICAgICAgKSkKICAgICAgICAKICAgICAgICBzZWxmLnNldF9zdGF0dXMoZiJMb2FkZWQge2xlbihhc3NldHMpfSBhc3NldHMiKQogICAgCiAgICBkZWYgdXBkYXRlX2ZpbmRpbmdzX3RyZWUoc2VsZiwgZmluZGluZ3MpOgogICAgICAgICIiIlVwZGF0ZSBmaW5kaW5ncyB0cmVldmlldyIiIgogICAgICAgICMgQ2xlYXIgZXhpc3RpbmcgaXRlbXMKICAgICAgICBmb3IgaXRlbSBpbiBzZWxmLmZpbmRpbmdzX3RyZWUuZ2V0X2NoaWxkcmVuKCk6CiAgICAgICAgICAgIHNlbGYuZmluZGluZ3NfdHJlZS5kZWxldGUoaXRlbSkKICAgICAgICAKICAgICAgICAjIEFkZCBuZXcgaXRlbXMKICAgICAgICBmb3IgZmluZGluZyBpbiBmaW5kaW5nczoKICAgICAgICAgICAgY3ZlX2lkcyA9ICcsICcuam9pbihmaW5kaW5nLmdldCgnY3ZlX2lkcycsIFtdKVs6Ml0pICAjIFNob3cgZmlyc3QgMiBDVkVzCiAgICAgICAgICAgIGZpcnN0X3NlZW4gPSBmaW5kaW5nLmdldCgnZmlyc3Rfc2VlbicsICcnKQogICAgICAgICAgICBpZiBmaXJzdF9zZWVuOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGZpcnN0X3NlZW4gPSBkYXRldGltZS5mcm9taXNvZm9ybWF0KGZpcnN0X3NlZW4ucmVwbGFjZSgnWicsICcrMDA6MDAnKSkuc3RyZnRpbWUoJyVZLSVtLSVkJykKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmZpbmRpbmdzX3RyZWUuaW5zZXJ0KCcnLCAnZW5kJywgdmFsdWVzPSgKICAgICAgICAgICAgICAgIGZpbmRpbmcuZ2V0KCd0aXRsZScsICcnKVs6NTBdLCAgIyBUcnVuY2F0ZSBsb25nIHRpdGxlcwogICAgICAgICAgICAgICAgZmluZGluZy5nZXQoJ3NldmVyaXR5JywgJycpLnVwcGVyKCksCiAgICAgICAgICAgICAgICBmaW5kaW5nLmdldCgnZmluZGluZ190eXBlJywgJycpLAogICAgICAgICAgICAgICAgZmluZGluZy5nZXQoJ2Fzc2V0X2lkJywgJycpWzoxMF0sICAjIFNob3cgZmlyc3QgMTAgY2hhcnMgb2YgYXNzZXQgSUQKICAgICAgICAgICAgICAgIGN2ZV9pZHMsCiAgICAgICAgICAgICAgICBmaXJzdF9zZWVuCiAgICAgICAgICAgICkpCiAgICAgICAgCiAgICAgICAgc2VsZi5zZXRfc3RhdHVzKGYiTG9hZGVkIHtsZW4oZmluZGluZ3MpfSBmaW5kaW5ncyIpCiAgICAKICAgIGRlZiB1cGRhdGVfYXVkaXRfdHJlZShzZWxmLCBsb2dzKToKICAgICAgICAiIiJVcGRhdGUgYXVkaXQgdHJhaWwgdHJlZXZpZXciIiIKICAgICAgICAjIENsZWFyIGV4aXN0aW5nIGl0ZW1zCiAgICAgICAgZm9yIGl0ZW0gaW4gc2VsZi5hdWRpdF90cmVlLmdldF9jaGlsZHJlbigpOgogICAgICAgICAgICBzZWxmLmF1ZGl0X3RyZWUuZGVsZXRlKGl0ZW0pCiAgICAgICAgCiAgICAgICAgIyBBZGQgbmV3IGl0ZW1zCiAgICAgICAgZm9yIGxvZyBpbiBsb2dzOgogICAgICAgICAgICB0aW1lc3RhbXAgPSBsb2cuZ2V0KCd0aW1lc3RhbXAnLCAnJykKICAgICAgICAgICAgaWYgdGltZXN0YW1wOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcCA9IGRhdGV0aW1lLmZyb21pc29mb3JtYXQodGltZXN0YW1wLnJlcGxhY2UoJ1onLCAnKzAwOjAwJykpLnN0cmZ0aW1lKCclWS0lbS0lZCAlSDolTTolUycpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5hdWRpdF90cmVlLmluc2VydCgnJywgJ2VuZCcsIHZhbHVlcz0oCiAgICAgICAgICAgICAgICB0aW1lc3RhbXAsCiAgICAgICAgICAgICAgICBsb2cuZ2V0KCd1c2VyX2lkJywgJycpLAogICAgICAgICAgICAgICAgbG9nLmdldCgnYWN0aW9uJywgJycpLAogICAgICAgICAgICAgICAgbG9nLmdldCgncmVzb3VyY2VfdHlwZScsICcnKSwKICAgICAgICAgICAgICAgIHN0cihsb2cuZ2V0KCdkZXRhaWxzJywge30pKVs6NTBdICAjIFRydW5jYXRlIGRldGFpbHMKICAgICAgICAgICAgKSkKICAgICAgICAKICAgICAgICBzZWxmLnNldF9zdGF0dXMoZiJMb2FkZWQge2xlbihsb2dzKX0gYXVkaXQgZW50cmllcyIpCiAgICAKICAgIGRlZiBhZGRfYXNzZXRfZGlhbG9nKHNlbGYpOgogICAgICAgICIiIlNob3cgYWRkIGFzc2V0IGRpYWxvZyIiIgogICAgICAgIGRpYWxvZyA9IHRrLlRvcGxldmVsKHNlbGYucm9vdCkKICAgICAgICBkaWFsb2cudGl0bGUoIkFkZCBOZXcgQXNzZXQiKQogICAgICAgIGRpYWxvZy5nZW9tZXRyeSgiNDAweDMwMCIpCiAgICAgICAgZGlhbG9nLnRyYW5zaWVudChzZWxmLnJvb3QpCiAgICAgICAgZGlhbG9nLmdyYWJfc2V0KCkKICAgICAgICAKICAgICAgICAjIENlbnRlciB0aGUgZGlhbG9nCiAgICAgICAgZGlhbG9nLmdlb21ldHJ5KCIrJWQrJWQiICUgKHNlbGYucm9vdC53aW5mb19yb290eCgpICsgNTAsIHNlbGYucm9vdC53aW5mb19yb290eSgpICsgNTApKQogICAgICAgIAogICAgICAgICMgRm9ybSBmaWVsZHMKICAgICAgICB0dGsuTGFiZWwoZGlhbG9nLCB0ZXh0PSJBc3NldCBEZXRhaWxzIiwgZm9udD0oJ0FyaWFsJywgMTQsICdib2xkJykpLnBhY2socGFkeT0xMCkKICAgICAgICAKICAgICAgICBmb3JtX2ZyYW1lID0gdHRrLkZyYW1lKGRpYWxvZykKICAgICAgICBmb3JtX2ZyYW1lLnBhY2soZmlsbD10ay5CT1RILCBleHBhbmQ9VHJ1ZSwgcGFkeD0yMCwgcGFkeT0xMCkKICAgICAgICAKICAgICAgICBmaWVsZHMgPSB7fQogICAgICAgIAogICAgICAgICMgSG9zdG5hbWUKICAgICAgICB0dGsuTGFiZWwoZm9ybV9mcmFtZSwgdGV4dD0iSG9zdG5hbWU6IikuZ3JpZChyb3c9MCwgY29sdW1uPTAsIHN0aWNreT10ay5XLCBwYWR5PTUpCiAgICAgICAgZmllbGRzWydob3N0bmFtZSddID0gdHRrLkVudHJ5KGZvcm1fZnJhbWUsIHdpZHRoPTMwKQogICAgICAgIGZpZWxkc1snaG9zdG5hbWUnXS5ncmlkKHJvdz0wLCBjb2x1bW49MSwgcGFkeT01LCBwYWR4PSgxMCwgMCkpCiAgICAgICAgCiAgICAgICAgIyBJUCBBZGRyZXNzCiAgICAgICAgdHRrLkxhYmVsKGZvcm1fZnJhbWUsIHRleHQ9IklQIEFkZHJlc3M6IikuZ3JpZChyb3c9MSwgY29sdW1uPTAsIHN0aWNreT10ay5XLCBwYWR5PTUpCiAgICAgICAgZmllbGRzWydpcF9hZGRyZXNzJ10gPSB0dGsuRW50cnkoZm9ybV9mcmFtZSwgd2lkdGg9MzApCiAgICAgICAgZmllbGRzWydpcF9hZGRyZXNzJ10uZ3JpZChyb3c9MSwgY29sdW1uPTEsIHBhZHk9NSwgcGFkeD0oMTAsIDApKQogICAgICAgIAogICAgICAgICMgQXNzZXQgVHlwZQogICAgICAgIHR0ay5MYWJlbChmb3JtX2ZyYW1lLCB0ZXh0PSJBc3NldCBUeXBlOiIpLmdyaWQocm93PTIsIGNvbHVtbj0wLCBzdGlja3k9dGsuVywgcGFkeT01KQogICAgICAgIGZpZWxkc1snYXNzZXRfdHlwZSddID0gdHRrLkNvbWJvYm94KGZvcm1fZnJhbWUsIHZhbHVlcz1bJ3NlcnZlcicsICd3b3Jrc3RhdGlvbicsICduZXR3b3JrX2RldmljZScsICdkYXRhYmFzZSddLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlPSdyZWFkb25seScsIHdpZHRoPTI4KQogICAgICAgIGZpZWxkc1snYXNzZXRfdHlwZSddLnNldCgnc2VydmVyJykKICAgICAgICBmaWVsZHNbJ2Fzc2V0X3R5cGUnXS5ncmlkKHJvdz0yLCBjb2x1bW49MSwgcGFkeT01LCBwYWR4PSgxMCwgMCkpCiAgICAgICAgCiAgICAgICAgIyBFbnZpcm9ubWVudAogICAgICAgIHR0ay5MYWJlbChmb3JtX2ZyYW1lLCB0ZXh0PSJFbnZpcm9ubWVudDoiKS5ncmlkKHJvdz0zLCBjb2x1bW49MCwgc3RpY2t5PXRrLlcsIHBhZHk9NSkKICAgICAgICBmaWVsZHNbJ2Vudmlyb25tZW50J10gPSB0dGsuQ29tYm9ib3goZm9ybV9mcmFtZSwgdmFsdWVzPVsncHJvZHVjdGlvbicsICdzdGFnaW5nJywgJ2RldmVsb3BtZW50J10sIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGU9J3JlYWRvbmx5Jywgd2lkdGg9MjgpCiAgICAgICAgZmllbGRzWydlbnZpcm9ubWVudCddLnNldCgncHJvZHVjdGlvbicpCiAgICAgICAgZmllbGRzWydlbnZpcm9ubWVudCddLmdyaWQocm93PTMsIGNvbHVtbj0xLCBwYWR5PTUsIHBhZHg9KDEwLCAwKSkKICAgICAgICAKICAgICAgICAjIE93bmVyCiAgICAgICAgdHRrLkxhYmVsKGZvcm1fZnJhbWUsIHRleHQ9Ik93bmVyOiIpLmdyaWQocm93PTQsIGNvbHVtbj0wLCBzdGlja3k9dGsuVywgcGFkeT01KQogICAgICAgIGZpZWxkc1snb3duZXInXSA9IHR0ay5FbnRyeShmb3JtX2ZyYW1lLCB3aWR0aD0zMCkKICAgICAgICBmaWVsZHNbJ293bmVyJ10uZ3JpZChyb3c9NCwgY29sdW1uPTEsIHBhZHk9NSwgcGFkeD0oMTAsIDApKQogICAgICAgIAogICAgICAgICMgQnV0dG9ucwogICAgICAgIGJ1dHRvbl9mcmFtZSA9IHR0ay5GcmFtZShkaWFsb2cpCiAgICAgICAgYnV0dG9uX2ZyYW1lLnBhY2socGFkeT0xMCkKICAgICAgICAKICAgICAgICBkZWYgY3JlYXRlX2Fzc2V0KCk6CiAgICAgICAgICAgICMgVmFsaWRhdGUgcmVxdWlyZWQgZmllbGRzCiAgICAgICAgICAgIGlmIG5vdCBmaWVsZHNbJ2hvc3RuYW1lJ10uZ2V0KCkuc3RyaXAoKToKICAgICAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2Vycm9yKCJFcnJvciIsICJIb3N0bmFtZSBpcyByZXF1aXJlZCIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgICMgUHJlcGFyZSBhc3NldCBkYXRhCiAgICAgICAgICAgIGFzc2V0X2RhdGEgPSB7CiAgICAgICAgICAgICAgICAnaG9zdG5hbWUnOiBmaWVsZHNbJ2hvc3RuYW1lJ10uZ2V0KCkuc3RyaXAoKSwKICAgICAgICAgICAgICAgICdpcF9hZGRyZXNzJzogZmllbGRzWydpcF9hZGRyZXNzJ10uZ2V0KCkuc3RyaXAoKSBvciBOb25lLAogICAgICAgICAgICAgICAgJ2Fzc2V0X3R5cGUnOiBmaWVsZHNbJ2Fzc2V0X3R5cGUnXS5nZXQoKSwKICAgICAgICAgICAgICAgICdlbnZpcm9ubWVudCc6IGZpZWxkc1snZW52aXJvbm1lbnQnXS5nZXQoKSwKICAgICAgICAgICAgICAgICdvd25lcic6IGZpZWxkc1snb3duZXInXS5nZXQoKS5zdHJpcCgpIG9yIE5vbmUsCiAgICAgICAgICAgICAgICAnY3JpdGljYWxpdHknOiAzICAjIERlZmF1bHQgY3JpdGljYWxpdHkKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZW1vdmUgTm9uZSB2YWx1ZXMKICAgICAgICAgICAgYXNzZXRfZGF0YSA9IHtrOiB2IGZvciBrLCB2IGluIGFzc2V0X2RhdGEuaXRlbXMoKSBpZiB2IGlzIG5vdCBOb25lfQogICAgICAgICAgICAKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5wb3N0KGYie3NlbGYuc2VydmVyX3VybH0vYXBpL2Fzc2V0cyIsIGpzb249YXNzZXRfZGF0YSwgdGltZW91dD0xMCkKICAgICAgICAgICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlYm94LnNob3dpbmZvKCJTdWNjZXNzIiwgIkFzc2V0IGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5IikKICAgICAgICAgICAgICAgICAgICBkaWFsb2cuZGVzdHJveSgpCiAgICAgICAgICAgICAgICAgICAgIyBSZWZyZXNoIGFzc2V0cyB2aWV3IGlmIGN1cnJlbnRseSBkaXNwbGF5ZWQKICAgICAgICAgICAgICAgICAgICB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1zZWxmLmxvYWRfYXNzZXRzLCBkYWVtb249VHJ1ZSkuc3RhcnQoKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlYm94LnNob3dlcnJvcigiRXJyb3IiLCBmIkZhaWxlZCB0byBjcmVhdGUgYXNzZXQ6IHtyZXNwb25zZS50ZXh0fSIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2Vycm9yKCJFcnJvciIsIGYiRmFpbGVkIHRvIGNyZWF0ZSBhc3NldDoge3N0cihlKX0iKQogICAgICAgIAogICAgICAgIHR0ay5CdXR0b24oYnV0dG9uX2ZyYW1lLCB0ZXh0PSJDcmVhdGUiLCBjb21tYW5kPWNyZWF0ZV9hc3NldCkucGFjayhzaWRlPXRrLlJJR0hUKQogICAgICAgIHR0ay5CdXR0b24oYnV0dG9uX2ZyYW1lLCB0ZXh0PSJDYW5jZWwiLCBjb21tYW5kPWRpYWxvZy5kZXN0cm95KS5wYWNrKHNpZGU9dGsuUklHSFQsIHBhZHg9KDAsIDEwKSkKICAgIAogICAgZGVmIHN0YXJ0X25ldHdvcmtfc2NhbihzZWxmKToKICAgICAgICAiIiJTaG93IG5ldHdvcmsgc2NhbiBkaWFsb2ciIiIKICAgICAgICBkaWFsb2cgPSB0ay5Ub3BsZXZlbChzZWxmLnJvb3QpCiAgICAgICAgZGlhbG9nLnRpdGxlKCJTdGFydCBOZXR3b3JrIFNjYW4iKQogICAgICAgIGRpYWxvZy5nZW9tZXRyeSgiNTAweDMwMCIpCiAgICAgICAgZGlhbG9nLnRyYW5zaWVudChzZWxmLnJvb3QpCiAgICAgICAgZGlhbG9nLmdyYWJfc2V0KCkKICAgICAgICAKICAgICAgICAjIENlbnRlciB0aGUgZGlhbG9nCiAgICAgICAgZGlhbG9nLmdlb21ldHJ5KCIrJWQrJWQiICUgKHNlbGYucm9vdC53aW5mb19yb290eCgpICsgNTAsIHNlbGYucm9vdC53aW5mb19yb290eSgpICsgNTApKQogICAgICAgIAogICAgICAgIHR0ay5MYWJlbChkaWFsb2csIHRleHQ9Ik5ldHdvcmsgVnVsbmVyYWJpbGl0eSBTY2FuIiwgZm9udD0oJ0FyaWFsJywgMTQsICdib2xkJykpLnBhY2socGFkeT0xMCkKICAgICAgICAKICAgICAgICBmb3JtX2ZyYW1lID0gdHRrLkZyYW1lKGRpYWxvZykKICAgICAgICBmb3JtX2ZyYW1lLnBhY2soZmlsbD10ay5CT1RILCBleHBhbmQ9VHJ1ZSwgcGFkeD0yMCwgcGFkeT0xMCkKICAgICAgICAKICAgICAgICAjIFNjYW4gbmFtZQogICAgICAgIHR0ay5MYWJlbChmb3JtX2ZyYW1lLCB0ZXh0PSJTY2FuIE5hbWU6IikucGFjayhhbmNob3I9dGsuVywgcGFkeT0oMCwgNSkpCiAgICAgICAgc2Nhbl9uYW1lX2VudHJ5ID0gdHRrLkVudHJ5KGZvcm1fZnJhbWUsIHdpZHRoPTUwKQogICAgICAgIHNjYW5fbmFtZV9lbnRyeS5wYWNrKGZpbGw9dGsuWCwgcGFkeT0oMCwgMTApKQogICAgICAgIHNjYW5fbmFtZV9lbnRyeS5pbnNlcnQoMCwgZiJEZXNrdG9wIFNjYW4ge2RhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCclWSVtJWRfJUglTSVTJyl9IikKICAgICAgICAKICAgICAgICAjIFRhcmdldHMKICAgICAgICB0dGsuTGFiZWwoZm9ybV9mcmFtZSwgdGV4dD0iVGFyZ2V0cyAoY29tbWEtc2VwYXJhdGVkKToiKS5wYWNrKGFuY2hvcj10ay5XLCBwYWR5PSgwLCA1KSkKICAgICAgICB0YXJnZXRzX3RleHQgPSB0ay5UZXh0KGZvcm1fZnJhbWUsIGhlaWdodD01LCB3aWR0aD01MCkKICAgICAgICB0YXJnZXRzX3RleHQucGFjayhmaWxsPXRrLlgsIHBhZHk9KDAsIDEwKSkKICAgICAgICB0YXJnZXRzX3RleHQuaW5zZXJ0KCcxLjAnLCAnMTkyLjE2OC4xLjAvMjQsIDEwLjAuMC4xLTEwLjAuMC41MCcpCiAgICAgICAgCiAgICAgICAgIyBPcHRpb25zCiAgICAgICAgb3B0aW9uc19mcmFtZSA9IHR0ay5GcmFtZShmb3JtX2ZyYW1lKQogICAgICAgIG9wdGlvbnNfZnJhbWUucGFjayhmaWxsPXRrLlgsIHBhZHk9KDAsIDEwKSkKICAgICAgICAKICAgICAgICBpbmNsdWRlX21pc2NvbmZpZ3MgPSB0ay5Cb29sZWFuVmFyKHZhbHVlPVRydWUpCiAgICAgICAgdHRrLkNoZWNrYnV0dG9uKG9wdGlvbnNfZnJhbWUsIHRleHQ9IkluY2x1ZGUgbWlzY29uZmlndXJhdGlvbiBkZXRlY3Rpb24iLCAKICAgICAgICAgICAgICAgICAgICAgICB2YXJpYWJsZT1pbmNsdWRlX21pc2NvbmZpZ3MpLnBhY2soYW5jaG9yPXRrLlcpCiAgICAgICAgCiAgICAgICAgIyBCdXR0b25zCiAgICAgICAgYnV0dG9uX2ZyYW1lID0gdHRrLkZyYW1lKGRpYWxvZykKICAgICAgICBidXR0b25fZnJhbWUucGFjayhwYWR5PTEwKQogICAgICAgIAogICAgICAgIGRlZiBzdGFydF9zY2FuKCk6CiAgICAgICAgICAgIHRhcmdldHMgPSBbdC5zdHJpcCgpIGZvciB0IGluIHRhcmdldHNfdGV4dC5nZXQoJzEuMCcsIHRrLkVORCkuc3RyaXAoKS5zcGxpdCgnLCcpXQogICAgICAgICAgICBzY2FuX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAndGFyZ2V0cyc6IHRhcmdldHMsCiAgICAgICAgICAgICAgICAnc2Nhbl9uYW1lJzogc2Nhbl9uYW1lX2VudHJ5LmdldCgpLAogICAgICAgICAgICAgICAgJ2luY2x1ZGVfbWlzY29uZmlncyc6IGluY2x1ZGVfbWlzY29uZmlncy5nZXQoKQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLnBvc3QoZiJ7c2VsZi5zZXJ2ZXJfdXJsfS9hcGkvc2Nhbi9uZXR3b3JrIiwganNvbj1zY2FuX2RhdGEsIHRpbWVvdXQ9MzApCiAgICAgICAgICAgICAgICBpZiByZXNwb25zZS5zdGF0dXNfY29kZSA9PSAyMDA6CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gcmVzcG9uc2UuanNvbigpCiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZWJveC5zaG93aW5mbygiU3VjY2VzcyIsIAogICAgICAgICAgICAgICAgICAgICAgICBmIk5ldHdvcmsgc2NhbiBzdGFydGVkIHN1Y2Nlc3NmdWxseSFcbiIKICAgICAgICAgICAgICAgICAgICAgICAgZiJTY2FuIElEOiB7cmVzdWx0LmdldCgnc2Nhbl9pZCcpfVxuIgogICAgICAgICAgICAgICAgICAgICAgICBmIkZpbmRpbmdzOiB7cmVzdWx0LmdldCgnZmluZGluZ3NfY291bnQnLCAwKX1cbiIKICAgICAgICAgICAgICAgICAgICAgICAgZiJNaXNjb25maWd1cmF0aW9uczoge3Jlc3VsdC5nZXQoJ21pc2NvbmZpZ3VyYXRpb25zJywgMCl9IikKICAgICAgICAgICAgICAgICAgICBkaWFsb2cuZGVzdHJveSgpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2Vycm9yKCJFcnJvciIsIGYiRmFpbGVkIHRvIHN0YXJ0IHNjYW46IHtyZXNwb25zZS50ZXh0fSIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2Vycm9yKCJFcnJvciIsIGYiRmFpbGVkIHRvIHN0YXJ0IHNjYW46IHtzdHIoZSl9IikKICAgICAgICAKICAgICAgICB0dGsuQnV0dG9uKGJ1dHRvbl9mcmFtZSwgdGV4dD0iU3RhcnQgU2NhbiIsIGNvbW1hbmQ9c3RhcnRfc2NhbikucGFjayhzaWRlPXRrLlJJR0hUKQogICAgICAgIHR0ay5CdXR0b24oYnV0dG9uX2ZyYW1lLCB0ZXh0PSJDYW5jZWwiLCBjb21tYW5kPWRpYWxvZy5kZXN0cm95KS5wYWNrKHNpZGU9dGsuUklHSFQsIHBhZHg9KDAsIDEwKSkKICAgIAogICAgZGVmIHVwbG9hZF9zY2FuX2ZpbGUoc2VsZik6CiAgICAgICAgIiIiVXBsb2FkIHNjYW4gZmlsZSIiIgogICAgICAgIGZpbGVfcGF0aCA9IGZpbGVkaWFsb2cuYXNrb3BlbmZpbGVuYW1lKAogICAgICAgICAgICB0aXRsZT0iU2VsZWN0IFNjYW4gRmlsZSIsCiAgICAgICAgICAgIGZpbGV0eXBlcz1bCiAgICAgICAgICAgICAgICAoIkpTT04gZmlsZXMiLCAiKi5qc29uIiksCiAgICAgICAgICAgICAgICAoIlhNTCBmaWxlcyIsICIqLnhtbCIpLAogICAgICAgICAgICAgICAgKCJDU1YgZmlsZXMiLCAiKi5jc3YiKSwKICAgICAgICAgICAgICAgICgiQWxsIGZpbGVzIiwgIiouKiIpCiAgICAgICAgICAgIF0KICAgICAgICApCiAgICAgICAgCiAgICAgICAgaWYgZmlsZV9wYXRoOgogICAgICAgICAgICAjIEZvciBub3csIGp1c3Qgc2hvdyBhIG1lc3NhZ2UKICAgICAgICAgICAgbWVzc2FnZWJveC5zaG93aW5mbygiRmlsZSBTZWxlY3RlZCIsIGYiU2VsZWN0ZWQgZmlsZToge2ZpbGVfcGF0aH1cblxuRmlsZSB1cGxvYWQgZnVuY3Rpb25hbGl0eSB3b3VsZCBwcm9jZXNzIHRoaXMgZmlsZS4iKQogICAgCiAgICBkZWYgZmlsdGVyX2ZpbmRpbmdzKHNlbGYpOgogICAgICAgICIiIkZpbHRlciBmaW5kaW5ncyBiYXNlZCBvbiBzZWxlY3RlZCBjcml0ZXJpYSIiIgogICAgICAgICMgVGhpcyB3b3VsZCBmaWx0ZXIgdGhlIGZpbmRpbmdzIHRyZWUgYmFzZWQgb24gc2VsZWN0ZWQgY3JpdGVyaWEKICAgICAgICBtZXNzYWdlYm94LnNob3dpbmZvKCJGaWx0ZXIiLCAiRmlsdGVyaW5nIGZ1bmN0aW9uYWxpdHkgd291bGQgYmUgaW1wbGVtZW50ZWQgaGVyZSIpCiAgICAKICAgIGRlZiBzaG93X2ZpbmRpbmdfZGV0YWlscyhzZWxmLCBldmVudCk6CiAgICAgICAgIiIiU2hvdyBkZXRhaWxlZCBpbmZvcm1hdGlvbiBhYm91dCBzZWxlY3RlZCBmaW5kaW5nIiIiCiAgICAgICAgc2VsZWN0aW9uID0gc2VsZi5maW5kaW5nc190cmVlLnNlbGVjdGlvbigpCiAgICAgICAgaWYgc2VsZWN0aW9uOgogICAgICAgICAgICBpdGVtID0gc2VsZi5maW5kaW5nc190cmVlLml0ZW0oc2VsZWN0aW9uWzBdKQogICAgICAgICAgICB2YWx1ZXMgPSBpdGVtWyd2YWx1ZXMnXQogICAgICAgICAgICBtZXNzYWdlYm94LnNob3dpbmZvKCJGaW5kaW5nIERldGFpbHMiLCAKICAgICAgICAgICAgICAgIGYiVGl0bGU6IHt2YWx1ZXNbMF19XG4iCiAgICAgICAgICAgICAgICBmIlNldmVyaXR5OiB7dmFsdWVzWzFdfVxuIgogICAgICAgICAgICAgICAgZiJUeXBlOiB7dmFsdWVzWzJdfVxuIgogICAgICAgICAgICAgICAgZiJBc3NldDoge3ZhbHVlc1szXX1cbiIKICAgICAgICAgICAgICAgIGYiQ1ZFIElEczoge3ZhbHVlc1s0XX0iKQogICAgCiAgICBkZWYgcnVuX2FnZW50X3NjYW4oc2VsZik6CiAgICAgICAgIiIiUnVuIGxvY2FsIGFnZW50IHNjYW4iIiIKICAgICAgICBtZXNzYWdlYm94LnNob3dpbmZvKCJBZ2VudCBTY2FuIiwgIlRoaXMgd291bGQgcnVuIHRoZSBWdWxuR3VhcmQgYWdlbnQgb24gdGhlIGxvY2FsIG1hY2hpbmUiKQogICAgCiAgICBkZWYgZXhwb3J0X3JlcG9ydChzZWxmKToKICAgICAgICAiIiJFeHBvcnQgc2VjdXJpdHkgcmVwb3J0IiIiCiAgICAgICAgZmlsZV9wYXRoID0gZmlsZWRpYWxvZy5hc2tzYXZlYXNmaWxlbmFtZSgKICAgICAgICAgICAgdGl0bGU9IlNhdmUgUmVwb3J0IiwKICAgICAgICAgICAgZGVmYXVsdGV4dGVuc2lvbj0iLmpzb24iLAogICAgICAgICAgICBmaWxldHlwZXM9WwogICAgICAgICAgICAgICAgKCJKU09OIGZpbGVzIiwgIiouanNvbiIpLAogICAgICAgICAgICAgICAgKCJQREYgZmlsZXMiLCAiKi5wZGYiKSwKICAgICAgICAgICAgICAgICgiQ1NWIGZpbGVzIiwgIiouY3N2IikKICAgICAgICAgICAgXQogICAgICAgICkKICAgICAgICAKICAgICAgICBpZiBmaWxlX3BhdGg6CiAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2luZm8oIkV4cG9ydCIsIGYiUmVwb3J0IHdvdWxkIGJlIGV4cG9ydGVkIHRvOiB7ZmlsZV9wYXRofSIpCiAgICAKICAgIGRlZiBzaG93X3NldHRpbmdzKHNlbGYpOgogICAgICAgICIiIlNob3cgc2V0dGluZ3MgZGlhbG9nIiIiCiAgICAgICAgZGlhbG9nID0gdGsuVG9wbGV2ZWwoc2VsZi5yb290KQogICAgICAgIGRpYWxvZy50aXRsZSgiU2V0dGluZ3MiKQogICAgICAgIGRpYWxvZy5nZW9tZXRyeSgiNDAweDI1MCIpCiAgICAgICAgZGlhbG9nLnRyYW5zaWVudChzZWxmLnJvb3QpCiAgICAgICAgZGlhbG9nLmdyYWJfc2V0KCkKICAgICAgICAKICAgICAgICB0dGsuTGFiZWwoZGlhbG9nLCB0ZXh0PSJWdWxuR3VhcmQgU2V0dGluZ3MiLCBmb250PSgnQXJpYWwnLCAxNCwgJ2JvbGQnKSkucGFjayhwYWR5PTEwKQogICAgICAgIAogICAgICAgIHNldHRpbmdzX2ZyYW1lID0gdHRrLkZyYW1lKGRpYWxvZykKICAgICAgICBzZXR0aW5nc19mcmFtZS5wYWNrKGZpbGw9dGsuQk9USCwgZXhwYW5kPVRydWUsIHBhZHg9MjAsIHBhZHk9MTApCiAgICAgICAgCiAgICAgICAgIyBTZXJ2ZXIgVVJMCiAgICAgICAgdHRrLkxhYmVsKHNldHRpbmdzX2ZyYW1lLCB0ZXh0PSJTZXJ2ZXIgVVJMOiIpLnBhY2soYW5jaG9yPXRrLlcsIHBhZHk9KDAsIDUpKQogICAgICAgIHNlcnZlcl9lbnRyeSA9IHR0ay5FbnRyeShzZXR0aW5nc19mcmFtZSwgd2lkdGg9NTApCiAgICAgICAgc2VydmVyX2VudHJ5LnBhY2soZmlsbD10ay5YLCBwYWR5PSgwLCAxMCkpCiAgICAgICAgc2VydmVyX2VudHJ5Lmluc2VydCgwLCBzZWxmLnNlcnZlcl91cmwpCiAgICAgICAgCiAgICAgICAgIyBBUEkgS2V5CiAgICAgICAgdHRrLkxhYmVsKHNldHRpbmdzX2ZyYW1lLCB0ZXh0PSJBUEkgS2V5OiIpLnBhY2soYW5jaG9yPXRrLlcsIHBhZHk9KDAsIDUpKQogICAgICAgIGFwaV9rZXlfZW50cnkgPSB0dGsuRW50cnkoc2V0dGluZ3NfZnJhbWUsIHdpZHRoPTUwLCBzaG93PSIqIikKICAgICAgICBhcGlfa2V5X2VudHJ5LnBhY2soZmlsbD10ay5YLCBwYWR5PSgwLCAxMCkpCiAgICAgICAgYXBpX2tleV9lbnRyeS5pbnNlcnQoMCwgc2VsZi5hcGlfa2V5KQogICAgICAgIAogICAgICAgICMgQnV0dG9ucwogICAgICAgIGJ1dHRvbl9mcmFtZSA9IHR0ay5GcmFtZShkaWFsb2cpCiAgICAgICAgYnV0dG9uX2ZyYW1lLnBhY2socGFkeT0xMCkKICAgICAgICAKICAgICAgICBkZWYgc2F2ZV9zZXR0aW5ncygpOgogICAgICAgICAgICBzZWxmLnNlcnZlcl91cmwgPSBzZXJ2ZXJfZW50cnkuZ2V0KCkKICAgICAgICAgICAgc2VsZi5hcGlfa2V5ID0gYXBpX2tleV9lbnRyeS5nZXQoKQogICAgICAgICAgICBtZXNzYWdlYm94LnNob3dpbmZvKCJTZXR0aW5ncyIsICJTZXR0aW5ncyBzYXZlZCBzdWNjZXNzZnVsbHkiKQogICAgICAgICAgICBkaWFsb2cuZGVzdHJveSgpCiAgICAgICAgICAgICMgUmVjaGVjayBzZXJ2ZXIgc3RhdHVzCiAgICAgICAgICAgIHNlbGYuY2hlY2tfc2VydmVyX3N0YXR1cygpCiAgICAgICAgCiAgICAgICAgdHRrLkJ1dHRvbihidXR0b25fZnJhbWUsIHRleHQ9IlNhdmUiLCBjb21tYW5kPXNhdmVfc2V0dGluZ3MpLnBhY2soc2lkZT10ay5SSUdIVCkKICAgICAgICB0dGsuQnV0dG9uKGJ1dHRvbl9mcmFtZSwgdGV4dD0iQ2FuY2VsIiwgY29tbWFuZD1kaWFsb2cuZGVzdHJveSkucGFjayhzaWRlPXRrLlJJR0hULCBwYWR4PSgwLCAxMCkpCiAgICAKICAgIGRlZiBzaG93X2Fib3V0KHNlbGYpOgogICAgICAgICIiIlNob3cgYWJvdXQgZGlhbG9nIiIiCiAgICAgICAgbWVzc2FnZWJveC5zaG93aW5mbygiQWJvdXQgVnVsbkd1YXJkIiwgCiAgICAgICAgICAgICJWdWxuR3VhcmQgRGVza3RvcCB2Mi4wXG5cbiIKICAgICAgICAgICAgIkNvbXByZWhlbnNpdmUgdnVsbmVyYWJpbGl0eSBtYW5hZ2VtZW50IHBsYXRmb3JtXG4iCiAgICAgICAgICAgICJ3aXRoIEFJLXBvd2VyZWQgYW5hbHlzaXMgYW5kIEFuc2libGUgcmVtZWRpYXRpb25cblxuIgogICAgICAgICAgICAiRmVhdHVyZXM6XG4iCiAgICAgICAgICAgICLigKIgQXNzZXQgaW52ZW50b3J5IG1hbmFnZW1lbnRcbiIKICAgICAgICAgICAgIuKAoiBWdWxuZXJhYmlsaXR5IGFuZCBtaXNjb25maWd1cmF0aW9uIHNjYW5uaW5nXG4iCiAgICAgICAgICAgICLigKIgQ3Jvc3MtaG9zdCB2dWxuZXJhYmlsaXR5IGFuYWx5c2lzXG4iCiAgICAgICAgICAgICLigKIgQUktcG93ZXJlZCByZW1lZGlhdGlvbiB3aXRoIEFuc2libGVcbiIKICAgICAgICAgICAgIuKAoiBDaGFuZ2UgbWFuYWdlbWVudCB3b3JrZmxvd3NcbiIKICAgICAgICAgICAgIuKAoiBDb21wcmVoZW5zaXZlIGF1ZGl0IHRyYWlsc1xuXG4iCiAgICAgICAgICAgICJCdWlsdCB3aXRoIFB5dGhvbiBhbmQgdGtpbnRlciIpCiAgICAKICAgIGRlZiB1cGRhdGVfc2Nhbl9oaXN0b3J5KHNlbGYsIG1lc3NhZ2UpOgogICAgICAgICIiIlVwZGF0ZSBzY2FuIGhpc3RvcnkgZGlzcGxheSIiIgogICAgICAgIHNlbGYuc2Nhbl9oaXN0b3J5X3RleHQuY29uZmlnKHN0YXRlPSdub3JtYWwnKQogICAgICAgIHNlbGYuc2Nhbl9oaXN0b3J5X3RleHQuaW5zZXJ0KCcxLjAnLCBmIntkYXRldGltZS5ub3coKS5zdHJmdGltZSgnJVktJW0tJWQgJUg6JU06JVMnKX0gLSB7bWVzc2FnZX1cbiIpCiAgICAgICAgc2VsZi5zY2FuX2hpc3RvcnlfdGV4dC5jb25maWcoc3RhdGU9J2Rpc2FibGVkJykKCmRlZiBtYWluKCk6CiAgICByb290ID0gdGsuVGsoKQogICAgYXBwID0gVnVsbkd1YXJkRGVza3RvcChyb290KQogICAgCiAgICB0cnk6CiAgICAgICAgcm9vdC5tYWlubG9vcCgpCiAgICBleGNlcHQgS2V5Ym9hcmRJbnRlcnJ1cHQ6CiAgICAgICAgcHJpbnQoIkFwcGxpY2F0aW9uIHRlcm1pbmF0ZWQgYnkgdXNlciIpCgppZiBfX25hbWVfXyA9PSAnX19tYWluX18nOgogICAgbWFpbigp > "%TEMP%\vulnguard_code.b64"
python -c "import base64; exec(base64.b64decode(open('%TEMP%\\vulnguard_code.b64').read().strip()).decode())" %*

REM Cleanup
if exist "%TEMP%\vulnguard_code.b64" del "%TEMP%\vulnguard_code.b64"
if exist "%TEMP_SCRIPT%" del "%TEMP_SCRIPT%"
