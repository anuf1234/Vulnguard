@echo off
REM VulnGuard Command Line Interface
REM VulnGuard Security Platform v2.0

REM Check if Python is installed
python --version >nul 2>&1
if errorlevel 1 (
    echo.
    echo ERROR: Python is required but not installed.
    echo Please install Python 3.8+ from https://python.org
    echo.
    pause
    exit /b 1
)

REM Check and install dependencies
python -c "import requests" >nul 2>&1
if errorlevel 1 (
    echo Installing required dependencies...
    python -m pip install --quiet requests psutil pymongo fastapi uvicorn motor python-dotenv pydantic python-multipart
)

REM Get the directory where this script is located
set SCRIPT_DIR=%~dp0

REM Create temporary Python script
set TEMP_SCRIPT=%TEMP%\vulnguard_cli.py

REM Write the Python code to temp file (base64 encoded to handle special characters)
echo IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwoiIiIKVnVsbkd1YXJkIENMSSBUb29sCkNvbW1hbmQtbGluZSBpbnRlcmZhY2UgZm9yIFZ1bG5HdWFyZCB2dWxuZXJhYmlsaXR5IG1hbmFnZW1lbnQKU3VwcG9ydHMgYXV0b21hdGlvbiwgQ0kvQ0QgaW50ZWdyYXRpb24sIGFuZCBiYXRjaCBvcGVyYXRpb25zCiIiIgoKaW1wb3J0IG9zCmltcG9ydCBzeXMKaW1wb3J0IGpzb24KaW1wb3J0IHJlcXVlc3RzCmltcG9ydCBhcmdwYXJzZQppbXBvcnQgdGltZQpmcm9tIHBhdGhsaWIgaW1wb3J0IFBhdGgKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IGxvZ2dpbmcKCiMgQ29uZmlndXJlIGxvZ2dpbmcKbG9nZ2luZy5iYXNpY0NvbmZpZyhsZXZlbD1sb2dnaW5nLklORk8sIGZvcm1hdD0nJShhc2N0aW1lKXMgLSAlKGxldmVsbmFtZSlzIC0gJShtZXNzYWdlKXMnKQpsb2dnZXIgPSBsb2dnaW5nLmdldExvZ2dlcihfX25hbWVfXykKCmNsYXNzIFZ1bG5HdWFyZENMSToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBzZXJ2ZXJfdXJsPU5vbmUsIGFwaV9rZXk9Tm9uZSk6CiAgICAgICAgc2VsZi5zZXJ2ZXJfdXJsID0gc2VydmVyX3VybCBvciBvcy5nZXRlbnYoJ1ZVTE5HVUFSRF9TRVJWRVInLCAnaHR0cHM6Ly92dWxuZ3VhcmQtMy5wcmV2aWV3LmVtZXJnZW50YWdlbnQuY29tJykKICAgICAgICBzZWxmLmFwaV9rZXkgPSBhcGlfa2V5IG9yIG9zLmdldGVudignVlVMTkdVQVJEX0FQSV9LRVknLCAnJykKICAgICAgICBzZWxmLnNlc3Npb24gPSByZXF1ZXN0cy5TZXNzaW9uKCkKICAgICAgICAKICAgICAgICBpZiBzZWxmLmFwaV9rZXk6CiAgICAgICAgICAgIHNlbGYuc2Vzc2lvbi5oZWFkZXJzLnVwZGF0ZSh7J0F1dGhvcml6YXRpb24nOiBmJ0JlYXJlciB7c2VsZi5hcGlfa2V5fSd9KQogICAgCiAgICBkZWYgbWFrZV9yZXF1ZXN0KHNlbGYsIG1ldGhvZCwgZW5kcG9pbnQsIGRhdGE9Tm9uZSk6CiAgICAgICAgIiIiTWFrZSBBUEkgcmVxdWVzdCB0byBWdWxuR3VhcmQgc2VydmVyIiIiCiAgICAgICAgdXJsID0gZiJ7c2VsZi5zZXJ2ZXJfdXJsfS9hcGkve2VuZHBvaW50LmxzdHJpcCgnLycpfSIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG1ldGhvZC51cHBlcigpID09ICdHRVQnOgogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLnNlc3Npb24uZ2V0KHVybCwgdGltZW91dD0zMCkKICAgICAgICAgICAgZWxpZiBtZXRob2QudXBwZXIoKSA9PSAnUE9TVCc6CiAgICAgICAgICAgICAgICByZXNwb25zZSA9IHNlbGYuc2Vzc2lvbi5wb3N0KHVybCwganNvbj1kYXRhLCB0aW1lb3V0PTMwKQogICAgICAgICAgICBlbGlmIG1ldGhvZC51cHBlcigpID09ICdQVVQnOgogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLnNlc3Npb24ucHV0KHVybCwganNvbj1kYXRhLCB0aW1lb3V0PTMwKQogICAgICAgICAgICBlbGlmIG1ldGhvZC51cHBlcigpID09ICdERUxFVEUnOgogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLnNlc3Npb24uZGVsZXRlKHVybCwgdGltZW91dD0zMCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHJlc3BvbnNlLnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpIGlmIHJlc3BvbnNlLmNvbnRlbnQgZWxzZSB7fQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgcmVxdWVzdHMuZXhjZXB0aW9ucy5SZXF1ZXN0RXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkFQSSByZXF1ZXN0IGZhaWxlZDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgIAogICAgZGVmIGxpc3RfYXNzZXRzKHNlbGYsIGZvcm1hdF9vdXRwdXQ9J3RhYmxlJyk6CiAgICAgICAgIiIiTGlzdCBhbGwgYXNzZXRzIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIkZldGNoaW5nIGFzc2V0cy4uLiIpCiAgICAgICAgYXNzZXRzID0gc2VsZi5tYWtlX3JlcXVlc3QoJ0dFVCcsICcvYXNzZXRzJykKICAgICAgICAKICAgICAgICBpZiBub3QgYXNzZXRzOgogICAgICAgICAgICBwcmludCgiTm8gYXNzZXRzIGZvdW5kIG9yIEFQSSBlcnJvciIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIGlmIGZvcm1hdF9vdXRwdXQgPT0gJ2pzb24nOgogICAgICAgICAgICBwcmludChqc29uLmR1bXBzKGFzc2V0cywgaW5kZW50PTIpKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgVGFibGUgZm9ybWF0CiAgICAgICAgICAgIHByaW50KGYieydIb3N0bmFtZSc6PDIwfSB7J0lQIEFkZHJlc3MnOjwxNX0geydUeXBlJzo8MTV9IHsnRW52aXJvbm1lbnQnOjwxMn0geydDcml0aWNhbGl0eSc6PDEwfSIpCiAgICAgICAgICAgIHByaW50KCItIiAqIDgwKQogICAgICAgICAgICBmb3IgYXNzZXQgaW4gYXNzZXRzOgogICAgICAgICAgICAgICAgcHJpbnQoZiJ7YXNzZXRbJ2hvc3RuYW1lJ106PDIwfSB7YXNzZXQuZ2V0KCdpcF9hZGRyZXNzJywgJ04vQScpOjwxNX0gIgogICAgICAgICAgICAgICAgICAgICAgZiJ7YXNzZXRbJ2Fzc2V0X3R5cGUnXTo8MTV9IHthc3NldFsnZW52aXJvbm1lbnQnXTo8MTJ9IHthc3NldFsnY3JpdGljYWxpdHknXTo8MTB9IikKICAgIAogICAgZGVmIGNyZWF0ZV9hc3NldChzZWxmLCBob3N0bmFtZSwgaXBfYWRkcmVzcz1Ob25lLCBhc3NldF90eXBlPSdzZXJ2ZXInLCBlbnZpcm9ubWVudD0ncHJvZHVjdGlvbicsIAogICAgICAgICAgICAgICAgICAgIGNyaXRpY2FsaXR5PTMsIG93bmVyPU5vbmUsIGJ1c2luZXNzX3VuaXQ9Tm9uZSwgbG9jYXRpb249Tm9uZSk6CiAgICAgICAgIiIiQ3JlYXRlIG5ldyBhc3NldCIiIgogICAgICAgIGFzc2V0X2RhdGEgPSB7CiAgICAgICAgICAgICdob3N0bmFtZSc6IGhvc3RuYW1lLAogICAgICAgICAgICAnaXBfYWRkcmVzcyc6IGlwX2FkZHJlc3MsCiAgICAgICAgICAgICdhc3NldF90eXBlJzogYXNzZXRfdHlwZSwKICAgICAgICAgICAgJ2Vudmlyb25tZW50JzogZW52aXJvbm1lbnQsCiAgICAgICAgICAgICdjcml0aWNhbGl0eSc6IGNyaXRpY2FsaXR5LAogICAgICAgICAgICAnb3duZXInOiBvd25lciwKICAgICAgICAgICAgJ2J1c2luZXNzX3VuaXQnOiBidXNpbmVzc191bml0LAogICAgICAgICAgICAnbG9jYXRpb24nOiBsb2NhdGlvbgogICAgICAgIH0KICAgICAgICAKICAgICAgICAjIFJlbW92ZSBOb25lIHZhbHVlcwogICAgICAgIGFzc2V0X2RhdGEgPSB7azogdiBmb3IgaywgdiBpbiBhc3NldF9kYXRhLml0ZW1zKCkgaWYgdiBpcyBub3QgTm9uZX0KICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIkNyZWF0aW5nIGFzc2V0OiB7aG9zdG5hbWV9IikKICAgICAgICByZXN1bHQgPSBzZWxmLm1ha2VfcmVxdWVzdCgnUE9TVCcsICcvYXNzZXRzJywgYXNzZXRfZGF0YSkKICAgICAgICAKICAgICAgICBpZiByZXN1bHQ6CiAgICAgICAgICAgIHByaW50KGYiQXNzZXQgY3JlYXRlZCBzdWNjZXNzZnVsbHk6IHtyZXN1bHRbJ2lkJ119IikKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdFsnaWQnXQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHByaW50KCJGYWlsZWQgdG8gY3JlYXRlIGFzc2V0IikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgIAogICAgZGVmIGxpc3RfZmluZGluZ3Moc2VsZiwgYXNzZXRfaWQ9Tm9uZSwgc2V2ZXJpdHk9Tm9uZSwgZmluZGluZ190eXBlPU5vbmUsIGNyb3NzX2hvc3Q9RmFsc2UsIGZvcm1hdF9vdXRwdXQ9J3RhYmxlJyk6CiAgICAgICAgIiIiTGlzdCB2dWxuZXJhYmlsaXR5IGZpbmRpbmdzIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIkZldGNoaW5nIGZpbmRpbmdzLi4uIikKICAgICAgICAKICAgICAgICBwYXJhbXMgPSB7fQogICAgICAgIGlmIGFzc2V0X2lkOgogICAgICAgICAgICBwYXJhbXNbJ2Fzc2V0X2lkJ10gPSBhc3NldF9pZAogICAgICAgIGlmIHNldmVyaXR5OgogICAgICAgICAgICBwYXJhbXNbJ3NldmVyaXR5J10gPSBzZXZlcml0eQogICAgICAgIGlmIGZpbmRpbmdfdHlwZToKICAgICAgICAgICAgcGFyYW1zWydmaW5kaW5nX3R5cGUnXSA9IGZpbmRpbmdfdHlwZQogICAgICAgIGlmIGNyb3NzX2hvc3Q6CiAgICAgICAgICAgIHBhcmFtc1snY3Jvc3NfaG9zdCddID0gJ3RydWUnCiAgICAgICAgCiAgICAgICAgZW5kcG9pbnQgPSAnL2ZpbmRpbmdzJwogICAgICAgIGlmIHBhcmFtczoKICAgICAgICAgICAgcGFyYW1fc3RyID0gJyYnLmpvaW4oW2Yie2t9PXt2fSIgZm9yIGssIHYgaW4gcGFyYW1zLml0ZW1zKCldKQogICAgICAgICAgICBlbmRwb2ludCArPSBmIj97cGFyYW1fc3RyfSIKICAgICAgICAKICAgICAgICBmaW5kaW5ncyA9IHNlbGYubWFrZV9yZXF1ZXN0KCdHRVQnLCBlbmRwb2ludCkKICAgICAgICAKICAgICAgICBpZiBub3QgZmluZGluZ3M6CiAgICAgICAgICAgIHByaW50KCJObyBmaW5kaW5ncyBmb3VuZCBvciBBUEkgZXJyb3IiKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBpZiBmb3JtYXRfb3V0cHV0ID09ICdqc29uJzoKICAgICAgICAgICAgcHJpbnQoanNvbi5kdW1wcyhmaW5kaW5ncywgaW5kZW50PTIpKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgVGFibGUgZm9ybWF0CiAgICAgICAgICAgIHByaW50KGYieydUaXRsZSc6PDQwfSB7J1NldmVyaXR5Jzo8MTB9IHsnVHlwZSc6PDE1fSB7J0NWRSBJRHMnOjwyMH0iKQogICAgICAgICAgICBwcmludCgiLSIgKiA5MCkKICAgICAgICAgICAgZm9yIGZpbmRpbmcgaW4gZmluZGluZ3M6CiAgICAgICAgICAgICAgICBjdmVfc3RyID0gJywgJy5qb2luKGZpbmRpbmcuZ2V0KCdjdmVfaWRzJywgW10pWzoyXSkgICMgU2hvdyBmaXJzdCAyIENWRXMKICAgICAgICAgICAgICAgIGlmIGxlbihmaW5kaW5nLmdldCgnY3ZlX2lkcycsIFtdKSkgPiAyOgogICAgICAgICAgICAgICAgICAgIGN2ZV9zdHIgKz0gJy4uLicKICAgICAgICAgICAgICAgIHByaW50KGYie2ZpbmRpbmdbJ3RpdGxlJ11bOjM4XTo8NDB9IHtmaW5kaW5nWydzZXZlcml0eSddLnVwcGVyKCk6PDEwfSAiCiAgICAgICAgICAgICAgICAgICAgICBmIntmaW5kaW5nLmdldCgnZmluZGluZ190eXBlJywgJ3Z1bG4nKTo8MTV9IHtjdmVfc3RyOjwyMH0iKQogICAgCiAgICBkZWYgc3RhcnRfbmV0d29ya19zY2FuKHNlbGYsIHRhcmdldHMsIHNjYW5fbmFtZT1Ob25lLCBpbmNsdWRlX21pc2NvbmZpZ3M9VHJ1ZSk6CiAgICAgICAgIiIiU3RhcnQgbmV0d29yayB2dWxuZXJhYmlsaXR5IHNjYW4iIiIKICAgICAgICBpZiBpc2luc3RhbmNlKHRhcmdldHMsIHN0cik6CiAgICAgICAgICAgIHRhcmdldHMgPSBbdC5zdHJpcCgpIGZvciB0IGluIHRhcmdldHMuc3BsaXQoJywnKV0KICAgICAgICAKICAgICAgICBzY2FuX2RhdGEgPSB7CiAgICAgICAgICAgICd0YXJnZXRzJzogdGFyZ2V0cywKICAgICAgICAgICAgJ3NjYW5fbmFtZSc6IHNjYW5fbmFtZSBvciBmJ0NMSSBTY2FuIHtkYXRldGltZS5ub3coKS5zdHJmdGltZSgiJVklbSVkXyVIJU0lUyIpfScsCiAgICAgICAgICAgICdpbmNsdWRlX21pc2NvbmZpZ3MnOiBpbmNsdWRlX21pc2NvbmZpZ3MKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oZiJTdGFydGluZyBuZXR3b3JrIHNjYW4gZm9yIHtsZW4odGFyZ2V0cyl9IHRhcmdldHMuLi4iKQogICAgICAgIHJlc3VsdCA9IHNlbGYubWFrZV9yZXF1ZXN0KCdQT1NUJywgJy9zY2FuL25ldHdvcmsnLCBzY2FuX2RhdGEpCiAgICAgICAgCiAgICAgICAgaWYgcmVzdWx0OgogICAgICAgICAgICBwcmludChmIlNjYW4gc3RhcnRlZCBzdWNjZXNzZnVsbHk6IikKICAgICAgICAgICAgcHJpbnQoZiIgIFNjYW4gSUQ6IHtyZXN1bHRbJ3NjYW5faWQnXX0iKQogICAgICAgICAgICBwcmludChmIiAgU3RhdHVzOiB7cmVzdWx0WydzdGF0dXMnXX0iKQogICAgICAgICAgICBwcmludChmIiAgRmluZGluZ3M6IHtyZXN1bHQuZ2V0KCdmaW5kaW5nc19jb3VudCcsIDApfSIpCiAgICAgICAgICAgIHByaW50KGYiICBNaXNjb25maWd1cmF0aW9uczoge3Jlc3VsdC5nZXQoJ21pc2NvbmZpZ3VyYXRpb25zJywgMCl9IikKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdFsnc2Nhbl9pZCddCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJpbnQoIkZhaWxlZCB0byBzdGFydCBzY2FuIikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgIAogICAgZGVmIHVwbG9hZF9zY2FuX2ZpbGUoc2VsZiwgZmlsZV9wYXRoLCBhc3NldF9pZCwgc2Nhbl9uYW1lPU5vbmUpOgogICAgICAgICIiIlVwbG9hZCB2dWxuZXJhYmlsaXR5IHNjYW4gZmlsZSIiIgogICAgICAgIGZpbGVfcGF0aCA9IFBhdGgoZmlsZV9wYXRoKQogICAgICAgIGlmIG5vdCBmaWxlX3BhdGguZXhpc3RzKCk6CiAgICAgICAgICAgIHByaW50KGYiRmlsZSBub3QgZm91bmQ6IHtmaWxlX3BhdGh9IikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAKICAgICAgICAjIEZvciBDTEksIHdlJ2xsIHJlYWQgYW5kIHNlbmQgdGhlIGZpbGUgY29udGVudAogICAgICAgIGxvZ2dlci5pbmZvKGYiUHJvY2Vzc2luZyBzY2FuIGZpbGU6IHtmaWxlX3BhdGh9IikKICAgICAgICAKICAgICAgICAjIFNpbXBsZSBmaWxlIHByb2Nlc3NpbmcgZm9yIGRlbW9uc3RyYXRpb24KICAgICAgICAjIEluIHByb2R1Y3Rpb24sIHlvdSdkIHByb3Blcmx5IHBhcnNlIGRpZmZlcmVudCBmb3JtYXRzCiAgICAgICAgaWYgZmlsZV9wYXRoLnN1ZmZpeC5sb3dlcigpID09ICcuanNvbic6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICdyJykgYXMgZjoKICAgICAgICAgICAgICAgICAgICBkYXRhID0ganNvbi5sb2FkKGYpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ29udmVydCB0byBleHBlY3RlZCBmb3JtYXQKICAgICAgICAgICAgICAgIHNjYW5fcmVzdWx0ID0gewogICAgICAgICAgICAgICAgICAgICdzY2FuX25hbWUnOiBzY2FuX25hbWUgb3IgZidGaWxlIFVwbG9hZCB7ZmlsZV9wYXRoLm5hbWV9JywKICAgICAgICAgICAgICAgICAgICAnYXNzZXRfaWQnOiBhc3NldF9pZCwKICAgICAgICAgICAgICAgICAgICAnZmluZGluZ3MnOiBzZWxmLnBhcnNlX3NjYW5fZmlsZShkYXRhKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBwcmludChmIlByb2Nlc3NlZCB7bGVuKHNjYW5fcmVzdWx0WydmaW5kaW5ncyddKX0gZmluZGluZ3MgZnJvbSB7ZmlsZV9wYXRofSIpCiAgICAgICAgICAgICAgICByZXR1cm4gc2Nhbl9yZXN1bHQKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBwcmludChmIkVycm9yIHByb2Nlc3NpbmcgZmlsZToge2V9IikKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJpbnQoZiJVbnN1cHBvcnRlZCBmaWxlIGZvcm1hdDoge2ZpbGVfcGF0aC5zdWZmaXh9IikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgIAogICAgZGVmIHBhcnNlX3NjYW5fZmlsZShzZWxmLCBkYXRhKToKICAgICAgICAiIiJQYXJzZSBzY2FuIGZpbGUgZGF0YSBpbnRvIGZpbmRpbmdzIiIiCiAgICAgICAgZmluZGluZ3MgPSBbXQogICAgICAgIAogICAgICAgICMgSGFuZGxlIHZhcmlvdXMgSlNPTiBmb3JtYXRzCiAgICAgICAgaWYgJ3Z1bG5lcmFiaWxpdGllcycgaW4gZGF0YToKICAgICAgICAgICAgZm9yIHZ1bG4gaW4gZGF0YVsndnVsbmVyYWJpbGl0aWVzJ106CiAgICAgICAgICAgICAgICBmaW5kaW5nID0gewogICAgICAgICAgICAgICAgICAgICd0aXRsZSc6IHZ1bG4uZ2V0KCduYW1lJywgJ1Vua25vd24gVnVsbmVyYWJpbGl0eScpLAogICAgICAgICAgICAgICAgICAgICdkZXNjcmlwdGlvbic6IHZ1bG4uZ2V0KCdkZXNjcmlwdGlvbicsICcnKSwKICAgICAgICAgICAgICAgICAgICAnc2V2ZXJpdHknOiB2dWxuLmdldCgnc2V2ZXJpdHknLCAnbWVkaXVtJykubG93ZXIoKSwKICAgICAgICAgICAgICAgICAgICAnY3ZlX2lkcyc6IHZ1bG4uZ2V0KCdjdmUnLCBbXSksCiAgICAgICAgICAgICAgICAgICAgJ2ZpbmRpbmdfdHlwZSc6ICd2dWxuZXJhYmlsaXR5JwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZmluZGluZ3MuYXBwZW5kKGZpbmRpbmcpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIGZpbmRpbmdzCiAgICAKICAgIGRlZiBnZW5lcmF0ZV9hbnNpYmxlX3JlbWVkaWF0aW9uKHNlbGYsIGZpbmRpbmdfaWQsIGd1aWRlZD1GYWxzZSk6CiAgICAgICAgIiIiR2VuZXJhdGUgQW5zaWJsZSByZW1lZGlhdGlvbiBmb3IgZmluZGluZyIiIgogICAgICAgIGxvZ2dlci5pbmZvKGYiR2VuZXJhdGluZyBBbnNpYmxlIHJlbWVkaWF0aW9uIGZvciBmaW5kaW5nOiB7ZmluZGluZ19pZH0iKQogICAgICAgIAogICAgICAgIGVuZHBvaW50ID0gZicvZmluZGluZ3Mve2ZpbmRpbmdfaWR9L3JlbWVkaWF0aW9uL2Fuc2libGUnCiAgICAgICAgaWYgZ3VpZGVkOgogICAgICAgICAgICBlbmRwb2ludCArPSAnP2d1aWRlZD10cnVlJwogICAgICAgIAogICAgICAgIHJlc3VsdCA9IHNlbGYubWFrZV9yZXF1ZXN0KCdQT1NUJywgZW5kcG9pbnQpCiAgICAgICAgCiAgICAgICAgaWYgcmVzdWx0OgogICAgICAgICAgICBwcmludChmIkFuc2libGUgcmVtZWRpYXRpb24gZ2VuZXJhdGVkOiIpCiAgICAgICAgICAgIHByaW50KGYiICBQbGF5Ym9vayBJRDoge3Jlc3VsdFsnaWQnXX0iKQogICAgICAgICAgICBwcmludChmIiAgRXN0aW1hdGVkIFRpbWU6IHtyZXN1bHQuZ2V0KCdlc3RpbWF0ZWRfdGltZScsICdOL0EnKX0gbWludXRlcyIpCiAgICAgICAgICAgIHByaW50KGYiICBSaXNrIExldmVsOiB7cmVzdWx0LmdldCgncmlza19sZXZlbCcsICdOL0EnKX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmVzdWx0LmdldCgnYW5zaWJsZV9wbGF5Ym9vaycpOgogICAgICAgICAgICAgICAgcHJpbnQoIlxuQW5zaWJsZSBQbGF5Ym9vazoiKQogICAgICAgICAgICAgICAgcHJpbnQoIi0iICogNTApCiAgICAgICAgICAgICAgICBwcmludChyZXN1bHRbJ2Fuc2libGVfcGxheWJvb2snXVs6NTAwXSArICcuLi4nIGlmIGxlbihyZXN1bHRbJ2Fuc2libGVfcGxheWJvb2snXSkgPiA1MDAgZWxzZSByZXN1bHRbJ2Fuc2libGVfcGxheWJvb2snXSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiByZXN1bHRbJ2lkJ10KICAgICAgICBlbHNlOgogICAgICAgICAgICBwcmludCgiRmFpbGVkIHRvIGdlbmVyYXRlIHJlbWVkaWF0aW9uIikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgIAogICAgZGVmIGNyZWF0ZV9jaGFuZ2VfcmVxdWVzdChzZWxmLCB0aXRsZSwgZGVzY3JpcHRpb24sIHJlbWVkaWF0aW9uX2lkLCByZXF1ZXN0b3IsIHByaW9yaXR5PSdtZWRpdW0nKToKICAgICAgICAiIiJDcmVhdGUgY2hhbmdlIG1hbmFnZW1lbnQgcmVxdWVzdCIiIgogICAgICAgIGNoYW5nZV9kYXRhID0gewogICAgICAgICAgICAndGl0bGUnOiB0aXRsZSwKICAgICAgICAgICAgJ2Rlc2NyaXB0aW9uJzogZGVzY3JpcHRpb24sCiAgICAgICAgICAgICdyZW1lZGlhdGlvbl9pZCc6IHJlbWVkaWF0aW9uX2lkLAogICAgICAgICAgICAncmVxdWVzdG9yJzogcmVxdWVzdG9yLAogICAgICAgICAgICAncHJpb3JpdHknOiBwcmlvcml0eQogICAgICAgIH0KICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIkNyZWF0aW5nIGNoYW5nZSByZXF1ZXN0OiB7dGl0bGV9IikKICAgICAgICByZXN1bHQgPSBzZWxmLm1ha2VfcmVxdWVzdCgnUE9TVCcsICcvY2hhbmdlLXJlcXVlc3RzJywgY2hhbmdlX2RhdGEpCiAgICAgICAgCiAgICAgICAgaWYgcmVzdWx0OgogICAgICAgICAgICBwcmludChmIkNoYW5nZSByZXF1ZXN0IGNyZWF0ZWQ6IikKICAgICAgICAgICAgcHJpbnQoZiIgIFJlcXVlc3QgSUQ6IHtyZXN1bHRbJ2lkJ119IikKICAgICAgICAgICAgcHJpbnQoZiIgIFN0YXR1czoge3Jlc3VsdFsnc3RhdHVzJ119IikKICAgICAgICAgICAgcHJpbnQoZiIgIFByaW9yaXR5OiB7cmVzdWx0Wydwcmlvcml0eSddfSIpCiAgICAgICAgICAgIHJldHVybiByZXN1bHRbJ2lkJ10KICAgICAgICBlbHNlOgogICAgICAgICAgICBwcmludCgiRmFpbGVkIHRvIGNyZWF0ZSBjaGFuZ2UgcmVxdWVzdCIpCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAKICAgIGRlZiBnZXRfYXVkaXRfbG9ncyhzZWxmLCBhY3Rpb249Tm9uZSwgcmVzb3VyY2VfdHlwZT1Ob25lLCBsaW1pdD01MCk6CiAgICAgICAgIiIiR2V0IGF1ZGl0IGxvZ3MiIiIKICAgICAgICBsb2dnZXIuaW5mbygiRmV0Y2hpbmcgYXVkaXQgbG9ncy4uLiIpCiAgICAgICAgCiAgICAgICAgcGFyYW1zID0geydsaW1pdCc6IGxpbWl0fQogICAgICAgIGlmIGFjdGlvbjoKICAgICAgICAgICAgcGFyYW1zWydhY3Rpb24nXSA9IGFjdGlvbgogICAgICAgIGlmIHJlc291cmNlX3R5cGU6CiAgICAgICAgICAgIHBhcmFtc1sncmVzb3VyY2VfdHlwZSddID0gcmVzb3VyY2VfdHlwZQogICAgICAgIAogICAgICAgIGVuZHBvaW50ID0gJy9hdWRpdC1sb2dzJwogICAgICAgIGlmIHBhcmFtczoKICAgICAgICAgICAgcGFyYW1fc3RyID0gJyYnLmpvaW4oW2Yie2t9PXt2fSIgZm9yIGssIHYgaW4gcGFyYW1zLml0ZW1zKCldKQogICAgICAgICAgICBlbmRwb2ludCArPSBmIj97cGFyYW1fc3RyfSIKICAgICAgICAKICAgICAgICBsb2dzID0gc2VsZi5tYWtlX3JlcXVlc3QoJ0dFVCcsIGVuZHBvaW50KQogICAgICAgIAogICAgICAgIGlmIG5vdCBsb2dzOgogICAgICAgICAgICBwcmludCgiTm8gYXVkaXQgbG9ncyBmb3VuZCBvciBBUEkgZXJyb3IiKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBwcmludChmInsnVGltZXN0YW1wJzo8MjB9IHsnVXNlcic6PDE1fSB7J0FjdGlvbic6PDEwfSB7J1Jlc291cmNlJzo8MTV9IHsnUmVzb3VyY2UgSUQnOjwxNX0iKQogICAgICAgIHByaW50KCItIiAqIDgwKQogICAgICAgIGZvciBsb2cgaW4gbG9nczoKICAgICAgICAgICAgdGltZXN0YW1wID0gZGF0ZXRpbWUuZnJvbWlzb2Zvcm1hdChsb2dbJ3RpbWVzdGFtcCddKS5zdHJmdGltZSgnJVktJW0tJWQgJUg6JU06JVMnKQogICAgICAgICAgICBwcmludChmInt0aW1lc3RhbXA6PDIwfSB7bG9nWyd1c2VyX2lkJ106PDE1fSB7bG9nWydhY3Rpb24nXTo8MTB9ICIKICAgICAgICAgICAgICAgICAgZiJ7bG9nWydyZXNvdXJjZV90eXBlJ106PDE1fSB7bG9nWydyZXNvdXJjZV9pZCddWzoxM106PDE1fSIpCiAgICAKICAgIGRlZiBnZXRfZGFzaGJvYXJkX3N0YXRzKHNlbGYpOgogICAgICAgICIiIkdldCBkYXNoYm9hcmQgc3RhdGlzdGljcyIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJGZXRjaGluZyBkYXNoYm9hcmQgc3RhdGlzdGljcy4uLiIpCiAgICAgICAgCiAgICAgICAgc3RhdHMgPSBzZWxmLm1ha2VfcmVxdWVzdCgnR0VUJywgJy9kYXNoYm9hcmQvc3RhdHMnKQogICAgICAgIAogICAgICAgIGlmIG5vdCBzdGF0czoKICAgICAgICAgICAgcHJpbnQoIkZhaWxlZCB0byBmZXRjaCBkYXNoYm9hcmQgc3RhdHMiKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBzdW1tYXJ5ID0gc3RhdHMuZ2V0KCdzdW1tYXJ5Jywge30pCiAgICAgICAgCiAgICAgICAgcHJpbnQoIj09PSBWdWxuR3VhcmQgRGFzaGJvYXJkIFN0YXRpc3RpY3MgPT09IikKICAgICAgICBwcmludChmIlRvdGFsIEFzc2V0czoge3N1bW1hcnkuZ2V0KCd0b3RhbF9hc3NldHMnLCAwKX0iKQogICAgICAgIHByaW50KGYiVG90YWwgRmluZGluZ3M6IHtzdW1tYXJ5LmdldCgndG90YWxfZmluZGluZ3MnLCAwKX0iKQogICAgICAgIHByaW50KGYiQ3Jvc3MtSG9zdCBWdWxuZXJhYmlsaXRpZXM6IHtzdW1tYXJ5LmdldCgnY3Jvc3NfaG9zdF92dWxuZXJhYmlsaXRpZXMnLCAwKX0iKQogICAgICAgIHByaW50KGYiUGVuZGluZyBBcHByb3ZhbHM6IHtzdW1tYXJ5LmdldCgncGVuZGluZ19hcHByb3ZhbHMnLCAwKX0iKQogICAgICAgIHByaW50KGYiQ2hhbmdlIFJlcXVlc3RzOiB7c3VtbWFyeS5nZXQoJ2NoYW5nZV9yZXF1ZXN0cycsIDApfSIpCiAgICAgICAgCiAgICAgICAgaWYgJ3NldmVyaXR5X2JyZWFrZG93bicgaW4gc3RhdHM6CiAgICAgICAgICAgIHByaW50KCJcblNldmVyaXR5IEJyZWFrZG93bjoiKQogICAgICAgICAgICBmb3Igc2V2ZXJpdHksIGNvdW50IGluIHN0YXRzWydzZXZlcml0eV9icmVha2Rvd24nXS5pdGVtcygpOgogICAgICAgICAgICAgICAgcHJpbnQoZiIgIHtzZXZlcml0eS5jYXBpdGFsaXplKCl9OiB7Y291bnR9IikKICAgICAgICAKICAgICAgICBpZiAnZmluZGluZ190eXBlcycgaW4gc3RhdHM6CiAgICAgICAgICAgIHByaW50KCJcbkZpbmRpbmcgVHlwZXM6IikKICAgICAgICAgICAgZm9yIHR5cGVfbmFtZSwgY291bnQgaW4gc3RhdHNbJ2ZpbmRpbmdfdHlwZXMnXS5pdGVtcygpOgogICAgICAgICAgICAgICAgcHJpbnQoZiIgIHt0eXBlX25hbWUucmVwbGFjZSgnXycsICcgJykudGl0bGUoKX06IHtjb3VudH0iKQoKZGVmIG1haW4oKToKICAgIHBhcnNlciA9IGFyZ3BhcnNlLkFyZ3VtZW50UGFyc2VyKGRlc2NyaXB0aW9uPSdWdWxuR3VhcmQgQ0xJIFRvb2wnKQogICAgcGFyc2VyLmFkZF9hcmd1bWVudCgnLS1zZXJ2ZXInLCBoZWxwPSdWdWxuR3VhcmQgc2VydmVyIFVSTCcpCiAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCctLWFwaS1rZXknLCBoZWxwPSdBUEkga2V5IGZvciBhdXRoZW50aWNhdGlvbicpCiAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCctLWZvcm1hdCcsIGNob2ljZXM9Wyd0YWJsZScsICdqc29uJ10sIGRlZmF1bHQ9J3RhYmxlJywgaGVscD0nT3V0cHV0IGZvcm1hdCcpCiAgICAKICAgIHN1YnBhcnNlcnMgPSBwYXJzZXIuYWRkX3N1YnBhcnNlcnMoZGVzdD0nY29tbWFuZCcsIGhlbHA9J0F2YWlsYWJsZSBjb21tYW5kcycpCiAgICAKICAgICMgQXNzZXRzIGNvbW1hbmRzCiAgICBhc3NldHNfcGFyc2VyID0gc3VicGFyc2Vycy5hZGRfcGFyc2VyKCdhc3NldHMnLCBoZWxwPSdBc3NldCBtYW5hZ2VtZW50JykKICAgIGFzc2V0c19zdWJwYXJzZXJzID0gYXNzZXRzX3BhcnNlci5hZGRfc3VicGFyc2VycyhkZXN0PSdhc3NldHNfYWN0aW9uJykKICAgIAogICAgIyBMaXN0IGFzc2V0cwogICAgbGlzdF9hc3NldHNfcGFyc2VyID0gYXNzZXRzX3N1YnBhcnNlcnMuYWRkX3BhcnNlcignbGlzdCcsIGhlbHA9J0xpc3QgYXNzZXRzJykKICAgIAogICAgIyBDcmVhdGUgYXNzZXQKICAgIGNyZWF0ZV9hc3NldF9wYXJzZXIgPSBhc3NldHNfc3VicGFyc2Vycy5hZGRfcGFyc2VyKCdjcmVhdGUnLCBoZWxwPSdDcmVhdGUgYXNzZXQnKQogICAgY3JlYXRlX2Fzc2V0X3BhcnNlci5hZGRfYXJndW1lbnQoJ2hvc3RuYW1lJywgaGVscD0nQXNzZXQgaG9zdG5hbWUnKQogICAgY3JlYXRlX2Fzc2V0X3BhcnNlci5hZGRfYXJndW1lbnQoJy0taXAnLCBoZWxwPSdJUCBhZGRyZXNzJykKICAgIGNyZWF0ZV9hc3NldF9wYXJzZXIuYWRkX2FyZ3VtZW50KCctLXR5cGUnLCBkZWZhdWx0PSdzZXJ2ZXInLCBoZWxwPSdBc3NldCB0eXBlJykKICAgIGNyZWF0ZV9hc3NldF9wYXJzZXIuYWRkX2FyZ3VtZW50KCctLWVudicsIGRlZmF1bHQ9J3Byb2R1Y3Rpb24nLCBoZWxwPSdFbnZpcm9ubWVudCcpCiAgICBjcmVhdGVfYXNzZXRfcGFyc2VyLmFkZF9hcmd1bWVudCgnLS1jcml0aWNhbGl0eScsIHR5cGU9aW50LCBkZWZhdWx0PTMsIGhlbHA9J0NyaXRpY2FsaXR5ICgxLTUpJykKICAgIGNyZWF0ZV9hc3NldF9wYXJzZXIuYWRkX2FyZ3VtZW50KCctLW93bmVyJywgaGVscD0nQXNzZXQgb3duZXInKQogICAgY3JlYXRlX2Fzc2V0X3BhcnNlci5hZGRfYXJndW1lbnQoJy0tYnVzaW5lc3MtdW5pdCcsIGhlbHA9J0J1c2luZXNzIHVuaXQnKQogICAgY3JlYXRlX2Fzc2V0X3BhcnNlci5hZGRfYXJndW1lbnQoJy0tbG9jYXRpb24nLCBoZWxwPSdMb2NhdGlvbicpCiAgICAKICAgICMgRmluZGluZ3MgY29tbWFuZHMKICAgIGZpbmRpbmdzX3BhcnNlciA9IHN1YnBhcnNlcnMuYWRkX3BhcnNlcignZmluZGluZ3MnLCBoZWxwPSdGaW5kaW5ncyBtYW5hZ2VtZW50JykKICAgIGZpbmRpbmdzX3N1YnBhcnNlcnMgPSBmaW5kaW5nc19wYXJzZXIuYWRkX3N1YnBhcnNlcnMoZGVzdD0nZmluZGluZ3NfYWN0aW9uJykKICAgIAogICAgIyBMaXN0IGZpbmRpbmdzCiAgICBsaXN0X2ZpbmRpbmdzX3BhcnNlciA9IGZpbmRpbmdzX3N1YnBhcnNlcnMuYWRkX3BhcnNlcignbGlzdCcsIGhlbHA9J0xpc3QgZmluZGluZ3MnKQogICAgbGlzdF9maW5kaW5nc19wYXJzZXIuYWRkX2FyZ3VtZW50KCctLWFzc2V0LWlkJywgaGVscD0nRmlsdGVyIGJ5IGFzc2V0IElEJykKICAgIGxpc3RfZmluZGluZ3NfcGFyc2VyLmFkZF9hcmd1bWVudCgnLS1zZXZlcml0eScsIGNob2ljZXM9Wydjcml0aWNhbCcsICdoaWdoJywgJ21lZGl1bScsICdsb3cnXSwgaGVscD0nRmlsdGVyIGJ5IHNldmVyaXR5JykKICAgIGxpc3RfZmluZGluZ3NfcGFyc2VyLmFkZF9hcmd1bWVudCgnLS10eXBlJywgY2hvaWNlcz1bJ3Z1bG5lcmFiaWxpdHknLCAnbWlzY29uZmlndXJhdGlvbicsICdjb21wbGlhbmNlJ10sIGhlbHA9J0ZpbHRlciBieSB0eXBlJykKICAgIGxpc3RfZmluZGluZ3NfcGFyc2VyLmFkZF9hcmd1bWVudCgnLS1jcm9zcy1ob3N0JywgYWN0aW9uPSdzdG9yZV90cnVlJywgaGVscD0nU2hvdyBvbmx5IGNyb3NzLWhvc3QgdnVsbmVyYWJpbGl0aWVzJykKICAgIAogICAgIyBTY2FubmluZyBjb21tYW5kcwogICAgc2Nhbl9wYXJzZXIgPSBzdWJwYXJzZXJzLmFkZF9wYXJzZXIoJ3NjYW4nLCBoZWxwPSdWdWxuZXJhYmlsaXR5IHNjYW5uaW5nJykKICAgIHNjYW5fc3VicGFyc2VycyA9IHNjYW5fcGFyc2VyLmFkZF9zdWJwYXJzZXJzKGRlc3Q9J3NjYW5fYWN0aW9uJykKICAgIAogICAgIyBOZXR3b3JrIHNjYW4KICAgIG5ldHdvcmtfc2Nhbl9wYXJzZXIgPSBzY2FuX3N1YnBhcnNlcnMuYWRkX3BhcnNlcignbmV0d29yaycsIGhlbHA9J1N0YXJ0IG5ldHdvcmsgc2NhbicpCiAgICBuZXR3b3JrX3NjYW5fcGFyc2VyLmFkZF9hcmd1bWVudCgndGFyZ2V0cycsIGhlbHA9J0NvbW1hLXNlcGFyYXRlZCBsaXN0IG9mIHRhcmdldHMnKQogICAgbmV0d29ya19zY2FuX3BhcnNlci5hZGRfYXJndW1lbnQoJy0tbmFtZScsIGhlbHA9J1NjYW4gbmFtZScpCiAgICBuZXR3b3JrX3NjYW5fcGFyc2VyLmFkZF9hcmd1bWVudCgnLS1uby1taXNjb25maWdzJywgYWN0aW9uPSdzdG9yZV90cnVlJywgaGVscD0nU2tpcCBtaXNjb25maWd1cmF0aW9uIGRldGVjdGlvbicpCiAgICAKICAgICMgRmlsZSB1cGxvYWQKICAgIHVwbG9hZF9wYXJzZXIgPSBzY2FuX3N1YnBhcnNlcnMuYWRkX3BhcnNlcigndXBsb2FkJywgaGVscD0nVXBsb2FkIHNjYW4gZmlsZScpCiAgICB1cGxvYWRfcGFyc2VyLmFkZF9hcmd1bWVudCgnZmlsZScsIGhlbHA9J1NjYW4gZmlsZSBwYXRoJykKICAgIHVwbG9hZF9wYXJzZXIuYWRkX2FyZ3VtZW50KCdhc3NldF9pZCcsIGhlbHA9J0Fzc2V0IElEJykKICAgIHVwbG9hZF9wYXJzZXIuYWRkX2FyZ3VtZW50KCctLW5hbWUnLCBoZWxwPSdTY2FuIG5hbWUnKQogICAgCiAgICAjIFJlbWVkaWF0aW9uIGNvbW1hbmRzCiAgICByZW1lZGlhdGlvbl9wYXJzZXIgPSBzdWJwYXJzZXJzLmFkZF9wYXJzZXIoJ3JlbWVkaWF0aW9uJywgaGVscD0nUmVtZWRpYXRpb24gbWFuYWdlbWVudCcpCiAgICByZW1lZGlhdGlvbl9zdWJwYXJzZXJzID0gcmVtZWRpYXRpb25fcGFyc2VyLmFkZF9zdWJwYXJzZXJzKGRlc3Q9J3JlbWVkaWF0aW9uX2FjdGlvbicpCiAgICAKICAgICMgR2VuZXJhdGUgQW5zaWJsZSByZW1lZGlhdGlvbgogICAgYW5zaWJsZV9wYXJzZXIgPSByZW1lZGlhdGlvbl9zdWJwYXJzZXJzLmFkZF9wYXJzZXIoJ2Fuc2libGUnLCBoZWxwPSdHZW5lcmF0ZSBBbnNpYmxlIHJlbWVkaWF0aW9uJykKICAgIGFuc2libGVfcGFyc2VyLmFkZF9hcmd1bWVudCgnZmluZGluZ19pZCcsIGhlbHA9J0ZpbmRpbmcgSUQnKQogICAgYW5zaWJsZV9wYXJzZXIuYWRkX2FyZ3VtZW50KCctLWd1aWRlZCcsIGFjdGlvbj0nc3RvcmVfdHJ1ZScsIGhlbHA9J0dlbmVyYXRlIGd1aWRlZCBleGVjdXRpb24gc3RlcHMnKQogICAgCiAgICAjIENoYW5nZSBtYW5hZ2VtZW50IGNvbW1hbmRzCiAgICBjaGFuZ2VfcGFyc2VyID0gc3VicGFyc2Vycy5hZGRfcGFyc2VyKCdjaGFuZ2UnLCBoZWxwPSdDaGFuZ2UgbWFuYWdlbWVudCcpCiAgICBjaGFuZ2Vfc3VicGFyc2VycyA9IGNoYW5nZV9wYXJzZXIuYWRkX3N1YnBhcnNlcnMoZGVzdD0nY2hhbmdlX2FjdGlvbicpCiAgICAKICAgICMgQ3JlYXRlIGNoYW5nZSByZXF1ZXN0CiAgICBjcmVhdGVfY2hhbmdlX3BhcnNlciA9IGNoYW5nZV9zdWJwYXJzZXJzLmFkZF9wYXJzZXIoJ2NyZWF0ZScsIGhlbHA9J0NyZWF0ZSBjaGFuZ2UgcmVxdWVzdCcpCiAgICBjcmVhdGVfY2hhbmdlX3BhcnNlci5hZGRfYXJndW1lbnQoJ3RpdGxlJywgaGVscD0nQ2hhbmdlIHJlcXVlc3QgdGl0bGUnKQogICAgY3JlYXRlX2NoYW5nZV9wYXJzZXIuYWRkX2FyZ3VtZW50KCdyZW1lZGlhdGlvbl9pZCcsIGhlbHA9J1JlbWVkaWF0aW9uIElEJykKICAgIGNyZWF0ZV9jaGFuZ2VfcGFyc2VyLmFkZF9hcmd1bWVudCgnLS1kZXNjcmlwdGlvbicsIGhlbHA9J0Rlc2NyaXB0aW9uJykKICAgIGNyZWF0ZV9jaGFuZ2VfcGFyc2VyLmFkZF9hcmd1bWVudCgnLS1yZXF1ZXN0b3InLCBkZWZhdWx0PSdjbGktdXNlcicsIGhlbHA9J1JlcXVlc3RvcicpCiAgICBjcmVhdGVfY2hhbmdlX3BhcnNlci5hZGRfYXJndW1lbnQoJy0tcHJpb3JpdHknLCBjaG9pY2VzPVsnY3JpdGljYWwnLCAnaGlnaCcsICdtZWRpdW0nLCAnbG93J10sIGRlZmF1bHQ9J21lZGl1bScsIGhlbHA9J1ByaW9yaXR5JykKICAgIAogICAgIyBBdWRpdCBjb21tYW5kcwogICAgYXVkaXRfcGFyc2VyID0gc3VicGFyc2Vycy5hZGRfcGFyc2VyKCdhdWRpdCcsIGhlbHA9J0F1ZGl0IHRyYWlsJykKICAgIGF1ZGl0X3BhcnNlci5hZGRfYXJndW1lbnQoJy0tYWN0aW9uJywgaGVscD0nRmlsdGVyIGJ5IGFjdGlvbicpCiAgICBhdWRpdF9wYXJzZXIuYWRkX2FyZ3VtZW50KCctLXJlc291cmNlLXR5cGUnLCBoZWxwPSdGaWx0ZXIgYnkgcmVzb3VyY2UgdHlwZScpCiAgICBhdWRpdF9wYXJzZXIuYWRkX2FyZ3VtZW50KCctLWxpbWl0JywgdHlwZT1pbnQsIGRlZmF1bHQ9NTAsIGhlbHA9J0xpbWl0IG51bWJlciBvZiByZXN1bHRzJykKICAgIAogICAgIyBEYXNoYm9hcmQgY29tbWFuZAogICAgZGFzaGJvYXJkX3BhcnNlciA9IHN1YnBhcnNlcnMuYWRkX3BhcnNlcignZGFzaGJvYXJkJywgaGVscD0nRGFzaGJvYXJkIHN0YXRpc3RpY3MnKQogICAgCiAgICBhcmdzID0gcGFyc2VyLnBhcnNlX2FyZ3MoKQogICAgCiAgICBpZiBub3QgYXJncy5jb21tYW5kOgogICAgICAgIHBhcnNlci5wcmludF9oZWxwKCkKICAgICAgICByZXR1cm4KICAgIAogICAgIyBDcmVhdGUgQ0xJIGluc3RhbmNlCiAgICBjbGkgPSBWdWxuR3VhcmRDTEkoc2VydmVyX3VybD1hcmdzLnNlcnZlciwgYXBpX2tleT1hcmdzLmFwaV9rZXkpCiAgICAKICAgICMgRXhlY3V0ZSBjb21tYW5kcwogICAgdHJ5OgogICAgICAgIGlmIGFyZ3MuY29tbWFuZCA9PSAnYXNzZXRzJzoKICAgICAgICAgICAgaWYgYXJncy5hc3NldHNfYWN0aW9uID09ICdsaXN0JzoKICAgICAgICAgICAgICAgIGNsaS5saXN0X2Fzc2V0cyhmb3JtYXRfb3V0cHV0PWFyZ3MuZm9ybWF0KQogICAgICAgICAgICBlbGlmIGFyZ3MuYXNzZXRzX2FjdGlvbiA9PSAnY3JlYXRlJzoKICAgICAgICAgICAgICAgIGNsaS5jcmVhdGVfYXNzZXQoCiAgICAgICAgICAgICAgICAgICAgaG9zdG5hbWU9YXJncy5ob3N0bmFtZSwKICAgICAgICAgICAgICAgICAgICBpcF9hZGRyZXNzPWFyZ3MuaXAsCiAgICAgICAgICAgICAgICAgICAgYXNzZXRfdHlwZT1hcmdzLnR5cGUsCiAgICAgICAgICAgICAgICAgICAgZW52aXJvbm1lbnQ9YXJncy5lbnYsCiAgICAgICAgICAgICAgICAgICAgY3JpdGljYWxpdHk9YXJncy5jcml0aWNhbGl0eSwKICAgICAgICAgICAgICAgICAgICBvd25lcj1hcmdzLm93bmVyLAogICAgICAgICAgICAgICAgICAgIGJ1c2luZXNzX3VuaXQ9YXJncy5idXNpbmVzc191bml0LAogICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uPWFyZ3MubG9jYXRpb24KICAgICAgICAgICAgICAgICkKICAgICAgICAKICAgICAgICBlbGlmIGFyZ3MuY29tbWFuZCA9PSAnZmluZGluZ3MnOgogICAgICAgICAgICBpZiBhcmdzLmZpbmRpbmdzX2FjdGlvbiA9PSAnbGlzdCc6CiAgICAgICAgICAgICAgICBjbGkubGlzdF9maW5kaW5ncygKICAgICAgICAgICAgICAgICAgICBhc3NldF9pZD1hcmdzLmFzc2V0X2lkLAogICAgICAgICAgICAgICAgICAgIHNldmVyaXR5PWFyZ3Muc2V2ZXJpdHksCiAgICAgICAgICAgICAgICAgICAgZmluZGluZ190eXBlPWFyZ3MudHlwZSwKICAgICAgICAgICAgICAgICAgICBjcm9zc19ob3N0PWFyZ3MuY3Jvc3NfaG9zdCwKICAgICAgICAgICAgICAgICAgICBmb3JtYXRfb3V0cHV0PWFyZ3MuZm9ybWF0CiAgICAgICAgICAgICAgICApCiAgICAgICAgCiAgICAgICAgZWxpZiBhcmdzLmNvbW1hbmQgPT0gJ3NjYW4nOgogICAgICAgICAgICBpZiBhcmdzLnNjYW5fYWN0aW9uID09ICduZXR3b3JrJzoKICAgICAgICAgICAgICAgIGNsaS5zdGFydF9uZXR3b3JrX3NjYW4oCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0cz1hcmdzLnRhcmdldHMsCiAgICAgICAgICAgICAgICAgICAgc2Nhbl9uYW1lPWFyZ3MubmFtZSwKICAgICAgICAgICAgICAgICAgICBpbmNsdWRlX21pc2NvbmZpZ3M9bm90IGFyZ3Mubm9fbWlzY29uZmlncwogICAgICAgICAgICAgICAgKQogICAgICAgICAgICBlbGlmIGFyZ3Muc2Nhbl9hY3Rpb24gPT0gJ3VwbG9hZCc6CiAgICAgICAgICAgICAgICBjbGkudXBsb2FkX3NjYW5fZmlsZSgKICAgICAgICAgICAgICAgICAgICBmaWxlX3BhdGg9YXJncy5maWxlLAogICAgICAgICAgICAgICAgICAgIGFzc2V0X2lkPWFyZ3MuYXNzZXRfaWQsCiAgICAgICAgICAgICAgICAgICAgc2Nhbl9uYW1lPWFyZ3MubmFtZQogICAgICAgICAgICAgICAgKQogICAgICAgIAogICAgICAgIGVsaWYgYXJncy5jb21tYW5kID09ICdyZW1lZGlhdGlvbic6CiAgICAgICAgICAgIGlmIGFyZ3MucmVtZWRpYXRpb25fYWN0aW9uID09ICdhbnNpYmxlJzoKICAgICAgICAgICAgICAgIGNsaS5nZW5lcmF0ZV9hbnNpYmxlX3JlbWVkaWF0aW9uKAogICAgICAgICAgICAgICAgICAgIGZpbmRpbmdfaWQ9YXJncy5maW5kaW5nX2lkLAogICAgICAgICAgICAgICAgICAgIGd1aWRlZD1hcmdzLmd1aWRlZAogICAgICAgICAgICAgICAgKQogICAgICAgIAogICAgICAgIGVsaWYgYXJncy5jb21tYW5kID09ICdjaGFuZ2UnOgogICAgICAgICAgICBpZiBhcmdzLmNoYW5nZV9hY3Rpb24gPT0gJ2NyZWF0ZSc6CiAgICAgICAgICAgICAgICBjbGkuY3JlYXRlX2NoYW5nZV9yZXF1ZXN0KAogICAgICAgICAgICAgICAgICAgIHRpdGxlPWFyZ3MudGl0bGUsCiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb249YXJncy5kZXNjcmlwdGlvbiBvciBmIkNoYW5nZSByZXF1ZXN0IGZvciByZW1lZGlhdGlvbiB7YXJncy5yZW1lZGlhdGlvbl9pZH0iLAogICAgICAgICAgICAgICAgICAgIHJlbWVkaWF0aW9uX2lkPWFyZ3MucmVtZWRpYXRpb25faWQsCiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdG9yPWFyZ3MucmVxdWVzdG9yLAogICAgICAgICAgICAgICAgICAgIHByaW9yaXR5PWFyZ3MucHJpb3JpdHkKICAgICAgICAgICAgICAgICkKICAgICAgICAKICAgICAgICBlbGlmIGFyZ3MuY29tbWFuZCA9PSAnYXVkaXQnOgogICAgICAgICAgICBjbGkuZ2V0X2F1ZGl0X2xvZ3MoCiAgICAgICAgICAgICAgICBhY3Rpb249YXJncy5hY3Rpb24sCiAgICAgICAgICAgICAgICByZXNvdXJjZV90eXBlPWFyZ3MucmVzb3VyY2VfdHlwZSwKICAgICAgICAgICAgICAgIGxpbWl0PWFyZ3MubGltaXQKICAgICAgICAgICAgKQogICAgICAgIAogICAgICAgIGVsaWYgYXJncy5jb21tYW5kID09ICdkYXNoYm9hcmQnOgogICAgICAgICAgICBjbGkuZ2V0X2Rhc2hib2FyZF9zdGF0cygpCiAgICAKICAgIGV4Y2VwdCBLZXlib2FyZEludGVycnVwdDoKICAgICAgICBwcmludCgiXG5PcGVyYXRpb24gY2FuY2VsbGVkIGJ5IHVzZXIiKQogICAgICAgIHN5cy5leGl0KDEpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJFcnJvcjoge2V9IikKICAgICAgICBzeXMuZXhpdCgxKQoKaWYgX19uYW1lX18gPT0gJ19fbWFpbl9fJzoKICAgIG1haW4oKQ== > "%TEMP%\vulnguard_code.b64"
python -c "import base64; exec(base64.b64decode(open('%TEMP%\\vulnguard_code.b64').read().strip()).decode())" %*

REM Cleanup
if exist "%TEMP%\vulnguard_code.b64" del "%TEMP%\vulnguard_code.b64"
if exist "%TEMP_SCRIPT%" del "%TEMP_SCRIPT%"
