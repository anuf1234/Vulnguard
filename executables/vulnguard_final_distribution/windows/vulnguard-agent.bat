@echo off
REM VulnGuard Security Scanning Agent
REM VulnGuard Security Platform v2.0

REM Check if Python is installed
python --version >nul 2>&1
if errorlevel 1 (
    echo.
    echo ERROR: Python is required but not installed.
    echo Please install Python 3.8+ from https://python.org
    echo.
    pause
    exit /b 1
)

REM Check and install dependencies
python -c "import requests" >nul 2>&1
if errorlevel 1 (
    echo Installing required dependencies...
    python -m pip install --quiet requests psutil pymongo fastapi uvicorn motor python-dotenv pydantic python-multipart
)

REM Get the directory where this script is located
set SCRIPT_DIR=%~dp0

REM Create temporary Python script
set TEMP_SCRIPT=%TEMP%\vulnguard_agent.py

REM Write the Python code to temp file (base64 encoded to handle special characters)
echo IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwoiIiIKVnVsbkd1YXJkIFNjYW5uaW5nIEFnZW50CkxpZ2h0d2VpZ2h0IGV4ZWN1dGFibGUgZm9yIFdpbmRvd3MvTGludXggZGVwbG95bWVudApQZXJmb3JtcyBsb2NhbCB2dWxuZXJhYmlsaXR5IHNjYW5zIGFuZCByZXBvcnRzIHRvIGNlbnRyYWwgcGxhdGZvcm0KIiIiCgppbXBvcnQgb3MKaW1wb3J0IHN5cwppbXBvcnQganNvbgppbXBvcnQgcmVxdWVzdHMKaW1wb3J0IHN1YnByb2Nlc3MKaW1wb3J0IHBsYXRmb3JtCmltcG9ydCBzb2NrZXQKaW1wb3J0IHBzdXRpbAppbXBvcnQgYXJncGFyc2UKaW1wb3J0IHRpbWUKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKZnJvbSBwYXRobGliIGltcG9ydCBQYXRoCmltcG9ydCBsb2dnaW5nCgojIENvbmZpZ3VyZSBsb2dnaW5nCmxvZ2dpbmcuYmFzaWNDb25maWcoCiAgICBsZXZlbD1sb2dnaW5nLklORk8sCiAgICBmb3JtYXQ9JyUoYXNjdGltZSlzIC0gJShsZXZlbG5hbWUpcyAtICUobWVzc2FnZSlzJywKICAgIGhhbmRsZXJzPVsKICAgICAgICBsb2dnaW5nLkZpbGVIYW5kbGVyKCd2dWxuZ3VhcmRfYWdlbnQubG9nJyksCiAgICAgICAgbG9nZ2luZy5TdHJlYW1IYW5kbGVyKCkKICAgIF0KKQpsb2dnZXIgPSBsb2dnaW5nLmdldExvZ2dlcihfX25hbWVfXykKCmNsYXNzIFZ1bG5HdWFyZEFnZW50OgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHNlcnZlcl91cmw9Tm9uZSwgYXBpX2tleT1Ob25lKToKICAgICAgICBzZWxmLnNlcnZlcl91cmwgPSBzZXJ2ZXJfdXJsIG9yIG9zLmdldGVudignVlVMTkdVQVJEX1NFUlZFUicsICdodHRwczovL3Z1bG5ndWFyZC0zLnByZXZpZXcuZW1lcmdlbnRhZ2VudC5jb20nKQogICAgICAgIHNlbGYuYXBpX2tleSA9IGFwaV9rZXkgb3Igb3MuZ2V0ZW52KCdWVUxOR1VBUkRfQVBJX0tFWScsICcnKQogICAgICAgIHNlbGYuaG9zdG5hbWUgPSBzb2NrZXQuZ2V0aG9zdG5hbWUoKQogICAgICAgIHNlbGYucGxhdGZvcm0gPSBwbGF0Zm9ybS5zeXN0ZW0oKQogICAgICAgIHNlbGYuYWdlbnRfaWQgPSBmIntzZWxmLmhvc3RuYW1lfV97aW50KHRpbWUudGltZSgpKX0iCiAgICAgICAgCiAgICAgICAgIyBDcmVhdGUgcmVzdWx0cyBkaXJlY3RvcnkKICAgICAgICBQYXRoKCdyZXN1bHRzJykubWtkaXIoZXhpc3Rfb2s9VHJ1ZSkKICAgICAgICAKICAgIGRlZiBnZXRfc3lzdGVtX2luZm8oc2VsZik6CiAgICAgICAgIiIiQ29sbGVjdCBjb21wcmVoZW5zaXZlIHN5c3RlbSBpbmZvcm1hdGlvbiIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaW5mbyA9IHsKICAgICAgICAgICAgICAgICdob3N0bmFtZSc6IHNlbGYuaG9zdG5hbWUsCiAgICAgICAgICAgICAgICAncGxhdGZvcm0nOiBwbGF0Zm9ybS5zeXN0ZW0oKSwKICAgICAgICAgICAgICAgICdwbGF0Zm9ybV9yZWxlYXNlJzogcGxhdGZvcm0ucmVsZWFzZSgpLAogICAgICAgICAgICAgICAgJ3BsYXRmb3JtX3ZlcnNpb24nOiBwbGF0Zm9ybS52ZXJzaW9uKCksCiAgICAgICAgICAgICAgICAnYXJjaGl0ZWN0dXJlJzogcGxhdGZvcm0ubWFjaGluZSgpLAogICAgICAgICAgICAgICAgJ3Byb2Nlc3Nvcic6IHBsYXRmb3JtLnByb2Nlc3NvcigpLAogICAgICAgICAgICAgICAgJ2lwX2FkZHJlc3Nlcyc6IHNlbGYuZ2V0X2lwX2FkZHJlc3NlcygpLAogICAgICAgICAgICAgICAgJ21lbW9yeSc6IGRpY3QocHN1dGlsLnZpcnR1YWxfbWVtb3J5KCkuX2FzZGljdCgpKSwKICAgICAgICAgICAgICAgICdkaXNrJzogW2RpY3QocHN1dGlsLmRpc2tfdXNhZ2UocGFydGl0aW9uLm1vdW50cG9pbnQpLl9hc2RpY3QoKSkgCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBwYXJ0aXRpb24gaW4gcHN1dGlsLmRpc2tfcGFydGl0aW9ucygpXSwKICAgICAgICAgICAgICAgICdjcHVfY291bnQnOiBwc3V0aWwuY3B1X2NvdW50KCksCiAgICAgICAgICAgICAgICAnYm9vdF90aW1lJzogcHN1dGlsLmJvb3RfdGltZSgpLAogICAgICAgICAgICAgICAgJ3VzZXJzJzogW3VzZXIuX2FzZGljdCgpIGZvciB1c2VyIGluIHBzdXRpbC51c2VycygpXSwKICAgICAgICAgICAgICAgICduZXR3b3JrX2ludGVyZmFjZXMnOiBzZWxmLmdldF9uZXR3b3JrX2ludGVyZmFjZXMoKSwKICAgICAgICAgICAgICAgICdydW5uaW5nX3Byb2Nlc3Nlcyc6IHNlbGYuZ2V0X3J1bm5pbmdfcHJvY2Vzc2VzKClbOjUwXSwgICMgTGltaXQgdG8gNTAgcHJvY2Vzc2VzCiAgICAgICAgICAgICAgICAnaW5zdGFsbGVkX3BhY2thZ2VzJzogc2VsZi5nZXRfaW5zdGFsbGVkX3BhY2thZ2VzKCksCiAgICAgICAgICAgICAgICAnc2VydmljZXMnOiBzZWxmLmdldF9zZXJ2aWNlcygpLAogICAgICAgICAgICAgICAgJ3NjYW5fdGltZXN0YW1wJzogZGF0ZXRpbWUubm93KCkuaXNvZm9ybWF0KCkKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaW5mbwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiRXJyb3IgY29sbGVjdGluZyBzeXN0ZW0gaW5mbzoge2V9IikKICAgICAgICAgICAgcmV0dXJuIHt9CiAgICAKICAgIGRlZiBnZXRfaXBfYWRkcmVzc2VzKHNlbGYpOgogICAgICAgICIiIkdldCBhbGwgSVAgYWRkcmVzc2VzIiIiCiAgICAgICAgYWRkcmVzc2VzID0gW10KICAgICAgICBmb3IgaW50ZXJmYWNlLCBhZGRycyBpbiBwc3V0aWwubmV0X2lmX2FkZHJzKCkuaXRlbXMoKToKICAgICAgICAgICAgZm9yIGFkZHIgaW4gYWRkcnM6CiAgICAgICAgICAgICAgICBpZiBhZGRyLmZhbWlseSA9PSBzb2NrZXQuQUZfSU5FVDoKICAgICAgICAgICAgICAgICAgICBhZGRyZXNzZXMuYXBwZW5kKGFkZHIuYWRkcmVzcykKICAgICAgICByZXR1cm4gYWRkcmVzc2VzCiAgICAKICAgIGRlZiBnZXRfbmV0d29ya19pbnRlcmZhY2VzKHNlbGYpOgogICAgICAgICIiIkdldCBuZXR3b3JrIGludGVyZmFjZSBpbmZvcm1hdGlvbiIiIgogICAgICAgIGludGVyZmFjZXMgPSB7fQogICAgICAgIGZvciBpbnRlcmZhY2UsIGFkZHJzIGluIHBzdXRpbC5uZXRfaWZfYWRkcnMoKS5pdGVtcygpOgogICAgICAgICAgICBpbnRlcmZhY2VzW2ludGVyZmFjZV0gPSBbXQogICAgICAgICAgICBmb3IgYWRkciBpbiBhZGRyczoKICAgICAgICAgICAgICAgIGludGVyZmFjZXNbaW50ZXJmYWNlXS5hcHBlbmQoewogICAgICAgICAgICAgICAgICAgICdmYW1pbHknOiBzdHIoYWRkci5mYW1pbHkpLAogICAgICAgICAgICAgICAgICAgICdhZGRyZXNzJzogYWRkci5hZGRyZXNzLAogICAgICAgICAgICAgICAgICAgICduZXRtYXNrJzogYWRkci5uZXRtYXNrLAogICAgICAgICAgICAgICAgICAgICdicm9hZGNhc3QnOiBhZGRyLmJyb2FkY2FzdAogICAgICAgICAgICAgICAgfSkKICAgICAgICByZXR1cm4gaW50ZXJmYWNlcwogICAgCiAgICBkZWYgZ2V0X3J1bm5pbmdfcHJvY2Vzc2VzKHNlbGYpOgogICAgICAgICIiIkdldCBydW5uaW5nIHByb2Nlc3NlcyB3aXRoIHNlY3VyaXR5IHJlbGV2YW5jZSIiIgogICAgICAgIHByb2Nlc3NlcyA9IFtdCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmb3IgcHJvYyBpbiBwc3V0aWwucHJvY2Vzc19pdGVyKFsncGlkJywgJ25hbWUnLCAndXNlcm5hbWUnLCAnY21kbGluZScsICdjb25uZWN0aW9ucyddKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBwcm9jZXNzZXMuYXBwZW5kKHByb2MuaW5mbykKICAgICAgICAgICAgICAgIGV4Y2VwdCAocHN1dGlsLk5vU3VjaFByb2Nlc3MsIHBzdXRpbC5BY2Nlc3NEZW5pZWQpOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJFcnJvciBnZXR0aW5nIHByb2Nlc3Nlczoge2V9IikKICAgICAgICByZXR1cm4gcHJvY2Vzc2VzCiAgICAKICAgIGRlZiBnZXRfaW5zdGFsbGVkX3BhY2thZ2VzKHNlbGYpOgogICAgICAgICIiIkdldCBpbnN0YWxsZWQgcGFja2FnZXMgYmFzZWQgb24gcGxhdGZvcm0iIiIKICAgICAgICBwYWNrYWdlcyA9IFtdCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBzZWxmLnBsYXRmb3JtID09ICdMaW51eCc6CiAgICAgICAgICAgICAgICAjIFRyeSBtdWx0aXBsZSBwYWNrYWdlIG1hbmFnZXJzCiAgICAgICAgICAgICAgICBwYWNrYWdlX2NvbW1hbmRzID0gWwogICAgICAgICAgICAgICAgICAgIFsnZHBrZycsICctbCddLCAgIyBEZWJpYW4vVWJ1bnR1CiAgICAgICAgICAgICAgICAgICAgWydycG0nLCAnLXFhJ10sICAjIFJlZEhhdC9DZW50T1MKICAgICAgICAgICAgICAgICAgICBbJ3BhY21hbicsICctUSddICAjIEFyY2gKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIGNtZCBpbiBwYWNrYWdlX2NvbW1hbmRzOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gc3VicHJvY2Vzcy5ydW4oY21kLCBjYXB0dXJlX291dHB1dD1UcnVlLCB0ZXh0PVRydWUsIHRpbWVvdXQ9MzApCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHJlc3VsdC5yZXR1cm5jb2RlID09IDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWNrYWdlcy5leHRlbmQocmVzdWx0LnN0ZG91dC5zcGxpdGxpbmVzKCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCAoc3VicHJvY2Vzcy5UaW1lb3V0RXhwaXJlZCwgRmlsZU5vdEZvdW5kRXJyb3IpOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZWxpZiBzZWxmLnBsYXRmb3JtID09ICdXaW5kb3dzJzoKICAgICAgICAgICAgICAgICMgVXNlIFBvd2VyU2hlbGwgdG8gZ2V0IGluc3RhbGxlZCBwcm9ncmFtcwogICAgICAgICAgICAgICAgY21kID0gWydwb3dlcnNoZWxsJywgJy1Db21tYW5kJywgJ0dldC1XbWlPYmplY3QgLUNsYXNzIFdpbjMyX1Byb2R1Y3QgfCBTZWxlY3QtT2JqZWN0IE5hbWUsIFZlcnNpb24nXQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHN1YnByb2Nlc3MucnVuKGNtZCwgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSwgdGV4dD1UcnVlLCB0aW1lb3V0PTYwKQogICAgICAgICAgICAgICAgICAgIGlmIHJlc3VsdC5yZXR1cm5jb2RlID09IDA6CiAgICAgICAgICAgICAgICAgICAgICAgIHBhY2thZ2VzID0gcmVzdWx0LnN0ZG91dC5zcGxpdGxpbmVzKCkKICAgICAgICAgICAgICAgIGV4Y2VwdCAoc3VicHJvY2Vzcy5UaW1lb3V0RXhwaXJlZCwgRmlsZU5vdEZvdW5kRXJyb3IpOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkVycm9yIGdldHRpbmcgcGFja2FnZXM6IHtlfSIpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHBhY2thZ2VzWzoxMDBdICAjIExpbWl0IHRvIDEwMCBwYWNrYWdlcwogICAgCiAgICBkZWYgZ2V0X3NlcnZpY2VzKHNlbGYpOgogICAgICAgICIiIkdldCBydW5uaW5nIHNlcnZpY2VzIiIiCiAgICAgICAgc2VydmljZXMgPSBbXQogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgc2VsZi5wbGF0Zm9ybSA9PSAnTGludXgnOgogICAgICAgICAgICAgICAgIyBVc2Ugc3lzdGVtY3RsIHRvIGdldCBzZXJ2aWNlcwogICAgICAgICAgICAgICAgcmVzdWx0ID0gc3VicHJvY2Vzcy5ydW4oWydzeXN0ZW1jdGwnLCAnbGlzdC11bml0cycsICctLXR5cGU9c2VydmljZScsICctLXN0YXRlPWFjdGl2ZSddLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlX291dHB1dD1UcnVlLCB0ZXh0PVRydWUsIHRpbWVvdXQ9MzApCiAgICAgICAgICAgICAgICBpZiByZXN1bHQucmV0dXJuY29kZSA9PSAwOgogICAgICAgICAgICAgICAgICAgIHNlcnZpY2VzID0gcmVzdWx0LnN0ZG91dC5zcGxpdGxpbmVzKCkKICAgICAgICAgICAgZWxpZiBzZWxmLnBsYXRmb3JtID09ICdXaW5kb3dzJzoKICAgICAgICAgICAgICAgICMgVXNlIFBvd2VyU2hlbGwgdG8gZ2V0IHNlcnZpY2VzCiAgICAgICAgICAgICAgICByZXN1bHQgPSBzdWJwcm9jZXNzLnJ1bihbJ3Bvd2Vyc2hlbGwnLCAnLUNvbW1hbmQnLCAnR2V0LVNlcnZpY2UgfCBXaGVyZS1PYmplY3QgeyRfLlN0YXR1cyAtZXEgIlJ1bm5pbmcifSddLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlX291dHB1dD1UcnVlLCB0ZXh0PVRydWUsIHRpbWVvdXQ9MzApCiAgICAgICAgICAgICAgICBpZiByZXN1bHQucmV0dXJuY29kZSA9PSAwOgogICAgICAgICAgICAgICAgICAgIHNlcnZpY2VzID0gcmVzdWx0LnN0ZG91dC5zcGxpdGxpbmVzKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkVycm9yIGdldHRpbmcgc2VydmljZXM6IHtlfSIpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHNlcnZpY2VzWzo1MF0gICMgTGltaXQgdG8gNTAgc2VydmljZXMKICAgIAogICAgZGVmIGNoZWNrX3Z1bG5lcmFiaWxpdGllcyhzZWxmKToKICAgICAgICAiIiJDaGVjayBmb3IgY29tbW9uIHZ1bG5lcmFiaWxpdGllcyIiIgogICAgICAgIHZ1bG5lcmFiaWxpdGllcyA9IFtdCiAgICAgICAgCiAgICAgICAgIyBDaGVjayBmb3IgY29tbW9uIG1pc2NvbmZpZ3VyYXRpb25zCiAgICAgICAgbWlzY29uZmlncyA9IHNlbGYuY2hlY2tfbWlzY29uZmlndXJhdGlvbnMoKQogICAgICAgIHZ1bG5lcmFiaWxpdGllcy5leHRlbmQobWlzY29uZmlncykKICAgICAgICAKICAgICAgICAjIENoZWNrIGZvciBvdXRkYXRlZCBzb2Z0d2FyZQogICAgICAgIG91dGRhdGVkID0gc2VsZi5jaGVja19vdXRkYXRlZF9zb2Z0d2FyZSgpCiAgICAgICAgdnVsbmVyYWJpbGl0aWVzLmV4dGVuZChvdXRkYXRlZCkKICAgICAgICAKICAgICAgICAjIENoZWNrIG5ldHdvcmsgc2VjdXJpdHkKICAgICAgICBuZXR3b3JrX2lzc3VlcyA9IHNlbGYuY2hlY2tfbmV0d29ya19zZWN1cml0eSgpCiAgICAgICAgdnVsbmVyYWJpbGl0aWVzLmV4dGVuZChuZXR3b3JrX2lzc3VlcykKICAgICAgICAKICAgICAgICByZXR1cm4gdnVsbmVyYWJpbGl0aWVzCiAgICAKICAgIGRlZiBjaGVja19taXNjb25maWd1cmF0aW9ucyhzZWxmKToKICAgICAgICAiIiJDaGVjayBmb3IgY29tbW9uIHNlY3VyaXR5IG1pc2NvbmZpZ3VyYXRpb25zIiIiCiAgICAgICAgbWlzY29uZmlncyA9IFtdCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBzZWxmLnBsYXRmb3JtID09ICdMaW51eCc6CiAgICAgICAgICAgICAgICAjIENoZWNrIFNTSCBjb25maWd1cmF0aW9uCiAgICAgICAgICAgICAgICBzc2hfY29uZmlnID0gUGF0aCgnL2V0Yy9zc2gvc3NoZF9jb25maWcnKQogICAgICAgICAgICAgICAgaWYgc3NoX2NvbmZpZy5leGlzdHMoKToKICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4oc3NoX2NvbmZpZywgJ3InKSBhcyBmOgogICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gZi5yZWFkKCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgJ1Blcm1pdFJvb3RMb2dpbiB5ZXMnIGluIGNvbnRlbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaXNjb25maWdzLmFwcGVuZCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3R5cGUnOiAnbWlzY29uZmlndXJhdGlvbicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3RpdGxlJzogJ1NTSCBSb290IExvZ2luIEVuYWJsZWQnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkZXNjcmlwdGlvbic6ICdTU0ggaXMgY29uZmlndXJlZCB0byBhbGxvdyBkaXJlY3Qgcm9vdCBsb2dpbicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3NldmVyaXR5JzogJ2hpZ2gnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdmaWxlJzogc3RyKHNzaF9jb25maWcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICBpZiAnUGFzc3dvcmRBdXRoZW50aWNhdGlvbiB5ZXMnIGluIGNvbnRlbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaXNjb25maWdzLmFwcGVuZCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3R5cGUnOiAnbWlzY29uZmlndXJhdGlvbicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3RpdGxlJzogJ1NTSCBQYXNzd29yZCBBdXRoZW50aWNhdGlvbiBFbmFibGVkJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGVzY3JpcHRpb24nOiAnU1NIIGFsbG93cyBwYXNzd29yZCBhdXRoZW50aWNhdGlvbiBpbnN0ZWFkIG9mIGtleS1iYXNlZCBvbmx5JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc2V2ZXJpdHknOiAnbWVkaXVtJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZmlsZSc6IHN0cihzc2hfY29uZmlnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBDaGVjayBmb3Igd29ybGQtd3JpdGFibGUgZmlsZXMKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHN1YnByb2Nlc3MucnVuKFsnZmluZCcsICcvZXRjJywgJy10eXBlJywgJ2YnLCAnLXBlcm0nLCAnLTAwMiddLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlX291dHB1dD1UcnVlLCB0ZXh0PVRydWUsIHRpbWVvdXQ9MzApCiAgICAgICAgICAgICAgICBpZiByZXN1bHQuc3Rkb3V0OgogICAgICAgICAgICAgICAgICAgIG1pc2NvbmZpZ3MuYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgJ3R5cGUnOiAnbWlzY29uZmlndXJhdGlvbicsCiAgICAgICAgICAgICAgICAgICAgICAgICd0aXRsZSc6ICdXb3JsZC1Xcml0YWJsZSBDb25maWd1cmF0aW9uIEZpbGVzJywKICAgICAgICAgICAgICAgICAgICAgICAgJ2Rlc2NyaXB0aW9uJzogJ0ZvdW5kIGNvbmZpZ3VyYXRpb24gZmlsZXMgd3JpdGFibGUgYnkgYWxsIHVzZXJzJywKICAgICAgICAgICAgICAgICAgICAgICAgJ3NldmVyaXR5JzogJ2hpZ2gnLAogICAgICAgICAgICAgICAgICAgICAgICAnZmlsZXMnOiByZXN1bHQuc3Rkb3V0LnNwbGl0bGluZXMoKVs6MTBdCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkVycm9yIGNoZWNraW5nIG1pc2NvbmZpZ3VyYXRpb25zOiB7ZX0iKQogICAgICAgIAogICAgICAgIHJldHVybiBtaXNjb25maWdzCiAgICAKICAgIGRlZiBjaGVja19vdXRkYXRlZF9zb2Z0d2FyZShzZWxmKToKICAgICAgICAiIiJDaGVjayBmb3Igb3V0ZGF0ZWQgc29mdHdhcmUgd2l0aCBrbm93biB2dWxuZXJhYmlsaXRpZXMiIiIKICAgICAgICB2dWxuZXJhYmlsaXRpZXMgPSBbXQogICAgICAgIAogICAgICAgICMgVGhpcyBpcyBhIHNpbXBsaWZpZWQgY2hlY2sgLSBpbiBwcm9kdWN0aW9uLCB5b3UnZCBpbnRlZ3JhdGUgd2l0aCBDVkUgZGF0YWJhc2VzCiAgICAgICAgb3V0ZGF0ZWRfcGF0dGVybnMgPSBbCiAgICAgICAgICAgICdvcGVuc3NsLTEuMCcsCiAgICAgICAgICAgICdhcGFjaGUyLTIuMicsCiAgICAgICAgICAgICduZ2lueC0xLjAnLAogICAgICAgICAgICAnbXlzcWwtNS41JywKICAgICAgICAgICAgJ3BocC01LjYnCiAgICAgICAgXQogICAgICAgIAogICAgICAgIHBhY2thZ2VzID0gc2VsZi5nZXRfaW5zdGFsbGVkX3BhY2thZ2VzKCkKICAgICAgICBmb3IgcGFja2FnZSBpbiBwYWNrYWdlczoKICAgICAgICAgICAgZm9yIHBhdHRlcm4gaW4gb3V0ZGF0ZWRfcGF0dGVybnM6CiAgICAgICAgICAgICAgICBpZiBwYXR0ZXJuIGluIHBhY2thZ2UubG93ZXIoKToKICAgICAgICAgICAgICAgICAgICB2dWxuZXJhYmlsaXRpZXMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgJ3R5cGUnOiAndnVsbmVyYWJpbGl0eScsCiAgICAgICAgICAgICAgICAgICAgICAgICd0aXRsZSc6IGYnT3V0ZGF0ZWQgU29mdHdhcmU6IHtwYWNrYWdlfScsCiAgICAgICAgICAgICAgICAgICAgICAgICdkZXNjcmlwdGlvbic6IGYnUG90ZW50aWFsbHkgdnVsbmVyYWJsZSB2ZXJzaW9uIGRldGVjdGVkOiB7cGFja2FnZX0nLAogICAgICAgICAgICAgICAgICAgICAgICAnc2V2ZXJpdHknOiAnbWVkaXVtJywKICAgICAgICAgICAgICAgICAgICAgICAgJ3BhY2thZ2UnOiBwYWNrYWdlLAogICAgICAgICAgICAgICAgICAgICAgICAncmVjb21tZW5kYXRpb24nOiBmJ1VwZGF0ZSB7cGF0dGVybn0gdG8gbGF0ZXN0IHZlcnNpb24nCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAKICAgICAgICByZXR1cm4gdnVsbmVyYWJpbGl0aWVzCiAgICAKICAgIGRlZiBjaGVja19uZXR3b3JrX3NlY3VyaXR5KHNlbGYpOgogICAgICAgICIiIkNoZWNrIG5ldHdvcmsgc2VjdXJpdHkgY29uZmlndXJhdGlvbiIiIgogICAgICAgIGlzc3VlcyA9IFtdCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIENoZWNrIGZvciBvcGVuIHBvcnRzCiAgICAgICAgICAgIGNvbm5lY3Rpb25zID0gcHN1dGlsLm5ldF9jb25uZWN0aW9ucyhraW5kPSdpbmV0JykKICAgICAgICAgICAgbGlzdGVuaW5nX3BvcnRzID0gW2Nvbm4ubGFkZHIucG9ydCBmb3IgY29ubiBpbiBjb25uZWN0aW9ucyBpZiBjb25uLnN0YXR1cyA9PSAnTElTVEVOJ10KICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ29tbW9uIHZ1bG5lcmFibGUgcG9ydHMKICAgICAgICAgICAgdnVsbmVyYWJsZV9wb3J0cyA9IHsKICAgICAgICAgICAgICAgIDIxOiAnRlRQJywKICAgICAgICAgICAgICAgIDIzOiAnVGVsbmV0JywgCiAgICAgICAgICAgICAgICAyNTogJ1NNVFAnLAogICAgICAgICAgICAgICAgNTM6ICdETlMnLAogICAgICAgICAgICAgICAgODA6ICdIVFRQJywKICAgICAgICAgICAgICAgIDExMDogJ1BPUDMnLAogICAgICAgICAgICAgICAgMTQzOiAnSU1BUCcsCiAgICAgICAgICAgICAgICA0NDM6ICdIVFRQUycsCiAgICAgICAgICAgICAgICA5OTM6ICdJTUFQUycsCiAgICAgICAgICAgICAgICA5OTU6ICdQT1AzUycKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIHBvcnQgaW4gbGlzdGVuaW5nX3BvcnRzOgogICAgICAgICAgICAgICAgaWYgcG9ydCBpbiB2dWxuZXJhYmxlX3BvcnRzOgogICAgICAgICAgICAgICAgICAgIGlzc3Vlcy5hcHBlbmQoewogICAgICAgICAgICAgICAgICAgICAgICAndHlwZSc6ICduZXR3b3JrX2V4cG9zdXJlJywKICAgICAgICAgICAgICAgICAgICAgICAgJ3RpdGxlJzogZid7dnVsbmVyYWJsZV9wb3J0c1twb3J0XX0gU2VydmljZSBFeHBvc2VkJywKICAgICAgICAgICAgICAgICAgICAgICAgJ2Rlc2NyaXB0aW9uJzogZidTZXJ2aWNlIHt2dWxuZXJhYmxlX3BvcnRzW3BvcnRdfSBpcyBsaXN0ZW5pbmcgb24gcG9ydCB7cG9ydH0nLAogICAgICAgICAgICAgICAgICAgICAgICAnc2V2ZXJpdHknOiAnbWVkaXVtJyBpZiBwb3J0IGluIFs0NDMsIDk5MywgOTk1XSBlbHNlICdoaWdoJywKICAgICAgICAgICAgICAgICAgICAgICAgJ3BvcnQnOiBwb3J0LAogICAgICAgICAgICAgICAgICAgICAgICAnc2VydmljZSc6IHZ1bG5lcmFibGVfcG9ydHNbcG9ydF0KICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiRXJyb3IgY2hlY2tpbmcgbmV0d29yayBzZWN1cml0eToge2V9IikKICAgICAgICAKICAgICAgICByZXR1cm4gaXNzdWVzCiAgICAKICAgIGRlZiBydW5fY29tcGxpYW5jZV9jaGVjayhzZWxmLCBmcmFtZXdvcms9J0NJUycpOgogICAgICAgICIiIlJ1biBjb21wbGlhbmNlIGNoZWNrcyBhZ2FpbnN0IHNlY3VyaXR5IGZyYW1ld29ya3MiIiIKICAgICAgICBjb21wbGlhbmNlX3Jlc3VsdHMgPSBbXQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgZnJhbWV3b3JrID09ICdDSVMnIGFuZCBzZWxmLnBsYXRmb3JtID09ICdMaW51eCc6CiAgICAgICAgICAgICAgICAjIEJhc2ljIENJUyBjaGVja3MKICAgICAgICAgICAgICAgIGNoZWNrcyA9IFsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICdjb250cm9sJzogJ0NJUy0xLjEuMScsCiAgICAgICAgICAgICAgICAgICAgICAgICdkZXNjcmlwdGlvbic6ICdFbnN1cmUgbW91bnRpbmcgb2YgY3JhbWZzIGZpbGVzeXN0ZW1zIGlzIGRpc2FibGVkJywKICAgICAgICAgICAgICAgICAgICAgICAgJ2NoZWNrJzogc2VsZi5jaGVja19jcmFtZnNfZGlzYWJsZWQoKQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAnY29udHJvbCc6ICdDSVMtMi4yLjEnLCAKICAgICAgICAgICAgICAgICAgICAgICAgJ2Rlc2NyaXB0aW9uJzogJ0Vuc3VyZSB4aW5ldGQgaXMgbm90IGluc3RhbGxlZCcsCiAgICAgICAgICAgICAgICAgICAgICAgICdjaGVjayc6IHNlbGYuY2hlY2tfeGluZXRkX25vdF9pbnN0YWxsZWQoKQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAnY29udHJvbCc6ICdDSVMtNS4yLjEnLAogICAgICAgICAgICAgICAgICAgICAgICAnZGVzY3JpcHRpb24nOiAnRW5zdXJlIHBlcm1pc3Npb25zIG9uIC9ldGMvc3NoL3NzaGRfY29uZmlnIGFyZSBjb25maWd1cmVkJywKICAgICAgICAgICAgICAgICAgICAgICAgJ2NoZWNrJzogc2VsZi5jaGVja19zc2hkX2NvbmZpZ19wZXJtaXNzaW9ucygpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IgY2hlY2sgaW4gY2hlY2tzOgogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGNoZWNrWydjaGVjayddCiAgICAgICAgICAgICAgICAgICAgY29tcGxpYW5jZV9yZXN1bHRzLmFwcGVuZCh7CiAgICAgICAgICAgICAgICAgICAgICAgICdmcmFtZXdvcmsnOiBmcmFtZXdvcmssCiAgICAgICAgICAgICAgICAgICAgICAgICdjb250cm9sJzogY2hlY2tbJ2NvbnRyb2wnXSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2Rlc2NyaXB0aW9uJzogY2hlY2tbJ2Rlc2NyaXB0aW9uJ10sCiAgICAgICAgICAgICAgICAgICAgICAgICdzdGF0dXMnOiAncGFzcycgaWYgcmVzdWx0IGVsc2UgJ2ZhaWwnLAogICAgICAgICAgICAgICAgICAgICAgICAnc2V2ZXJpdHknOiAnbWVkaXVtJwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJFcnJvciBydW5uaW5nIGNvbXBsaWFuY2UgY2hlY2tzOiB7ZX0iKQogICAgICAgIAogICAgICAgIHJldHVybiBjb21wbGlhbmNlX3Jlc3VsdHMKICAgIAogICAgZGVmIGNoZWNrX2NyYW1mc19kaXNhYmxlZChzZWxmKToKICAgICAgICAiIiJDaGVjayBpZiBjcmFtZnMgZmlsZXN5c3RlbSBtb3VudGluZyBpcyBkaXNhYmxlZCIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzdWx0ID0gc3VicHJvY2Vzcy5ydW4oWydtb2Rwcm9iZScsICctbicsICctdicsICdjcmFtZnMnXSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlX291dHB1dD1UcnVlLCB0ZXh0PVRydWUpCiAgICAgICAgICAgIHJldHVybiAnaW5zdGFsbCAvYmluL3RydWUnIGluIHJlc3VsdC5zdGRlcnIKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgY2hlY2tfeGluZXRkX25vdF9pbnN0YWxsZWQoc2VsZik6CiAgICAgICAgIiIiQ2hlY2sgaWYgeGluZXRkIGlzIG5vdCBpbnN0YWxsZWQiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlc3VsdCA9IHN1YnByb2Nlc3MucnVuKFsnd2hpY2gnLCAneGluZXRkJ10sIGNhcHR1cmVfb3V0cHV0PVRydWUpCiAgICAgICAgICAgIHJldHVybiByZXN1bHQucmV0dXJuY29kZSAhPSAwCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgCiAgICBkZWYgY2hlY2tfc3NoZF9jb25maWdfcGVybWlzc2lvbnMoc2VsZik6CiAgICAgICAgIiIiQ2hlY2sgU1NIIGNvbmZpZyBmaWxlIHBlcm1pc3Npb25zIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzc2hfY29uZmlnID0gUGF0aCgnL2V0Yy9zc2gvc3NoZF9jb25maWcnKQogICAgICAgICAgICBpZiBzc2hfY29uZmlnLmV4aXN0cygpOgogICAgICAgICAgICAgICAgc3RhdCA9IHNzaF9jb25maWcuc3RhdCgpCiAgICAgICAgICAgICAgICAjIFNob3VsZCBiZSA2MDAgKG93bmVyIHJlYWQvd3JpdGUgb25seSkKICAgICAgICAgICAgICAgIHJldHVybiBvY3Qoc3RhdC5zdF9tb2RlKVstMzpdID09ICc2MDAnCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBnZW5lcmF0ZV9yZXBvcnQoc2VsZik6CiAgICAgICAgIiIiR2VuZXJhdGUgY29tcHJlaGVuc2l2ZSBzZWN1cml0eSByZXBvcnQiIiIKICAgICAgICBsb2dnZXIuaW5mbygiU3RhcnRpbmcgVnVsbkd1YXJkIHNlY3VyaXR5IHNjYW4uLi4iKQogICAgICAgIAogICAgICAgIHJlcG9ydCA9IHsKICAgICAgICAgICAgJ2FnZW50X2lkJzogc2VsZi5hZ2VudF9pZCwKICAgICAgICAgICAgJ3NjYW5fdHlwZSc6ICdjb21wcmVoZW5zaXZlJywKICAgICAgICAgICAgJ3RpbWVzdGFtcCc6IGRhdGV0aW1lLm5vdygpLmlzb2Zvcm1hdCgpLAogICAgICAgICAgICAnc3lzdGVtX2luZm8nOiBzZWxmLmdldF9zeXN0ZW1faW5mbygpLAogICAgICAgICAgICAndnVsbmVyYWJpbGl0aWVzJzogc2VsZi5jaGVja192dWxuZXJhYmlsaXRpZXMoKSwKICAgICAgICAgICAgJ2NvbXBsaWFuY2VfcmVzdWx0cyc6IHNlbGYucnVuX2NvbXBsaWFuY2VfY2hlY2soJ0NJUycpLAogICAgICAgICAgICAnc3VtbWFyeSc6IHt9CiAgICAgICAgfQogICAgICAgIAogICAgICAgICMgR2VuZXJhdGUgc3VtbWFyeQogICAgICAgIHZ1bG5zID0gcmVwb3J0Wyd2dWxuZXJhYmlsaXRpZXMnXQogICAgICAgIGNvbXBsaWFuY2UgPSByZXBvcnRbJ2NvbXBsaWFuY2VfcmVzdWx0cyddCiAgICAgICAgCiAgICAgICAgcmVwb3J0WydzdW1tYXJ5J10gPSB7CiAgICAgICAgICAgICd0b3RhbF92dWxuZXJhYmlsaXRpZXMnOiBsZW4odnVsbnMpLAogICAgICAgICAgICAnY3JpdGljYWxfdnVsbmVyYWJpbGl0aWVzJzogbGVuKFt2IGZvciB2IGluIHZ1bG5zIGlmIHYuZ2V0KCdzZXZlcml0eScpID09ICdjcml0aWNhbCddKSwKICAgICAgICAgICAgJ2hpZ2hfdnVsbmVyYWJpbGl0aWVzJzogbGVuKFt2IGZvciB2IGluIHZ1bG5zIGlmIHYuZ2V0KCdzZXZlcml0eScpID09ICdoaWdoJ10pLAogICAgICAgICAgICAnbWVkaXVtX3Z1bG5lcmFiaWxpdGllcyc6IGxlbihbdiBmb3IgdiBpbiB2dWxucyBpZiB2LmdldCgnc2V2ZXJpdHknKSA9PSAnbWVkaXVtJ10pLAogICAgICAgICAgICAnbG93X3Z1bG5lcmFiaWxpdGllcyc6IGxlbihbdiBmb3IgdiBpbiB2dWxucyBpZiB2LmdldCgnc2V2ZXJpdHknKSA9PSAnbG93J10pLAogICAgICAgICAgICAnY29tcGxpYW5jZV9wYXNzZWQnOiBsZW4oW2MgZm9yIGMgaW4gY29tcGxpYW5jZSBpZiBjLmdldCgnc3RhdHVzJykgPT0gJ3Bhc3MnXSksCiAgICAgICAgICAgICdjb21wbGlhbmNlX2ZhaWxlZCc6IGxlbihbYyBmb3IgYyBpbiBjb21wbGlhbmNlIGlmIGMuZ2V0KCdzdGF0dXMnKSA9PSAnZmFpbCddKSwKICAgICAgICAgICAgJ3Jpc2tfc2NvcmUnOiBzZWxmLmNhbGN1bGF0ZV9yaXNrX3Njb3JlKHZ1bG5zLCBjb21wbGlhbmNlKQogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gcmVwb3J0CiAgICAKICAgIGRlZiBjYWxjdWxhdGVfcmlza19zY29yZShzZWxmLCB2dWxuZXJhYmlsaXRpZXMsIGNvbXBsaWFuY2VfcmVzdWx0cyk6CiAgICAgICAgIiIiQ2FsY3VsYXRlIG92ZXJhbGwgcmlzayBzY29yZSIiIgogICAgICAgIHNjb3JlID0gMAogICAgICAgIAogICAgICAgICMgVnVsbmVyYWJpbGl0eSBzY29yaW5nCiAgICAgICAgZm9yIHZ1bG4gaW4gdnVsbmVyYWJpbGl0aWVzOgogICAgICAgICAgICBzZXZlcml0eSA9IHZ1bG4uZ2V0KCdzZXZlcml0eScsICdsb3cnKQogICAgICAgICAgICBpZiBzZXZlcml0eSA9PSAnY3JpdGljYWwnOgogICAgICAgICAgICAgICAgc2NvcmUgKz0gMTAKICAgICAgICAgICAgZWxpZiBzZXZlcml0eSA9PSAnaGlnaCc6CiAgICAgICAgICAgICAgICBzY29yZSArPSA3CiAgICAgICAgICAgIGVsaWYgc2V2ZXJpdHkgPT0gJ21lZGl1bSc6CiAgICAgICAgICAgICAgICBzY29yZSArPSA0CiAgICAgICAgICAgIGVsaWYgc2V2ZXJpdHkgPT0gJ2xvdyc6CiAgICAgICAgICAgICAgICBzY29yZSArPSAxCiAgICAgICAgCiAgICAgICAgIyBDb21wbGlhbmNlIHNjb3JpbmcKICAgICAgICBmYWlsZWRfY29udHJvbHMgPSBsZW4oW2MgZm9yIGMgaW4gY29tcGxpYW5jZV9yZXN1bHRzIGlmIGMuZ2V0KCdzdGF0dXMnKSA9PSAnZmFpbCddKQogICAgICAgIHNjb3JlICs9IGZhaWxlZF9jb250cm9scyAqIDIKICAgICAgICAKICAgICAgICAjIE5vcm1hbGl6ZSB0byAwLTEwMCBzY2FsZQogICAgICAgIHJldHVybiBtaW4oc2NvcmUsIDEwMCkKICAgIAogICAgZGVmIHNhdmVfcmVwb3J0KHNlbGYsIHJlcG9ydCk6CiAgICAgICAgIiIiU2F2ZSByZXBvcnQgdG8gbG9jYWwgZmlsZSIiIgogICAgICAgIHRpbWVzdGFtcCA9IGRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCclWSVtJWRfJUglTSVTJykKICAgICAgICBmaWxlbmFtZSA9IGYicmVzdWx0cy92dWxuZ3VhcmRfcmVwb3J0X3tzZWxmLmhvc3RuYW1lfV97dGltZXN0YW1wfS5qc29uIgogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVuYW1lLCAndycpIGFzIGY6CiAgICAgICAgICAgICAgICBqc29uLmR1bXAocmVwb3J0LCBmLCBpbmRlbnQ9MiwgZGVmYXVsdD1zdHIpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVwb3J0IHNhdmVkIHRvIHtmaWxlbmFtZX0iKQogICAgICAgICAgICByZXR1cm4gZmlsZW5hbWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkVycm9yIHNhdmluZyByZXBvcnQ6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAKICAgIGRlZiB1cGxvYWRfcmVwb3J0KHNlbGYsIHJlcG9ydCk6CiAgICAgICAgIiIiVXBsb2FkIHJlcG9ydCB0byBWdWxuR3VhcmQgc2VydmVyIiIiCiAgICAgICAgaWYgbm90IHNlbGYuc2VydmVyX3VybDoKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIk5vIHNlcnZlciBVUkwgY29uZmlndXJlZCwgc2tpcHBpbmcgdXBsb2FkIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBoZWFkZXJzID0gewogICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogZidCZWFyZXIge3NlbGYuYXBpX2tleX0nIGlmIHNlbGYuYXBpX2tleSBlbHNlICcnCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHVybCA9IGYie3NlbGYuc2VydmVyX3VybH0vYXBpL2FnZW50L3JlcG9ydCIKICAgICAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5wb3N0KHVybCwganNvbj1yZXBvcnQsIGhlYWRlcnM9aGVhZGVycywgdGltZW91dD0zMCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJSZXBvcnQgdXBsb2FkZWQgc3VjY2Vzc2Z1bGx5IikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJVcGxvYWQgZmFpbGVkOiB7cmVzcG9uc2Uuc3RhdHVzX2NvZGV9IC0ge3Jlc3BvbnNlLnRleHR9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJFcnJvciB1cGxvYWRpbmcgcmVwb3J0OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHJ1bl9zY2FuKHNlbGYsIHVwbG9hZD1UcnVlLCBzYXZlX2xvY2FsPVRydWUpOgogICAgICAgICIiIlJ1biBjb21wbGV0ZSBzZWN1cml0eSBzY2FuIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlZ1bG5HdWFyZCBBZ2VudCBzdGFydGluZyBzY2FuIG9uIHtzZWxmLmhvc3RuYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEdlbmVyYXRlIHJlcG9ydAogICAgICAgICAgICByZXBvcnQgPSBzZWxmLmdlbmVyYXRlX3JlcG9ydCgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNhdmUgbG9jYWxseSBpZiByZXF1ZXN0ZWQKICAgICAgICAgICAgZmlsZW5hbWUgPSBOb25lCiAgICAgICAgICAgIGlmIHNhdmVfbG9jYWw6CiAgICAgICAgICAgICAgICBmaWxlbmFtZSA9IHNlbGYuc2F2ZV9yZXBvcnQocmVwb3J0KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBVcGxvYWQgdG8gc2VydmVyIGlmIHJlcXVlc3RlZAogICAgICAgICAgICB1cGxvYWRlZCA9IEZhbHNlCiAgICAgICAgICAgIGlmIHVwbG9hZDoKICAgICAgICAgICAgICAgIHVwbG9hZGVkID0gc2VsZi51cGxvYWRfcmVwb3J0KHJlcG9ydCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUHJpbnQgc3VtbWFyeQogICAgICAgICAgICBzdW1tYXJ5ID0gcmVwb3J0WydzdW1tYXJ5J10KICAgICAgICAgICAgbG9nZ2VyLmluZm8oIj09PSBTQ0FOIFJFU1VMVFMgPT09IikKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUb3RhbCBWdWxuZXJhYmlsaXRpZXM6IHtzdW1tYXJ5Wyd0b3RhbF92dWxuZXJhYmlsaXRpZXMnXX0iKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkNyaXRpY2FsOiB7c3VtbWFyeVsnY3JpdGljYWxfdnVsbmVyYWJpbGl0aWVzJ119IikKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJIaWdoOiB7c3VtbWFyeVsnaGlnaF92dWxuZXJhYmlsaXRpZXMnXX0iKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk1lZGl1bToge3N1bW1hcnlbJ21lZGl1bV92dWxuZXJhYmlsaXRpZXMnXX0iKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkxvdzoge3N1bW1hcnlbJ2xvd192dWxuZXJhYmlsaXRpZXMnXX0iKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkNvbXBsaWFuY2UgUGFzc2VkOiB7c3VtbWFyeVsnY29tcGxpYW5jZV9wYXNzZWQnXX0iKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkNvbXBsaWFuY2UgRmFpbGVkOiB7c3VtbWFyeVsnY29tcGxpYW5jZV9mYWlsZWQnXX0iKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJpc2sgU2NvcmU6IHtzdW1tYXJ5WydyaXNrX3Njb3JlJ119LzEwMCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBmaWxlbmFtZToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVwb3J0IHNhdmVkOiB7ZmlsZW5hbWV9IikKICAgICAgICAgICAgaWYgdXBsb2FkZWQ6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiUmVwb3J0IHVwbG9hZGVkIHRvIFZ1bG5HdWFyZCBzZXJ2ZXIiKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHJlcG9ydAogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIlNjYW4gZmFpbGVkOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gTm9uZQoKZGVmIG1haW4oKToKICAgIHBhcnNlciA9IGFyZ3BhcnNlLkFyZ3VtZW50UGFyc2VyKGRlc2NyaXB0aW9uPSdWdWxuR3VhcmQgU2VjdXJpdHkgU2Nhbm5pbmcgQWdlbnQnKQogICAgcGFyc2VyLmFkZF9hcmd1bWVudCgnLS1zZXJ2ZXInLCBoZWxwPSdWdWxuR3VhcmQgc2VydmVyIFVSTCcpCiAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCctLWFwaS1rZXknLCBoZWxwPSdBUEkga2V5IGZvciBhdXRoZW50aWNhdGlvbicpCiAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCctLW5vLXVwbG9hZCcsIGFjdGlvbj0nc3RvcmVfdHJ1ZScsIGhlbHA9J1NraXAgdXBsb2FkaW5nIHJlc3VsdHMgdG8gc2VydmVyJykKICAgIHBhcnNlci5hZGRfYXJndW1lbnQoJy0tbm8tc2F2ZScsIGFjdGlvbj0nc3RvcmVfdHJ1ZScsIGhlbHA9J1NraXAgc2F2aW5nIHJlc3VsdHMgbG9jYWxseScpCiAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCctLWNvbXBsaWFuY2UnLCBkZWZhdWx0PSdDSVMnLCBoZWxwPSdDb21wbGlhbmNlIGZyYW1ld29yayAoQ0lTLCBOSVNUKScpCiAgICBwYXJzZXIuYWRkX2FyZ3VtZW50KCctLXZlcmJvc2UnLCAnLXYnLCBhY3Rpb249J3N0b3JlX3RydWUnLCBoZWxwPSdWZXJib3NlIG91dHB1dCcpCiAgICAKICAgIGFyZ3MgPSBwYXJzZXIucGFyc2VfYXJncygpCiAgICAKICAgIGlmIGFyZ3MudmVyYm9zZToKICAgICAgICBsb2dnaW5nLmdldExvZ2dlcigpLnNldExldmVsKGxvZ2dpbmcuREVCVUcpCiAgICAKICAgICMgQ3JlYXRlIGFnZW50CiAgICBhZ2VudCA9IFZ1bG5HdWFyZEFnZW50KHNlcnZlcl91cmw9YXJncy5zZXJ2ZXIsIGFwaV9rZXk9YXJncy5hcGlfa2V5KQogICAgCiAgICAjIFJ1biBzY2FuCiAgICByZXN1bHQgPSBhZ2VudC5ydW5fc2NhbigKICAgICAgICB1cGxvYWQ9bm90IGFyZ3Mubm9fdXBsb2FkLAogICAgICAgIHNhdmVfbG9jYWw9bm90IGFyZ3Mubm9fc2F2ZQogICAgKQogICAgCiAgICBpZiByZXN1bHQ6CiAgICAgICAgc3lzLmV4aXQoMCkKICAgIGVsc2U6CiAgICAgICAgc3lzLmV4aXQoMSkKCmlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6CiAgICBtYWluKCk= > "%TEMP%\vulnguard_code.b64"
python -c "import base64; exec(base64.b64decode(open('%TEMP%\\vulnguard_code.b64').read().strip()).decode())" %*

REM Cleanup
if exist "%TEMP%\vulnguard_code.b64" del "%TEMP%\vulnguard_code.b64"
if exist "%TEMP_SCRIPT%" del "%TEMP_SCRIPT%"
